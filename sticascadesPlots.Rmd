---
title: "Australian Chlamydia Cascade"
author: 
  - Richard T. Gray
  
date: Date - `r format(Sys.Date(), format="%B %d %Y")`
output:
  word_document:
    pandoc_args: --output="docs/ChlamydiaCascade.docx"
    reference_docx: docs/mystyles.docx
csl: docs/plos.csl
bibliography: docs/ChlamydiaCascade.bib
---

This document presents estimates for the diagnosis and care cascade for 
*Chlamydia trachomatis* infection in Australia. The methods used for the 
estimates are described at the end of the document.

<!--- Code for calculating the cascade --->
```{r initialization,echo = FALSE,messages = FALSE,include=FALSE}
# Clear workspace
rm(list=ls()) 
options(scipen=999)  # To get rid of scientific notation

# Load libraries used
require(readxl)
require(dplyr)
require(tidyr)

require(ggplot2)
require(RColorBrewer)
require(Hmisc)
require(knitr)

# Set working directory 
setwd(file.path(path.expand("~"),"Research","!Evaluation_Modelling","project_care_cascades"))

# Details of results and outputs folders
basePath <- getwd()
docFolder <- file.path(basePath,"docs")
figFolder <- file.path(basePath,"output","figures")
resultsFolder <- file.path(basePath,"output")

# Current time for appending to outputs
currTime <- format(Sys.time(), "%y-%m-%d") # to append to files

# Script parameters
resultsYear <- 2014 # Year of cascade we will plot      # How long ago do we plot things
saveplots <- FALSE # Save plots as separate files

# Function to format data and range into thousands
source(file.path(basePath, "code", "format.data.R"), echo=TRUE)
```

```{r loadresults, echo = FALSE, messages = FALSE, include=FALSE}
# Load hiv cascade dataframe
notificationsFile <- file.path(basePath, "data", paste("chlamnotifications", 
                                       toString(resultsYear), ".csv", sep = ""))
incidenceFile <- file.path(basePath, "data", paste("chlamincidence", 
                                       toString(resultsYear), ".csv", sep = ""))
treatFile <- file.path(basePath, "data", paste("chlamtreatment", 
                                       toString(resultsYear), ".csv", sep = ""))

notifications <-  read.csv(notificationsFile)
incidence <- read.csv(incidenceFile)
treatment <- read.csv(treatFile)

```

```{r extractResults, echo = FALSE, messages = FALSE, include=FALSE}
# Extract the actual results we want - resultsYear for 15-29 year olds
currentDiags <- notifications %>% 
  filter(year == resultsYear) %>%
  select(-male...15.yrs, -male.30.34.yrs, -male...34.yrs, -male.all, 
         -female...15.yrs, -female.30.34.yrs, -female...34.yrs, -female.all)

# Current incidence
currentInc <- incidence %>% 
  filter(year == resultsYear)

# Current treatment data
currentTreat <- treatment %>%
  select(-notes_sources, -Reference)

```

```{r calculations, echo = FALSE, messages = FALSE, include=FALSE}
# Initialize output data frame
chlamcascade <- data.frame(stage = character(), sex = character(),
             estimate = numeric(), lower = numeric(), 
             upper = numeric())

# New infections
maleInc <- rowMeans(currentInc[, 2:3])
maleIncLower <- currentInc[, 2]
maleIncUpper <- currentInc[, 3]
femaleInc <- rowMeans(currentInc[, 4:5])
femaleIncLower <- currentInc[, 4]
femaleIncUpper <- currentInc[, 5]

chlamcascade <- rbind(chlamcascade, data.frame(stage = "infections",
                  sex = c("male", "female"), estimate = c(maleInc, femaleInc),
                  lower = c(maleIncLower, femaleIncLower), 
                  upper = c(maleIncUpper, femaleIncUpper)))

# Diagnoses
maleDiags <- sum(currentDiags[,2:4])
femaleDiags <- sum(currentDiags[,5:7])
chlamcascade <- rbind(chlamcascade, data.frame(stage = "notifications",
                  sex = c("male", "female"), estimate = c(maleDiags, femaleDiags),
                  lower = NA, 
                  upper = NA))

# Weights for calculations
weightsDF <- filter(currentTreat, stage == "notifications")
weights <- c(weightsDF$urban, weightsDF$regional, weightsDF$remote)

# Proportion treated
treatedDF <- filter(currentTreat, stage == "treated")
propTreated <- colMeans(treatedDF[,3:5], na.rm = TRUE)
propTreated <- sum(propTreated * weights)

# Hard coded ranges based on propTreated value - +/- 10%
propTreatedMin <- 0.9 # propTreated * 0.9
propTreatedMax <- min(1, propTreated * 1.1)

maleTreated <- filter(chlamcascade, stage == "notifications" & sex == "male")$estimate *
  c(propTreated, propTreatedMin, propTreatedMax)
femaleTreated <- filter(chlamcascade, stage == "notifications" & sex == "female")$estimate *
  c(propTreated, propTreatedMin, propTreatedMax)

chlamcascade <- rbind(chlamcascade, data.frame(stage = "treated",
                  sex = c("male", "female"), 
                  estimate = c(maleTreated[1], femaleTreated[1]),
                  lower =  c(maleTreated[2], femaleTreated[2]), 
                  upper = c(maleTreated[3], femaleTreated[3])))

# Retesting
retestDF <- filter(currentTreat, stage == "retested")
diagnosesProp <- filter(currentTreat, stage == "diagnoses")$urban
diagnosesProp[3] <- 1 # Replace for remote 

propReTest <- colSums(retestDF[, 3:5] * diagnosesProp, na.rm = TRUE)
propReTest <- sum(propReTest * weights)

# Hard coded ranges based on propTreated value - +/- 10%
propReTestMin <- 0.2 # propReTest * 0.9
propReTestMax <- 0.3 # min(1, propReTest * 1.1)

maleRetested <- filter(chlamcascade, stage == "notifications" & sex == "male")$estimate *
  c(propReTest, propReTestMin, propReTestMax)
femaleRetested <- filter(chlamcascade, stage == "notifications" & sex == "female")$estimate *
  c(propReTest, propReTestMin, propReTestMax)

chlamcascade <- rbind(chlamcascade, data.frame(stage = "retested",
                  sex = c("male", "female"), 
                  estimate = c(maleRetested[1], femaleRetested[1]),
                  lower =  c(maleRetested[2], femaleRetested[2]), 
                  upper = c(maleRetested[3], femaleRetested[3])))

# Retested positive 
positiveDF <- filter(currentTreat, stage == "positive")
propPositive <- colSums(positiveDF[, 3:5] * diagnosesProp, na.rm = TRUE)
propNegative <- 1- sum(propPositive * weights)

# Hard coded ranges based on propNegative value - +/- 10%
propNegativeMin <- propNegative * 0.9
propNegativeMax <- min(propNegative * 1.1,1)

maleNegative <- filter(chlamcascade, stage == "retested" & sex == "male")$estimate *
  c(propNegative, propNegativeMin, propNegativeMax)
femaleNegative <- filter(chlamcascade, stage == "retested" & sex == "female")$estimate *
  c(propNegative, propNegativeMin, propNegativeMax)

chlamcascade <- rbind(chlamcascade, data.frame(stage = "negative",
                  sex = c("male", "female"), 
                  estimate = c(maleNegative[1], femaleNegative[1]),
                  lower =  c(maleNegative[2], femaleNegative[2]), 
                  upper = c(maleNegative[3], femaleNegative[3])))

```

```{r plotcode, echo=FALSE,messages = FALSE,include=FALSE}
# Default plot specifications
graphics.off()

# Baseline theme for plot variables
plotopts <- theme_bw() + theme(text = element_text(face = "bold",size=12,colour="black"),
  axis.text.x = element_text(face = "plain",size=10,colour="black"),
  axis.text.y = element_text(face = "plain",size=10,colour="black"),
  axis.line = element_line(colour="black"),
  axis.ticks = element_line(colour="black"),
  legend.position = "top",
  legend.background = element_rect(),
  legend.key = element_blank(),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(), 
  panel.background = element_blank(), 
  panel.border = element_rect(colour = "black"),
  axis.line = element_line(colour = "black"),
  plot.title=element_text(size=12, face="bold"),
  strip.background = element_blank()
)

# Setup colours
# Palette with black and grey:
cbPalette <- c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", 
               "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

maincols <- brewer.pal(4,"Set1")

```

```{r barchart, echo = FALSE, messages = FALSE, include=FALSE}
# Create bar chart plot for Chlamydia cascade
stages <- c("New infections", "Notifications", "Received treatment after diagnosis", 
                "Retested within 1-4 months", "Remain uninfected at retest")
stagesNeat <- c("New \n infections", "Notifications", 
                "Received \n treatment \n after \n diagnosis", 
                "Retested \n within \n 1-4 months", "Remain \n uninfected \n at retest")

### Plot the bar chart
plotCascade <- ggplot(data = chlamcascade, aes(x = stage, y = estimate, fill = sex)) + 
  geom_bar(position = "dodge", stat = "identity") + 
  geom_errorbar(aes(ymin = lower, ymax = upper), 
                position = position_dodge(width = 0.9),
                width = 0.2, color = "black", size = 1.2) +
  scale_fill_manual(values = c("red", "blue"), name = "", labels = c("Female", "Male")) + 
  scale_x_discrete(labels = stagesNeat) +
  ylab("Number of people") + xlab("") +  
  plotopts

# Print plot in separate window and save
if (saveplots) {
  windows(width=7,height=5)
  print(plotCascade)
  ggsave(paste(figFolder,"chlamcascade.png"),width=7,height=5)
}

```

<!--- Start of main document --->

# Chlamydia diagnosis and care cascade

**Figure 1** -- The chlamydia diagnosis and care cascade for 15-29 year old 
Australians in `r resultsYear`.

```{r insertplot1, echo = FALSE, messages = FALSE, warning = FALSE, results = "hide", fig.width= 5.5, fig.height = 4}
print(plotCascade)
```

```{r createTable, echo = FALSE, messages = FALSE, include = FALSE}
# Create and insert table 
finalTable <- select(chlamcascade, stage, sex)
finalTable$estimate <- NA

skip <- c(3,4)
for (ii in 1:nrow(finalTable)){
  if (ii %in% skip) {
    finalTable$estimate[ii] <- format.data(chlamcascade$estimate[ii], places = -1)
  } else {
    finalTable$estimate[ii] <- format.data(chlamcascade$estimate[ii], 
                                           chlamcascade$lower[ii], 
                                           chlamcascade$upper[ii], places = -1)
  }
}

# Rename first column
finalTable$stage <- rep(stages, each = 2)

# Rename columns
finalTable <- rename(finalTable, "Cascade stage" = stage, "Sex" = sex, 
                     "Estimate (range)" = estimate)

```

**Table 1** -- Estimates and range for each stage of the chlamydia diagnosis 
and care cascade for 15-29 year old Australians in `r resultsYear`.

```{r inserttable1, echo = FALSE, messages = FALSE, warning = FALSE, results = "asis"}
kable(finalTable, align = c("l", "c", "c"))
```

# Methods and data sources

The following sections describe the methods and data sources used to produce the estimates for each stage of the cascade. 

## Notifications

We obtained the number of chlamydia notifications for 15-29 year old males and females in Australia directly from the National Notifiable Diseases Surveillance System (NNDSS). 

##Estimating new infections

New *Chlamydia trachomatis* infections were estimated using the modelling approach of Ali et al.
[@ali2015new]. This method uses a Bayesian statistical approach to calibrate model parameters to the 
notifications data from NNDSS, the number of tests for *Chlamydia trachomatis* obtained by Medicare 
(item numbers 69316, 69317, and 69319), and annual population estimates for each sex and age group 
published by the Australian Bureau of Statistics (ABS) over 2001-2014. Model outcomes were validated
through comparison against Chlamydia prevalence among 16-29 year olds measured in 2011 by the 
Australian Chlamydia Control Effectiveness Pilot (ACCEPt). 

The Ali et al. model outputs 95% credible intervals for the annual number of incident chlamydia cases in 15-19, 20-24, and 25-29 year old males and females. We summed the incident chlamydia cases for each age group to estimate the number of new infections. The range corresponds to the lower and upper bound  of the credible intervals with the midpoint corresponding to our best estimate. 

## Estimating treatment, retesting, and number remaining uninfected

We estimated chlamydia treatment following diagnosis, retesting after treatment, and the number
negative at retesting using multiple sources describing chlamydia infection and care across urban,
regional, and remote areas and a number of service contexts. 

From the NNDSS notifications data 69%, 25%, and 5% of diagnoses in 15-29 year olds occur across urban,
regional, and remote areas respectively. Based on the Bourne et al. study in 2013, 14% of these
diagnoses occurred in sexual health clinics [@bourne2013proportion]. We divided the remainder of
diagnoses into those made in general practice (81%) and other contexts (5%) using the Sex in Australia data published in 2003 [@grulich2003sex].    

**Treatment following diagnosis** --- Based on data from NSW sexual health clinics almost all people
diagnosed with chlamydia in urban and regional areas were treated (ranging from 99-100% of those
diagnosed) in 2013 [@guy2012impact]. In NSW remote areas the percentage diagnosed is a little lower at 96%
[@guy2012impact]. The Foster et al. study in 2014 produced a lower estimate for remotes areas in the
Northern Territory of 85% [@foster2014regional].
Based on this data we assumed 90% of those diagnoses in remote areas are treated. Taking a weighted
average by multiplying the notifications breakdown across regions by the estimated percentage treated,
we estimate `r 100*round(propTreated,3)`% of people diagnosed with chlamydia were treated in 2014. We
assumed a range from 90% (corresponding to the percentage treated in remote areas) to 100%. Assuming
the same treatment proportion and range for males and females and multiplying by the number of
notifications we estimated the number of 15-29 year old males and females who received treatment after
diagnosis.  

**Retesting after treatment** --- From the Australian Collaboration for Coordinated Enhanced Sentinel Surveillance of STIs and BBVs (ACCESS), 17-22% of 15-29 year olds diagnosed with chlamydia in national urban and regional sexual health clinics were retested for *Chlamydia trachomatis* infection 1-4 months after treatment. In urban and regional general practice the retesting rate is higher ranging from 20 to 29%. For remote areas ACCESS data was unavailable, so we used results from the STRIVE randomised community trial which reported 20% of 15-29 year olds diagnosed with chlamydia retested 1-4 months after treatment. Taking a weighted average by multiplying the notifications breakdown across regions by the diagnoses breakdown across contexts we estimate `r 100*round(propReTest, 3)`% of people diagnosed with chlamydia are retested after treatment. We assumed a range from 20% (corresponding to the percentage retested in remote areas) to 30%. Assuming the same retesting proportion and range for males and females and multiplying by the number of notifications we estimated the number of 15-29 year old males and females who retested for chlamydia after treatment.

**Number remaining uninfected at retesting** --- From ACCESS, 22-23% of 15-29 year olds retested for chlamydia in national urban and regional sexual health clinics test positive for *Chlamydia trachomatis* at their retest. In urban and regional general practice the positivity rate is much lower ranging from 4% to 11%. For remote areas ACCESS data was unavailable, so we used results from the STRIVE study which reported 5% of 15-29 year olds who retested for chlamydia were positive. Taking a weighted average by multiplying the notifications breakdown across regions by the diagnoses breakdown across contexts we estimate `r 100*round(sum(propPositive * weights), 3)`% of people were positive at their retest overall. This means `r 100*round(propNegative, 3)`% of 15-29 year olds remained uninfected at retesting. We assumed a relative range of $\pm$ 10% in the proportion negative at retest. Assuming the same uninfected at retest proportion and range for males and females and multiplying by the number of people who retested within 1-4 months we estimated the number of 15-29 year old males and females who remain uninfected at retest.

# References
