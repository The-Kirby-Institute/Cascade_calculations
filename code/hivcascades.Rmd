---
title: "HIV Cascades Calculations"
author: "Richard T. Gray"
date: Date - `r format(Sys.Date(), format="%B %d %Y")`
output: 
  word_document:
    reference_docx: mystyles.docx
---

This document describes and contains the code for producing the HIV care cascade estimates for Australia. It is written in dynamic format using R markdown v2 within Rstudio (version 0.98.1091 with R version`r substr(R.Version()$version.string,1,15)`) to produce a Word (.docx) document (see <http://rmarkdown.rstudio.com>). All the R code to clean the data and produce the figures and tables is contained in this file but suppressed in the final output document. 

```{r initialization, echo = FALSE, messages = FALSE, include=FALSE}
# Clear workspace
rm(list=ls()) 

# Libraries for data manipulation
require(readxl)
require(dplyr)
require(tidyr)
require(utils)

# Libraries for output
require(ggplot2)    
require(knitr)      
require(gridExtra)  

# Set working directory
setwd(file.path(path.expand("~/"),"Documents","Research","!Evaluation_Modelling","project_care_cascades","code"))

# Base directory
basePath <- "~/Documents/Research/!Evaluation_Modelling/project_care_cascades/"
# cleanDataFolder <- file.path("..","data")

# Primary script parameters
currTime <- format(Sys.time(), "%y-%m-%d") # to append to files
analysisYear <- 2013
startYear <- 1990
# reclean <- FALSE  # Rerun data cleaning if true otherwise load already cleaned file.
pop <- "all"  # Population exposure category
region <- "all" # State for analysis

# TODO: Need to define populations more carefully to match what we want
# E.g. msm = msm + msm-idu + bisexual + ...
```

```{r startAnalysis}
# Load clean file
hivdata <- read.csv(file.path(cleanDataFolder, paste("hivnotifications",toString(analysisYear),".csv", sep ="")))

# Setup overarching analysis                   
years <- startYear:analysisYear # Years to calculate

# Setup extra columns for analysis
hivdata$yeardiagnosis <- as.numeric(substr(hivdata$datediagnosis,1,4))
hivdata$yeardeath <- as.numeric(substr(hivdata$datedeath,1,4))

# Quick checks that we are not doing analysis outside of the data.
if (max(hivdata$yeardiagnosis) < analysisYear) {
  stop("No data for specified for final year of analysis.")
}

if (min(hivdata$yeardiagnosis) > startYear) {
  stop("No data for specified for first year of analysis.")
}

# Subset by population and state
if (pop == "all"){
  hivset <- hivdata
} else {
  hivset <- filter(hivdata, exposure == pop)
}

if (region != "all") {
    hivset <- filter(hivset, state == region)
}
```

Sort out diagnoses ...

```{r diagnoses}
# Setup dataframe for overall results by first extracting diagnoses details

hivresults <- hivset %>% 
  group_by(yeardiagnosis) %>% 
  summarise(notifications = n()) %>% 
  mutate(totalnotifications  = cumsum(notifications)) %>% 
  filter(yeardiagnosis %in% years)
               
```

Removal of duplicates .....

```{r removeduplicates}
# This chuck takes defines a function to calulate the number of unique birthdates 
# in a vector of birthdates. It is used to estimate the number of duplicates or 
# unique diagnoses. 

# Load function to remove duplicates
source('~/Documents/Research/!Evaluation_Modelling/code/removeDuplicates.R', 
       echo=TRUE)

# Setup
ignore <- c(1,15) # Days to ignore in duplicate calculations
filename <- paste(basePath, "output/uniquehiv-",pop,"_",region,"_",
                  toString(tail(years,1)),sep="")

# Set up dob frame
dobframe <- select(hivset,dob,yeardiagnosis)

# Now loop through years and calculate cumulative number of unique cases 
numUniques <- rep(0,length(years))
for (ii in seq(along=years)) {
  dobvector <- filter(dobframe,yeardiagnosis <= years[ii])$dob
  if (years[ii] == analysisYear) {
    numUniques[ii] <- removeDuplicates(dobvector,ignore,write=filename)
  } else {
    numUniques[ii] <- removeDuplicates(dobvector,ignore)
  }
}

# Store number unique diagnoses
hivresults$uniquecases <- numUniques

```

Sort out deaths ....

```{r deaths}
# Now calculate the number of deaths each year to work out the number of people
# diagnosed with HIV 


```

Sort out treatment ....

Sort out treatment .....
