# Script to calculate undiagnosed, YDF and CDR
# ============================================

```{r Set-up}
# Restart R and set working directory to source file location

# Load packages
require(tidyverse, quietly = TRUE)
require(scales, quietly = TRUE)


# Setup directories
basePath <- file.path(dirname(getwd()), "HIV")
outputFolder <- file.path(basePath, "output")

source(file.path(dirname(getwd()), "code", "PlotColors.R"))
source(file.path(dirname(getwd()), "code", "EveryNth.R"))

```

```{r Options}
projectName <- "ASR_2021" #"ASR_2021" 
project <- file.path(basePath, "output", projectName)

cascadeList <- c("All-2020")

# List for YDF paper
# cascadeList <- c("Hetero-2019", "Hetero-female-2019",
#   "Hetero-female-Aus-2019", "Hetero-female-Othercob-2019",
#   "Hetero-female-SEA-2019", "Hetero-female-SSA-2019",
#   "Hetero-male-2019", "Hetero-male-Aus-2019", "Hetero-male-Othercob-2019",
#   "Hetero-male-SEA-2019", "Hetero-male-SSA-2019",
#   "Indigenous-2019", "MSM-2019", "MSM-Othercob-2019", "MSM-SEA-2019",
#   "MSM-SSA-2019", "MSM-nonAus-2019")

# List for IPR paper
# cascadeList <- c("All-2020", "Hetero-2020", "Male-2020", "Female-2020",
#   "MSM-2020", "Pwid-2020",  "SEA-2020", "SCA-2020", 
#   "SSA-2020", "Othercob-2020", "Otherexp-IPR-2020")

# Result files and specifications
resultsYear <- 2020
cascadeFile <- paste0("HIVcascadeEstimates-", resultsYear,".csv")
infectionsFile <- paste0("newInfectionsEstimates-", resultsYear,".csv")
undiagnosedFile <- paste0("plhivEstimates-", resultsYear, ".csv")
diagnosesFile <- paste0("pldhiv-", resultsYear, "-all.csv")

startYear <- 2000

```

```{r extract results function}

IndicatorResults <- function(cascadeName) {
  # Read in associated cascade files and extract key columns
  infections <- read_csv(file.path(project, cascadeName, infectionsFile),
    show_col_types = FALSE)
  undiagnosed <- read_csv(file.path(project, cascadeName, undiagnosedFile),
    col_types = cols(.default = "d")) %>%
    select(year, undiag, undiag_lower, undiag_upper, undiag_percent, uplower,
      upupper) 
  diagnoses <- read_csv(file.path(project, cascadeName, diagnosesFile),
    col_types = cols(.default = "d"), show_col_types = FALSE) %>%
    select(year, diagnoses)
  plhiv <- read_csv(file.path(project, cascadeName, cascadeFile),
    show_col_types = FALSE) %>%
    filter(stage == "infected") %>%
    select(year, value, lower, upper) 
  
  # Tidy up new infections estimates
  infectionsInclude <- filter(infections, exclude == "no")
  infectionsExclude <- filter(infections, exclude == "yes")
  
  infectionsResults <- tibble(year = infectionsInclude$year,
    infections = (infectionsInclude$infections + infectionsExclude$infections)/2,
    infections_lower = infectionsExclude$infections_lower,
    infections_upper = infectionsInclude$infections_upper)
  
  # For PLHIV create start year values by shifting
  plhiv$start_plhiv <- c(plhiv$value[1], plhiv$value[1:(nrow(plhiv)-1)])
  plhiv$start_plhiv_lower <- c(plhiv$lower[1], plhiv$lower[1:(nrow(plhiv)-1)])
  plhiv$start_plhiv_upper <- c(plhiv$upper[1], plhiv$upper[1:(nrow(plhiv)-1)])

  plhiv <- plhiv %>%
    select(year, start_plhiv, start_plhiv_lower, start_plhiv_upper)
  
  # Merge results
  results <- diagnoses %>%
    left_join(undiagnosed, by = "year") %>%
    left_join(infectionsResults, by = "year") %>%
    left_join(plhiv, by = "year")
  
  return(results)
}


# Calculate ydf and cdr
AddResults <- function(results) {
  newResults <- results %>%
    mutate(ydf = diagnoses/(diagnoses + undiag),
      ydf_lower = diagnoses/(diagnoses + undiag_upper),
      ydf_upper = diagnoses/(diagnoses + undiag_lower),
      cdr = diagnoses/infections,
      cdr_lower = diagnoses/infections_upper,
      cdr_upper = diagnoses/infections_lower,
      ipr = infections/start_plhiv,
      ipr_lower = infections_lower/start_plhiv_upper,
      ipr_upper = infections_upper/start_plhiv_lower)
  
  return(newResults)
  
}

```

```{r Extract cascade results and calculate YDF and CDR}

results <- list()
for (cascade in cascadeList) {
  
  tempResults <- IndicatorResults(cascade) %>%
    AddResults() %>%
    filter(year >= startYear) %>%
    replace(is.na(.), 0) %>%
    mutate_all(function(x) ifelse(is.infinite(x), 0, x)) %>%
    mutate_all(function(x) ifelse(is.nan(x), 0, x))
  
  results[[cascade]] <- tempResults  
  
  write_csv(results[[cascade]], file.path(project, cascade, 
    "cascadeIndicators.csv"))
  
}

```

```{r Plotting function}
cols <- unname(PlotColors()[c("Blue", "Red")])

plotUndiag <- function(df, title, ymax, indicator) {
  if (indicator == "infections") {
    # New infections
    plot <- ggplot(df, aes(x = year)) + 
      geom_ribbon(aes(ymin = infections_lower, ymax = infections_upper), 
        fill = cols[1], alpha = 0.2) +
      geom_line(aes(y=infections), colour = cols[1]) +
      labs(y = "New Infections", x = "Year", title = title) +
      scale_y_continuous(limits = c(0, ymax), 
        label = comma)
  } else if (indicator == "percent") {
    # Undiagnosed percentage - Values rescaled to proportions
    plot <- ggplot(df, aes(x = year)) + 
      geom_ribbon(aes(ymin = uplower/100, ymax = upupper/100), 
        fill = cols[1], alpha = 0.2) +
      geom_line(aes(y=undiag_percent/100), colour = cols[1]) +
      labs(y = "Percentage undiagnosed", x = "Year", title = title) +
      scale_y_continuous(limits = c(0, ymax), 
        label = percent)
  } else if (indicator == "ydf") {
    # YDF and CDR plots combined
    plot <- ggplot(df, aes(x = year)) +
      geom_ribbon(aes(ymin = cdr_lower, ymax = cdr_upper), 
        fill = cols[1], alpha = 0.2) +
      geom_line(aes(y=cdr, colour = "cdr")) +
      geom_ribbon(aes(ymin = ydf_lower, ymax = ydf_upper), 
        fill = cols[2], alpha = 0.2) +
      geom_line(aes(y=ydf, colour = "ydf")) +
      labs(y = "Value", x = "Year", title = title) +
      scale_colour_manual("", labels = c("CDR", "YDF"),
        breaks = c("cdr", "ydf"), values = cols) + 
      ylim(0, ymax) +
      theme(legend.position = "right")
    
  } else if (indicator == "ipr") {
    # IPR plot
    plot <- ggplot(df, aes(x = year)) + 
      geom_ribbon(aes(ymin = ipr_lower, ymax = ipr_upper), 
        fill = cols[1], alpha = 0.2) +
      geom_line(aes(y=ipr), colour = cols[1]) +
      labs(y = "Incidence prevalence ratio", x = "Year", title = title) +
      scale_y_continuous(limits = c(0, ymax), 
        label = comma)
  } else {
    stop("Unknown Indicator") 
  }
  
  plot <- plot +
     scale_x_continuous(breaks = 2010:resultsYear,
    labels =  EveryNth(2010:resultsYear, 2, inverse = TRUE),
    limits = c(2010, resultsYear)) +
    PlotOptions() 
  
  return(plot)
}

```

```{r Produce and save all the plots}

plots <- list()
for (cascade in cascadeList) {
  
  print(cascade)
  
  # New infections
  tempPlot1 <- plotUndiag(results[[cascade]], cascade, 
    ceiling(max(results[[cascade]]$infections_upper)), "infections")
  
  # % Undiagnosed
  tempPlot2 <- plotUndiag(results[[cascade]], cascade, 
    ceiling(max(results[[cascade]]$upupper))/100, "percent")
  
  # YDF and CDR
  tempPlot3 <- plotUndiag(results[[cascade]], cascade, 
    ceiling(max(results[[cascade]]$cdr_upper)), "ydf")
  
  tempPlot4 <- plotUndiag(results[[cascade]], cascade, 
    max(results[[cascade]]$ipr_upper), "ipr")
  
  
  ggsave(file.path(project, cascade, "new_infections.png"), tempPlot1, 
    width = 8, height = 6, units = "cm")
  ggsave(file.path(project, cascade, "percent_undiagnosed.png"), tempPlot2, 
    width = 8, height = 6)
  ggsave(file.path(project, cascade, "ydf.png"), tempPlot3, 
    width = 8, height = 6)
  ggsave(file.path(project, cascade, "ipr.png"), tempPlot4, 
    width = 8, height = 6)
  
}

```


