---
title: "PldhivCalculations"
author: Neil Bretana and Richard T. Gray
output: html_notebook
---

This is a draft [R Markdown](http://rmarkdown.rstudio.com) Notebook for 
calculating the number of people living with diagnosed HIV in Australia.
This is one of the key steps for producing the estimates of the Australian
HIV diagnosis and care cascade. 

This notebook is currently in draft form for updating the HIV cascade 
calculation scripts to version 3.0.

```{r Initialization}
# Chunk to setup everything
# Clear workspace
rm(list=ls()) 

# Setup directories
basePath <- file.path(dirname(getwd()), "HIV")

Rcode <- file.path(dirname(getwd()), "code") 
HIVcode <- file.path(basePath, "code") 
dataFolder <- file.path(basePath, "data")
outputFolder <- file.path(basePath, "output")
figuresFolder <- file.path(basePath, "output","figures")

# Set working directory
#setwd(basePath)

# Load standard libraries and options ----------------------------------
source(file.path(Rcode, "LoadLibrary.R"), echo=TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo=TRUE)
source(file.path(Rcode, "PlotOptions.R"), echo=TRUE)

# Primary script parameters
# currTime <- format(Sys.time(), "%y-%m-%d") # to append to files
```

```{r Script parameters}
# Chunk to enter all the script parameters we will use
analysisYear <- 2016
saveResults <- FALSE 

# Set HIV subsetting function parameters----------------------------------

cascadeName <- paste0("all-", toString(analysisYear)) 
targetGender <- 'all' #M or F, Null both, add code for including/excluding NA's or missings 
targetAge <- 'all' #groups 0, 1, 2, 3, 4...
targetCob <- 'all' # all=including n/a, Thailand, etc.
targetExposure <- 'all'
targetAtsi <- 'all' # 0 or 1 # Only used if country is Australia
targetState <- 'all' # nsw, sa, nt, qld, vic, wa, act, tas 
targetLocalRegion <- 'all' #tbd
targetGlobalRegion <- 'Other cob' #South-east Asia, Oceania, South American, etc

doAge <- FALSE

excludeAborig <- FALSE
ecdcData <- FALSE
ecdcVersion <- '1.2.2'
excludeOS <- FALSE

ecdcModel <- cascadeName # name
if (excludeOS) {
  # If excludeOS don't save the pldhiv estimates as we ate only using this
  # for ECDC calculations
  saveResults <- FALSE
}

interState <-ifelse(targetState != "all", TRUE, FALSE)

hivParams <- data.frame(cascadeName, targetGender, targetAge, targetCob,
                        targetExposure, targetAtsi, targetState,
                        targetLocalRegion, targetGlobalRegion, excludeAborig,
                        ecdcData, ecdcVersion, excludeOS, interState)

```

```{r Functions}
# Load functions used for analysis 

# Load function to calculate number living with diagnosed HIV
source(file.path(Rcode,"LivingDiagnosed.R"), echo=TRUE)

# Source functions for filling in missing data
source(file.path(Rcode, "FillMissing.R"), echo=TRUE)
source(file.path(Rcode, "FillDataFrame.R"), echo=TRUE)

# Function to easily extract sub-populations of interest 
source(file.path(Rcode, "Subset.R"), echo=TRUE)

# Function for removing duplicates annually
source(file.path(HIVcode, "DeduplicationFunctions.R"), echo=TRUE)

# Function to replace estimates
source(file.path(Rcode, "ReplaceEstimates.R"), echo=TRUE)

# Function to tidy notifications
source(file.path(HIVcode, "TidyNotifications.R"), echo=TRUE)

# Functions to output ECDC model data
source(file.path(HIVcode, "EcdcCalculations.R"), echo=TRUE)
source(file.path(HIVcode, "EcdcFiles.R"), echo=TRUE)

# Function for adjustments
source(file.path(HIVcode, "GetAdjustments.R"), echo=TRUE)

```

```{r Clean notifications}
# This chunk loads the national notifications and subsets based on the
# specified criteria in Script paramaters

# Load cleaned notifications data
origHivData <- read.csv(file.path(dataFolder, paste0("hivnotifications",
                    toString(analysisYear), ".csv"))) 

# Read in country code data
countryCodes <- read.csv(file.path(dataFolder, "countryRegionCodes.csv"))

# Tidy up notifications for calculations
hivData <- TidyNotifications(origHivData, analysisYear, countryCodes)

# Data checks-------------------------------------------------------------

# Quick check that we are not doing analysis outside of the data
if (max(hivData$yeardiagnosis) < analysisYear) {
  stop("No data specified for final year of analysis.")
}

# HIV data variables------------------------------------------------------

# Setup variables for overarching analysis                  
allYears <- min(hivData$yeardiagnosis):analysisYear # all years of data

```

```{r Subset notifications}
# Create subsetted notifications dataframe. May have to do this multiple
# times to get the extact number of specific category and those excluded
# for inter-regional movement. E.g. MSM only in NSW as excluded will have
# non-MSM and non-NSW

if (excludeOS) {
  hivData <- filter(hivData, is.na(previ_diag_overseas))
}

hivSetAll <- filter(hivData, yeardiagnosis <= analysisYear)
annDiagsOrig <- hivSetAll %>% 
  group_by(yeardiagnosis) %>%
  summarise(notifications = n()) %>%
  mutate(totalnotifications = cumsum(notifications)) %>%
  ungroup() 

# Possibly temporary as this may be generated elsewhere
overallPropUnique <- ProportionUnique(hivSetAll,
                                      annDiagsOrig$totalnotifications,
                                      allYears)
annPropUnique <- AnnualUnique(annDiagsOrig$notifications,
                              overallPropUnique) /
  annDiagsOrig$notifications

if (excludeAborig) {
  # Set indigenous aside separately to add on later if required
  hivSetIndigenous <- filter(hivSetAll, aboriggroup == 'indigenous')
  hivSetAll <- filter(hivSetAll, aboriggroup == 'non-indigenous')
}
  
hivSetReturn <- subhivset(hivSetAll, targetAge, targetGender,
                          targetExposure, targetCob, targetAtsi,
                          targetState, targetGlobalRegion)

hivSet <- hivSetReturn[[1]]
hivSetExcluded <- hivSetReturn[[2]]
hivSetUnknown <- hivSetReturn[[3]]

```

```{r Annual notifications and proportions}
# This chunk creates a dataframe of the annual notifications for the
# specified criteria.

includeDiags <- hivSet %>% 
  group_by(yeardiagnosis) %>%
  summarise(included = n()) %>%
  ungroup() %>%
  rename(year = yeardiagnosis)
includeDiags <- FillDataFrame(allYears, includeDiags)


# If excluded and unknown is empty replace with zeros
if (length(hivSetExcluded) == 0) {
  excludedDiags <- data_frame(year = allYears,
                            excluded = 0)
} else {
  excludedDiags <- hivSetExcluded %>%
    group_by(yeardiagnosis) %>% 
    summarise(excluded = n()) %>%
    rename(year = yeardiagnosis)
  
}
excludedDiags <- FillDataFrame(allYears, excludedDiags)

if (length(hivSetUnknown) == 0) {
 unknownDiags <- data_frame(year = allYears,
                            unknown = 0)
} else {
unknownDiags <- hivSetUnknown %>%
  group_by(yeardiagnosis) %>% 
  summarise(unknown = n()) %>%
  rename(year = yeardiagnosis)
}
unknownDiags <- FillDataFrame(allYears, unknownDiags)

# Adjust included and excluded annual diagnoses propotionally to replace
# unknwons
adjustDiags <- includeDiags %>% 
  left_join(excludedDiags, by = "year") %>%
  left_join(unknownDiags, by = "year") %>%
  mutate(all = included + excluded + unknown) %>%
  mutate(included = ifelse(is.na(included), 0, included),
         excluded = ifelse(is.na(excluded), 0, excluded),
         unknown = ifelse(is.na(unknown), 0, unknown)) %>%
  mutate(prop_included = included / (included + excluded),
         prop_excluded = excluded / (included + excluded)) %>%
  mutate(prop_included = ifelse(is.nan(prop_included), 0, prop_included), 
         prop_excluded = ifelse(is.nan(prop_excluded), 0, 
                                prop_excluded)) %>%
  mutate(adjusted_included = included  + unknown * prop_included,
         adjusted_excluded = excluded + unknown * prop_excluded)

hivResults <- data_frame(year = adjustDiags$year,
                         notifications = adjustDiags$adjusted_included,
                         cumnotifications =
                           cumsum(adjustDiags$adjusted_included))

# Proportion in each age group--------------------------------------------
# For the known diagnoses calculate proportion by age bin, exposure group,
# cd4 count category and diagnosis type. This will be used to distribute 
# annual notifications for aging PLDHIV.  
if (doAge) {
  agedDiags <- hivSet %>%
    group_by(yeardiagnosis, agebin) %>%
    summarise(diags = n()) %>%
    ungroup() %>%
    spread(agebin, diags) 
  
  #fill missing years
  fillYears <- includeDiags$year[!(includeDiags$year %in% agedDiags$yeardiagnosis)]
  fillDiags <- agedDiags[0,]
  fillDiags[1:length(fillYears),] <- NA
  fillDiags$yeardiagnosis <- fillYears
  agedDiags <- rbind(agedDiags, fillDiags)
  agedDiags <- agedDiags[order(agedDiags$yeardiagnosis),]



  if("not_reported" %in% names(hivSet)){  
    agedDiags <- agedDiags %>% select(-yeardiagnosis, -not_reported)
  }else{
    agedDiags <- agedDiags %>% select(-yeardiagnosis)
  }
  
  agedDiags[is.na(agedDiags)] <- 0
  propAge <- t(apply(agedDiags, 1, 
                     function(row) row/sum(row)))
  agedSubset <- bind_cols(includeDiags, agedDiags)
  
  agedSubsetProp <- bind_cols(includeDiags, as.data.frame(propAge))

}

```

```{r ECDC Outputs}
# ECDC calculations-------------------------------------------------------
if (ecdcData) {
  if (excludeOS) {
  # excluding OS diagnosis
    dataAll <- EcdcFolders(outputFolder, ecdcModel, 
                                  includeOS = FALSE)
    EcdcFiles(hivSet, dataAll, propUnique = overallPropUnique)
  } else {
    # including OS diagnosis
    dataAll <- EcdcFolders(outputFolder, ecdcModel)
    EcdcFiles(hivSet, dataAll, propUnique = overallPropUnique) 
  }

  # Create output directory
  resultsEcdcPath <- file.path(outputFolder, "ECDC_models", cascadeName)
    
  #save parameters 
  saveStringParams <- file.path(resultsEcdcPath, "Parameters")
    
  # Write to csv
  write_csv(hivParams, paste0(saveStringParams, ".csv"))
    
}

```

```{r Load base and adjustment estimates}
# This loads the adjustment files for adjusting the death rates and
# migration rates  
hivBase <- read.csv(file.path(dataFolder, paste0("HIVbaseEstimates-",
                    toString(analysisYear), ".csv")))
hivAdjustments <- read.csv(file.path(dataFolder,
                    paste0("HIVadjustments-",
                    toString(analysisYear), ".csv")))
hivInterstate <- read.csv(file.path(dataFolder,
                              paste0("HIVinterstateEstimates-",
                    toString(analysisYear), ".csv")))

# WHERE I AM UP TO
# Now get the death rates, migration rates, and proportion stay rates
subsetRates <- GetAdjustments(hivBase, hivAdjustments, hivInterstate, 
                              targetAge, targetGender,
                              targetExposure, targetCob,
                              targetAtsi, targetLocalRegion,
                              targetState, targetGlobalRegion) 
if (interState) {
  subsetRatesAll <- GetAdjustments(hivBase, hivAdjustments, hivInterstate,
                                   targetAge, targetGender,
                                   targetExposure, targetCob,
                                   targetAtsi, targetLocalRegion,
                                   "all", targetGlobalRegion)  
}
```

```{r Calculate PLDHIV}
# This chunk fianlly calculates the number of people living with diagnosed
# HIV



if (interState) {
  # Calculate for interregional migration
  pldhivOverall <- LivingDiagnosed(adjustDiags$all,
                                   annPropUnique, 
                                   subsetRatesAll$deathrate,
                                   subsetRatesAll$mrate,
                                   subsetRatesAll$propstay) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivOverallMin <- LivingDiagnosed(adjustDiags$included,
                                  annPropUnique, 
                                  subsetRatesAll$deathrate_upper,
                                  subsetRatesAll$mrate_upper,
                                  subsetRatesAll$propstay_lower) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivOverallMax <- LivingDiagnosed(adjustDiags$included,
                                  annPropUnique, 
                                  subsetRatesAll$deathrate_lower,
                                  subsetRatesAll$mrate_lower,
                                  subsetRatesAll$propstay_upper) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  
  
  
  # Now do regional migration
  pldhivAll <- LivingDiagnosed(adjustDiags$included,
                               annPropUnique, 
                               subsetRates$deathrate,
                               subsetRates$mrate,
                               subsetRates$propstay, 
                               arrivals = subsetRates$inter_arriverate,
                               departs = subsetRates$inter_departrate,
                               pldhiv = pldhivOverall$pldhiv) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  # Use best estimate overall for min and max
  pldhivAllMin <- LivingDiagnosed(adjustDiags$included,
                                  annPropUnique, 
                                  subsetRates$deathrate_upper,
                                  subsetRates$mrate_upper,
                                  subsetRates$propstay_lower,
                                  arrivals = subsetRates$inter_arriverate,
                                  departs = subsetRates$inter_departrate,
                                  pldhiv = pldhivOverall$pldhiv) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivAllMax <- LivingDiagnosed(adjustDiags$included,
                                  annPropUnique, 
                                  subsetRates$deathrate_lower,
                                  subsetRates$mrate_lower,
                                  subsetRates$propstay_upper,
                                  arrivals = subsetRates$inter_arriverate,
                                  departs = subsetRates$inter_departrate,
                                  pldhiv = pldhivOverall$pldhiv) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  

} else {
  
  # Now do regional migration
  pldhivAll <- LivingDiagnosed(adjustDiags$included,
                               annPropUnique, 
                               subsetRates$deathrate,
                               subsetRates$mrate,
                               subsetRates$propstay) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivAllMin <- LivingDiagnosed(adjustDiags$included,
                                  annPropUnique, 
                                  subsetRates$deathrate_upper,
                                  subsetRates$mrate_upper,
                                  subsetRates$propstay_lower) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivAllMax <- LivingDiagnosed(adjustDiags$included,
                                  annPropUnique, 
                                  subsetRates$deathrate_lower,
                                  subsetRates$mrate_lower,
                                  subsetRates$propstay_upper) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
}

# Save deaths and emigrants into ECDC
if (ecdcData) {
  # All deaths
  deaths <- pldhivAll %>%
    select(year, deaths) %>%
    rename(all = deaths)
  EcdcWrite(deaths, dataAll[[1]], "deaths")
  
  # All emigrants
  if (interState) {
    emigrants <- pldhivAll %>% 
      select(year, emigrants, diag_departs, inter_departs,
             inter_arrivals) %>%
      mutate(total = emigrants + diag_departs + inter_departs -
               inter_arrivals) %>%
      select(year, total) %>%
      rename(all = total)
  } else {
    emigrants <- pldhivAll %>% 
      select(year, emigrants, diag_departs) %>%
      mutate(total = emigrants + diag_departs) %>%
      select(year, total) %>%
      rename(all = total)
  }
  
  EcdcWrite(emigrants, dataAll[[1]], "emigrants")
  
  hivExpCum <- hivSet %>% 
    filter(is.na(previ_diag_overseas)) %>%
    group_by(expgroup, yeardiagnosis) %>% 
    summarise(notifications = n()) %>% 
    ungroup() %>% 
    group_by(expgroup) %>% 
    mutate(cumnotifications = cumsum(notifications)) %>%
    ungroup() %>% 
    select(-notifications) %>%
    spread(expgroup, cumnotifications) 
  
  if (!("hetero" %in% names(hivExpCum))) hivExpCum$hetero <- 0
  if (!("msm" %in% names(hivExpCum))) hivExpCum$msm <- 0
  if (!("otherexp" %in% names(hivExpCum))) hivExpCum$otherexp <- 0
  if (!("pwid" %in% names(hivExpCum))) hivExpCum$pwid <- 0
  if (!("unknown" %in% names(hivExpCum))) hivExpCum$unknown <- 0
  
  hivExpCum <- hivExpCum %>% select(-unknown) %>%
    gather("expgroup", "cumnotifications", 2:5) %>%
    mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
                                     cumnotifications)) %>%
    group_by(yeardiagnosis) %>% 
    mutate(propnotifications = cumnotifications /
             sum(cumnotifications)) %>%
    mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
                                      propnotifications)) %>%
    select(-cumnotifications) %>%
    ungroup() %>% 
    spread(expgroup, propnotifications) %>%
    rename(year = yeardiagnosis) 
  hivExpCum$msm[2] <- 1.0
  
  expDeaths <- hivExpCum
  expDeaths[, 2:5] <- expDeaths[, 2:5] * 
    matrix(rep(pldhivAll$deaths, 4), ncol = 4)
  
  EcdcWrite(expDeaths, dataAll[[2]], "deaths")
  
  expEmig <- hivExpCum
  expEmig[, 2:5] <- expEmig[, 2:5] * 
    matrix(rep(emigrants$all, 4), ncol = 4)
  
  EcdcWrite(expEmig, dataAll[[2]], "emigrants")
}

# Store results
hivDiagnosed <- data.frame(stage = "pldhiv",
                           year = allYears,
                           population = "all",
                           value = pldhivAll$pldhiv,
                           lower = pldhivAllMin$pldhiv,
                           upper = pldhivAllMax$pldhiv)

if (saveResults) {
  # Create output directory
  resultsPath <- file.path(outputFolder, cascadeName)
  dir.create(resultsPath, showWarnings = FALSE, recursive = TRUE)
  
  # Save
  saveStringPldhiv <- file.path(resultsPath, 
    paste0("HIVpldhivEstimates-", toString(analysisYear)))
  
  # Write to csv
  write_csv(hivDiagnosed, paste0(saveStringPldhiv, ".csv"))
  
  #save parameters 
  saveStringParams <- file.path(resultsPath, "Parameters")
  
  # Write to csv
  write_csv(hivParams, paste0(saveStringParams, ".csv"))
}

```


