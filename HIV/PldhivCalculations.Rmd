---
title: "PldhivCalculations"
output: html_notebook
author: Neil Bretana and Richard T. Gray
---

This is a draft [R Markdown](http://rmarkdown.rstudio.com) Notebook for 
calculating the number of people living with HIV in Australia. This is one
of the key steps for producing the estimates of the Australian HIV
diagnosis and care cascade. 

This notebook is currently in draft form for updating the HIV cascade 
calculation scripts to version 3.0.

```{r Initialization}
# Chunk to setup everything
# Clear workspace
rm(list=ls()) 

# Setup directories
basePath <- file.path(dirname(getwd()), "HIV")

Rcode <- file.path(dirname(getwd()), "code") 
HIVcode <- file.path(basePath, "code") 
dataFolder <- file.path(basePath, "data")
outputFolder <- file.path(basePath, "output")
figuresFolder <- file.path(basePath, "output","figures")

# Set working directory
#setwd(basePath)

# Load standard libraries and options ----------------------------------
source(file.path(Rcode, "LoadLibrary.R"), echo=TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo=TRUE)
source(file.path(Rcode, "PlotOptions.R"), echo=TRUE)

# Primary script parameters
# currTime <- format(Sys.time(), "%y-%m-%d") # to append to files
```

```{r Script parameters}
# Chunk to enter all the script parameters we will use
analysisYear <- 2015

# plots <- FALSE       # TRUE if we want to plot things
# bindCascade <- TRUE  # TRUE if we want to store all the cascade results 
#                      # one data frame
# 
# saveCascade <- TRUE       # save final cascade dataframe
# saveNotifications <- TRUE # save cleaned notifications set
# saveResults <- TRUE     # save information national annual notifications
# savePldhiv <- TRUE        # save PLDHIV estimates separately

# Set HIV subsetting function parameters----------------------------------

targetGender <- 'all' #M or F, Null both, add code for including/excluding NA's or missings 
targetAge <- 'all' #groups 0, 1, 2, 3, 4...
targetCob <- 'all' # all=including n/a, Thailand, etc.
targetExposure <- 'all'
targetAtsi <- 'all' # 0 or 1 # Only used if country is Australia
targetState <- 'all' # NSW, VIC, etc
targetLocalRegion <- 'all' #tbd
targetGlobalRegion <- 'all' #South-east Asia, Oceania, South American, etc

excludeAborig <- FALSE
ecdcData <- TRUE
ecdcModel <- "all" # name

```

```{r Functions}
# Load functions used for analysis 

# Load function to calculate number living with diagnosed HIV
source(file.path(Rcode,"LivingDiagnosed.R"), echo=TRUE)

# Source functions for filling in missing data
source(file.path(Rcode, "FillMissing.R"), echo=TRUE)
source(file.path(Rcode, "FillDataFrame.R"), echo=TRUE)

# Function to easily extract sub-populations of interest 
source(file.path(Rcode, "Subset.R"), echo=TRUE)

# Function for removing duplicates annually
source(file.path(HIVcode, "DeduplicationFunctions.R"), echo=TRUE)

# Function to replace estimates
source(file.path(Rcode, "ReplaceEstimates.R"), echo=TRUE)

# Function to tidy notifications
source(file.path(HIVcode, "TidyNotifications.R"), echo=TRUE)

# Functions to output ECDC model data
source(file.path(HIVcode, "EcdcCalculations.R"), echo=TRUE)
source(file.path(HIVcode, "EcdcFiles.R"), echo=TRUE)

# Function for adjustments
source(file.path(HIVcode, "GetAdjustments.R"), echo=TRUE)

```

```{r Clean notifications}
# This chunk loads the national notifications and subsets based on the
# specified criteria in Script paramaters

# Load cleaned notifications data
origHivData <- read.csv(file.path(dataFolder, paste0("hivnotifications",
                    toString(analysisYear), ".csv"))) 

# Read in country code data
countryCodes <- read.csv(file.path(dataFolder, "countryRegionCodes.csv"))

# Tidy up notifications for calculations
hivData <- TidyNotifications(origHivData, analysisYear, countryCodes)

# Data checks-------------------------------------------------------------

# Quick check that we are not doing analysis outside of the data
if (max(hivData$yeardiagnosis) < analysisYear) {
  stop("No data specified for final year of analysis.")
}

# HIV data variables------------------------------------------------------

# Setup variables for overarching analysis                  
allYears <- min(hivData$yeardiagnosis):analysisYear # all years of data

```

```{r Subset notifications}
# Create subsetted notifications dataframe. May have to do this multiple
# times to get the extact number of specific category and those excluded
# for inter-regional movement. E.g. MSM only in NSW as excluded will have
# non-MSM and non-NSW

hivSetAll <- filter(hivData, yeardiagnosis <= analysisYear)
annDiagsOrig <- hivSetAll %>% 
  group_by(yeardiagnosis) %>%
  summarise(notifications = n()) %>%
  mutate(totalnotifications = cumsum(notifications)) %>%
  ungroup() 

# Possibly temporary as this may be generated elsewhere
overallPropUnique <- ProportionUnique(hivSetAll,
                                      annDiagsOrig$totalnotifications,
                                      allYears)

if (excludeAborig) {
  # Set indigenous aside separately to add on later if required
  hivSetIndigenous <- filter(hivSetAll, aboriggroup == 'indigenous')
  hivSetAll <- filter(hivSetAll, aboriggroup == 'non-indigenous')
}
  
hivSetReturn <- subhivset(hivSetAll, targetAge, targetGender, targetExposure, targetCob, targetAtsi, targetState, targetGlobalRegion)

hivSet <- hivSetReturn[[1]]
hivSetExcluded <- hivSetReturn[[2]]
hivSetUnknown <- hivSetReturn[[3]]

```

```{r Annual notifications and proportions}
# This chunk creates a dataframe of the annual notifications for the
# specified criteria.

includeDiags <- hivSet %>% 
  group_by(yeardiagnosis) %>%
  summarise(included = n()) %>%
  ungroup() %>%
  rename(year = yeardiagnosis)
includeDiags <- FillDataFrame(allYears, includeDiags)


# If excluded and unknown is empty replace with zeros
if (length(hivSetExcluded) == 0) {
  excludedDiags <- data_frame(year = allYears,
                            excluded = 0)
} else {
  excludedDiags <- hivSetExcluded %>%
    group_by(yeardiagnosis) %>% 
    summarise(excluded = n()) %>%
    rename(year = yeardiagnosis)
  
}
excludedDiags <- FillDataFrame(allYears, excludedDiags)

if (length(hivSetUnknown) == 0) {
 unknownDiags <- data_frame(year = allYears,
                            unknown = 0)
} else {
unknownDiags <- hivSetUnknown %>%
  group_by(yeardiagnosis) %>% 
  summarise(unknown = n()) %>%
  rename(year = yeardiagnosis)
}
unknownDiags <- FillDataFrame(allYears, unknownDiags)

# Adjust included and excluded annual diagnoses propotionally to replace
# unknwons
adjustDiags <- includeDiags %>% 
  left_join(excludedDiags, by = "year") %>%
  left_join(unknownDiags, by = "year") %>%
  mutate(all = included + excluded + unknown) %>%
  mutate(included = ifelse(is.na(included), 0, included),
         excluded = ifelse(is.na(excluded), 0, excluded),
         unknown = ifelse(is.na(unknown), 0, unknown)) %>%
  mutate(prop_included = included / (included + excluded),
         prop_excluded = excluded / (included + excluded)) %>%
  mutate(prop_included = ifelse(is.nan(prop_included), 0, prop_included), 
         prop_excluded = ifelse(is.nan(prop_excluded), 0, 
                                prop_excluded)) %>%
  mutate(adjusted_included = included  + unknown * prop_included,
         adjusted_excluded = excluded + unknown * prop_excluded)

hivResults <- data_frame(year = adjustDiags$year,
                         notifications = adjustDiags$adjusted_included,
                         cumnotifications =
                           cumsum(adjustDiags$adjusted_included))

# Proportion in each age group--------------------------------------------
# For the known diagnoses calculate proportion by age bin, exposure group,
# cd4 count category and diagnosis type. This will be used to distribute 
# annual notifications for aging PLDHIV.  

agedDiags <- hivSet %>%
  group_by(yeardiagnosis, agebin) %>%
  summarise(diags = n()) %>%
  ungroup() %>%
  spread(agebin, diags) %>%
  select(-yeardiagnosis, -not_reported) 
agedDiags[is.na(agedDiags)] <- 0
propAge <- t(apply(agedDiags, 1, 
                 function(row) row/sum(row)))
agedSubset <- bind_cols(includeDiags, agedDiags)
agedSubsetProp <- bind_cols(includeDiags, as.data.frame(propAge))

```

```{r ECDC Outputs}
# ECDC calculations-------------------------------------------------------
if (ecdcData) {
  
  dataAll <- EcdcFolders(outputFolder, ecdcModel)
  dataAllExclude <- EcdcFolders(outputFolder, ecdcModel, 
                                includeOS = FALSE)
  
  EcdcFiles(hivSet, dataAll) # including OS diagnosis
  EcdcFiles(filter(hivSet, is.na(previ_diag_overseas)), 
            dataAllExclude) # excluding OS diagnosis
}

```

```{r Load base and adjustment estimates}
# This loads the adjustment files for adjusting the death rates and
# migration rates  
hivBase <- read.csv(file.path(dataFolder, paste0("HIVbaseEstimates-",
                    toString(analysisYear), ".csv")))
hivAdjustments <- read.csv(file.path(dataFolder,
                    paste0("HIVadjustments-",
                    toString(analysisYear), ".csv")))
hivInterstate <- read.csv(file.path(dataFolder,
                              paste0("HIVinterstateEstimates-",
                    toString(analysisYear), ".csv")))

# WHERE I AM UP TO
# Now get the death rates, migration rates, and proportion stay rates
subsetRates <- GetAdjustments(hivBase, hivAdjustments, targetAge, 
                              targetExposure, targetCob, targetAtsi,
                              targetLocalRegion, targetGlobalRegion) 
 
```

```{r Calculate PLDHIV}
# This chunk fianlly calculates the number of people living with diagnosed
#  HIV

# numInitialPostDiagMigrants <- cumDiagnoses * propLeave

# Initialize final results data frame
# hivDiagnosed <- data.frame(stage = character(), 
#                            year = double(),
#                            population = character(),
#                            estimate = double(),
#                            lower = double(),
#                            upper = double())

# First calculate overall number -----------------------------------------

# Setup all our vectors - first by filling in missing cumulative diagnoses
# filledDiagnoses <- FillMissing(allYears, hivResults$yeardiagnosis, 
#                                  hivResults$uniquecases)

# cumDiagnoses <- filledDiagnoses$value
# cumDiagnoses <- hivResults$uniquecases

# All death rates used for all  populations
# deathRate <- oldResults$deathrate
# deathRateMin <- oldResults$drlower
# deathRateMax <- oldResults$drupper
# numDeaths <- cumDiagnoses * (nonAborigMortalityFactor * deathRate)

# National migration rates
# migrationRate <- filter(hivMigrate, state == "all")$rate
# migrationRateMin <- filter(hivMigrate, state == "all")$lower
# migrationRateMax <- filter(hivMigrate, state == "all")$upper

# migrationRate <- oldResults$osrate
# migrationRateMin <- oldResults$oslower
# migrationRateMax <- oldResults$osupper
# numMigrants <- cumDiagnoses * (nonAborigMigrationFactor * migrationRate)

# Calculate number living with diagnosed HIV and range

annPropUnique <- AnnualUnique(adjustDiags$included,
                              overallPropUnique) / adjustDiags$included

pldhivAll <- LivingDiagnosed(adjustDiags$included,
                             annPropUnique, 
                             subsetRates$deathrate,
                             subsetRates$mrate,
                             subsetRates$propstay)

# IF ECDC WE NEED TO SAVE DEATHS and EMIGRATION


# Use max rates for min estimate because they are removal rates 
# and vice versa
pldhivAllMin <- LivingDiagnosed((1 - nonAborigMigrationFactor * 
                                   (1-propStayLower)) *cumDiagnoses,
                                nonAborigMortalityFactor * deathRateMax,
                                nonAborigMigrationFactor * migrationRateMax)

pldhivAllMax <- LivingDiagnosed((1 - nonAborigMigrationFactor * 
                                   (1-propStayUpper)) *cumDiagnoses,
                                nonAborigMortalityFactor * deathRateMin,
                                nonAborigMigrationFactor * migrationRateMin)
# 
# # Store results
 nyears <- length(allYears)
 hivDiagnosed <- rbind(hivDiagnosed, 
                       data_frame(stage = "pldhiv", 
                             year = allYears, 
                             population = "all", 
                             value = pldhivAll))
#                             lower = pldhivAllMin,
#                             upper = pldhivAllMax))
 cascadeInformation <- cbind(allYears, numDeaths, numMigrants, numInitialPostDiagMigrants, propunique = oldResults$propunique)

# 
# # Replace values with hard coded if necessary
# if (replaceValues) {
#   tempHardCode <- filter(hardCodeValues, stage == "pldhiv")
#   if (nrow(tempHardCode) > 0) {
#     hivCascade <- replaceEstimates(hivCascade, tempHardCode)
#   }
# }

```


