HIV Cascade - Impact of treatment
=================================

Richard T. Gray

This document describes and contains the code for analysising the impact of
ART on HIV incidence in Australia over 2005-2014. It is written in dynamic 
format using R markdown v2 within Rstudio (version 0.98.1091 with R version
`r substr(R.Version()$version.string,1,15)`) to produce a Word (.docx) 
document (see <http://rmarkdown.rstudio.com>). All the R code to produce 
the figures and tables is contained in this file but suppressed in the 
final output document. 

```{r initialization}
## Clear workspace
rm(list=ls()) 

# Setup directories
basePath <- getwd() #dirname(getwd()) 
dataFolder <- file.path(basePath, "data")
resultsFolder <- file.path(basePath,"output") 
figuresFolder <- file.path(basePath, "output","figures")

resultsYear <- 2014

# Set working directory
#setwd(basePath)

# Load standard libraries and options ----------------------------------
source(file.path(Rcode, "LoadLibrary.R"), echo=TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo=TRUE)
source(file.path(Rcode, "PlotOptions.R"), echo=TRUE)

# Load useful functions ------------------------------------------------
source(file.path(Rcode, "TidyLongitudinal.R"), echo=TRUE)
source(file.path(Rcode, "FindBeta.R"), echo=TRUE)

```

## Load national HIV Cascade results

```{r loadresults}
# Load hiv cascde dataframe and extract the data we want
load(file.path(resultsFolder, "HIVcascadeEstimates-2014.rda"))

# Extract national PLHIV range for 2005-2014
plhivLower <- filter(hivCascade, year >= 2005,
                     population == "all", 
                     stage == "infected")$lower

plhivUpper <- filter(hivCascade, year >= 2005,
                     population == "all", 
                     stage == "infected")$upper

# Extract national suppressed range for 2005-2014
suppressedLower <- filter(hivCascade, year >= 2005,
                          population == "all",
                          stage == "suppressed")$lower

suppressedUpper <- filter(hivCascade, year >= 2005, 
                          population == "all", 
                          stage == "suppressed")$upper

```

```{r baselinepop}
# Setup a baselin PLHIV using estimated max death rate over 2005-2014

# Load fixed plhiv results
load(file.path(resultsFolder, paste("plhivFixedDr-",
                    toString(resultsYear), ".rda", sep = "")))

# Calculate relative size of plhiv if deathrate stays high due to ART
# proportion staying at the 2005 level.
relPopBase <- filter(fixedResults, year >= 2005)$plhiv / 
  filter(hivCascade, year >= 2005, population == "all", 
         stage == "infected")$value
```

## load diagnoses data for 2005-2014

```{r loaddiags}
# Load national diagnoses data from the ASR from 2005-2014

# TODO: Upate this automatically

diagnoses <- c(953, 987, 947, 901, 942, 907, 979, 1064, 1028, 1081)

plhiv <- filter(hivCascade, year >= 2005,
                     population == "all", 
                     stage == "infected")$value

```

# Set up simple model
```{r simplemodel}
# Now do our simple model to see what we get
# I = beta*(1-propSuppressed)*PLHIV + beta*propSuppressed*(1-efficacy)*PLHIV 
#   = beta*(1-propSuppressed*efficacy)*PLHIV

# TODO: Fix deathrate to AHOD deathrate in 2005 and recalculate PLHIV -----

# Setup
nyears <- length(diagnoses)
samples <- 10000
# set.seed(403)

# First sample efficacy using a Beta distribution
# source('~/Research/!Evaluation_Modelling/project_care_cascades/code/FindBeta.R')
# quantile1 <- list(p=0.5, x=0.03)
# quantile2 <- list(p=0.975, x=0.27)
# quantile3 <- list(p=0.025, x=0.01)
# require(LearnBayes)
# findBeta(quantile1, quantile2, quantile3)
# # "The best beta prior has a= 0.85 b= 10.76"
# curve(dbeta(x, 0.85, 10.76))# plot the prior
reductionSample <- rbeta(samples, 0.85, 10.76)
efficacySample <- (1 - reductionSample) 

# Some stats
# mean(effSample) # 0.93
# median(effSample) # 0.95

# Preallocate 
predInc <- matrix(0, samples, nyears)
predIncBase <- matrix(0, samples, nyears)

predBeta <- matrix(0, samples, nyears)
predBetaBase <- matrix(0, samples, nyears)

for (ii in 1:samples) {
  
  # Efficacy for this simulation - status quo and expansion scenario
  effSample <- efficacySample[ii] #0.95
  
  # Set up base line values
  plhivSampleBase <- runif(1, plhivLower[1], plhivUpper[1])
  suppressedSampleBase <- runif(1, suppressedLower[1], suppressedUpper[1])
  
  # First calculate our initial Beta value for 2005
  propSampleBase <- suppressedSampleBase / plhivSampleBase
  beta0 <- diagnoses[1] / (plhivSampleBase * (1-  propSampleBase* effSample))
  
  # Results same in both scenarios
  predInc[ii, 1] <-  diagnoses[1]
  predIncBase[ii, 1] <- diagnoses[1]
  
  predBeta[ii, 1] <-  diagnoses[1] / plhivSampleBase
  predBetaBase[ii, 1] <- predBeta[ii, 1]
  
  for (jj in 2:nyears) {
    
    # Sample required parameters from ranges
    plhivSample <- runif(1, plhivLower[jj], plhivUpper[jj])
    plhivSampleBase <- relPopBase[jj] * plhivSample
    suppressedSample <- runif(1, suppressedLower[jj], suppressedUpper[jj])
    
    # Now calculate estimate change in incidence and beta over time
    propSample <- suppressedSample / plhivSample
    predInc[ii, jj] <- beta0 * plhivSample * (1-propSample * effSample) 
    predIncBase[ii, jj] <- beta0 * plhivSampleBase * 
      (1-propSampleBase * effSample)
    
    # Now calculate corresponding Beta value
    predBeta[ii, jj] <- predInc[ii, jj] / plhivSample
    predBetaBase[ii, jj] <- predIncBase[ii, jj] / plhivSampleBase
  }
}
```

```{r resultstidy}
# Reshape all results into a long format data frame for analysis 
# and plotting

predResults <- TidyLongitudinal(predInc, 2005)
baseResults <- TidyLongitudinal(predIncBase, 2005) 

allResults <- cbind(predResults, baseResults$value)
colnames(allResults)[3] <- "prediction"
colnames(allResults)[4] <- "base"

# Create data frame of summary stats of results: mean, median, iqr, range
results <- allResults %>% 
  group_by(year) %>%
  summarise(average = mean(prediction), 
            median = median(prediction),
            iqrlower = median - IQR(prediction) / 2,
            iqrupper = median + IQR(prediction) / 2,
            max = max(prediction),
            min = min(prediction),
            averagebase = mean(base), 
            medianbase = median(base),
            iqrlowerbase = medianbase - IQR(base) / 2,
            iqrupperbase = medianbase + IQR(base) / 2,
            maxbase = max(base),
            minbase = min(base))

# Add diagnoses
results$diagnoses <- diagnoses

# Beta results 
betaResults <- TidyLongitudinal(predBeta, 2005)

resultsBeta <- betaResults %>% 
  group_by(year) %>%
  summarise(average = mean(value), 
            median = median(value),
            iqrlower = median - IQR(value) / 2,
            iqrupper = median + IQR(value) / 2,
            max = max(value),
            min = min(value))

resultsBeta$estimate <- diagnoses / plhiv

```

* Plot the output
```{r plotcode}

# Create plot for the results
incPlot <- ggplot(data = results, aes(x = year)) + 
  geom_ribbon(aes(ymin = iqrlower, ymax = iqrupper), 
              fill = asrcols[2], alpha = 0.4)  +
  geom_line(aes(y = median, colour = "art_exp")) + 
  geom_ribbon(aes(ymin = iqrlowerbase, ymax = iqrupperbase), 
              fill = "black", alpha = 0.2)  +
  geom_line(aes(y = medianbase, colour =  "status_quo")) +
  geom_line(aes(y = diagnoses, colour = "diagnoses")) + 
  geom_point(aes(y = diagnoses), colour = asrcols[1], size = 2) + 
  scale_x_continuous(breaks = seq(2005, 2014, by = 3)) +
  expand_limits(y = 0) +
  scale_colour_manual(name = "", 
                      breaks = c("art_exp", "diagnoses", "status_quo"),
                      values = c(asrcols[2], asrcols[1], "black"),
                      labels = c("ART expansion", 
                                 "Annual notifications", 
                                 "Maintain 2005 suppression level"),
                      guide = guide_legend(reverse = TRUE)) +
  xlab("Year") + ylab("New infections") +
  plotOpts + theme(legend.position = c(0.5, 0.2)) 

  # Save the plot
  ggsave(file.path(figuresFolder, "ART_impact.png"), 
       plot = incPlot,
       width = 10, height = 8, units = "cm")
  
  # Create a plot for Beta overtime
  betaPlot <- ggplot(data = resultsBeta, aes(x = year)) + 
    geom_ribbon(aes(ymin = iqrlower, ymax = iqrupper), 
                fill = asrcols[2], alpha = 0.4)  +
    geom_line(aes(y = median, colour = "art_exp")) +
    geom_line(aes(y = estimate, colour = "diagnoses")) + 
    geom_point(aes(y = estimate), colour = asrcols[1], size = 2) +
    scale_x_continuous(breaks = seq(2005, 2014, by = 3)) + 
    expand_limits(y = 0) +
    scale_colour_manual(name = "", 
                      breaks = c("art_exp", "diagnoses"),
                      values = c(asrcols[2], asrcols[1]),
                      labels = c("With ART expansion", 
                                 "From annual notifications"),
                      guide = guide_legend(reverse = TRUE)) +
    xlab("Year") + ylab("Transmission risk") +
    plotOpts + theme(legend.position = c(0.5, 0.2))
  
  # Save the plot
  ggsave(file.path(figuresFolder, "ART_impact_beta.png"), 
       plot = betaPlot,
       width = 10, height = 8, units = "cm")

```

