---
title: "Exploration of duplicates in HIV notifications"
author: "Richard T. Gray"
date: '`r format(Sys.Date(), format="%d %B %Y")`'
output: 
  word_document:
    pandoc_args: --output="docs/PLDHIV_aging.docx"
---

This Rmarkdown document describes an exploration of the number and 
proportion of duplicate notifications in the Australian HIV Registry. The 
primary reason for this exploration is to assess the validity of using the
deduplication algorithm published in:

> Law, M G, A M McDonald, and J M Kaldor. "Estimation of Cumulative HIV 
> Incidence in Australia, Based on National Case Reporting." Australian 
> and New Zealand Journal of Public Health 20, no. 2 (April 1996): 215-7.

for use in the Australian HIV diagnosis and care cascades. 

```{r knitr_options, include=FALSE} 
knitr::opts_chunk$set(echo = FALSE, 
  warning = FALSE, 
  message = FALSE, 
  include = FALSE) 
```

## Settings and assumptions

We applied the deduplication algorithm to the entire set of notifications 
in the HIV registry to the end of 2016 and separately for notifications 
from the states of New South Wales (NSW) and Victoria (Vic). For these
settings we estimated annual and cumulative notifications (including 
duplicates), the cumulative number and proportion of notifications that are 
unique, and the annual number and proportion of notifications that are 
unique each year. 

The algorithm is statistical in nature and is applied to all notifications 
since the start of Australia's HIV epidemic in 1980 (year of first 
notification). Annual estimates for a given year are obtained by applying 
this algorithm to all the notifications between 1980 and each given year 
and then taking the difference. This can lead to invalid estimates where 
the annual proportion unique is > 1 and the number of duplicates is 
negative. However, adding the annual number of duplicates will produce the 
correct cumulative number of unique notifications and this value is the key 
estimate for the HIV cascades. Thus we pretend the annual estimates are 
valid for the purposes of our calculations and estimates. 

In recent years there is likely to be very few duplicates in the registry 
due to validation processes as part of HIV surveillance especillay 
following an audit of all notifications in 2002 (I believe). So far we have 
simply applied the algorithm to all notifications and assumed the estimates 
are valid, even if the number of duplictes seems a bit high in recent years,
and assumed other (uncertain) components of the cascade calculations 
(such as emigration) balance out any errors in the estimates for duplicates. 
We explored the validity of this assumption by considering scenarios 
where all notifications since 1992 or 2002 overall and for each state are 
unique (arbitrarily chosen years). We then compared the estimates for each 
setting and scenario.

```{r Initilization}
# Load HIV project and set working directory to source file location 

# Analysis directories 
basePath <- file.path(getwd(), "output", "Duplicates") 
resultsFolder <- file.path(basePath, "analysis") # for storing results

# Load libraries
library(LeftysRpkg)
LoadLibrary(tidyverse)
LoadLibrary(cowplot)
LoadLibrary(captioner)

# Script options
savePlots <- TRUE
if (savePlots) {
  if (!file.exists(resultsFolder)) {
    dir.create(resultsFolder)
  }
}

# Captions setup
figs <- captioner()
tabs <- captioner(prefix = "Table")
```

```{r Load Results}
# Load previously generated results for national (All), NSW, and Vic. These
# results were generated by ~/HIV/1-PldhivCalculations.Rmd  with the 
# appropriate options and stored in the directories in basePath. 

file <- "UniqueNotifications.csv"

# National estimates
all2022 <- read_csv(file.path(basePath, "All", file)) %>%
  mutate(state = "all", replace = "2022")
all2002 <- read_csv(file.path(basePath, "All-2002", file)) %>%
  mutate(state = "all", replace = "2002")
all1992 <- read_csv(file.path(basePath, "All-1992", file)) %>%
  mutate(state = "all", replace = "1992")

# NSW estimates
nsw2022 <- read_csv(file.path(basePath, "NSW", file)) %>%
  mutate(state = "nsw", replace = "2022")
nsw2002 <- read_csv(file.path(basePath, "NSW-2002", file)) %>%
  mutate(state = "nsw", replace = "2002")
nsw1992 <- read_csv(file.path(basePath, "NSW-1992", file)) %>%
  mutate(state = "nsw", replace = "1992")

# Vic estimates
vic2022 <- read_csv(file.path(basePath, "Vic", file)) %>%
  mutate(state = "vic", replace = "2022")
vic2002 <- read_csv(file.path(basePath, "Vic-2002", file)) %>%
  mutate(state = "vic", replace = "2002")
vic1992 <- read_csv(file.path(basePath, "Vic-1992", file)) %>%
  mutate(state = "vic", replace = "1992")

# Put everything into a giant data frame
results <- bind_rows(all2022, all2002, all1992, nsw2022, nsw2002, nsw1992,
  vic2022, vic2002, vic1992, .id = "set") %>%
  select(set, year, state, replace, everything())

```

## Results

The following plots show selected results for each region. 

```{r Plot results}
# This chuck produces all the plots.

# Setup plot specifications -----------------------------------------------
cols <- PlotColors("main")

scenarios <- c("total", "cum1992", "cum2002", "cumall")
scenarioNames <- c("total" = "All notifications",
  "cum2002" = "Assumed unique since 2002",
  "cum1992" = "Assumed unique since 1992",
  "cumall" = "Unique notifications")
scenarioCols <- cols[1:4]
names(scenarioCols) <- scenarios

plotOpts <- PlotOptions() + theme(legend.position = "right",
    plot.title = element_text(hjust = 0.5))

# Figure 1 -------------------------------------------------------------



resultsPlot <- function(data) {
  # Function for plotting results
  plot <- ggplot(data = filter(data, replace == 2022), 
  aes(x = year)) +
  geom_line(aes(y = totalnotifications, colour = "total")) +
  geom_line(data = filter(data, replace == 1992),
    aes(y = cum_unique_replace, colour = "cum1992")) +
  geom_line(data = filter(data, replace == 2002),
    aes(y = cum_unique_replace, colour = "cum2002")) +
  geom_line(aes(y = cum_unique, colour = "cumall")) +
  scale_colour_manual(name = "", 
    limits = scenarios,
    breaks = scenarios,
    labels = scenarioNames[scenarios],
    values = scenarioCols[scenarios]) +
  labs(x = "Year", y = "Cumulative\nnotifications") + 
  plotOpts

  return(plot)
}

allResults <-resultsPlot(filter(results, state == "all")) +
    labs(title = "National notifications")
nswResults <-resultsPlot(filter(results, state == "nsw")) +
    labs(title = "NSW notifications")
vicResults <-resultsPlot(filter(results, state == "vic")) +
    labs(title = "Victoria notifications")

# Create a combined figure
legend <- GetLegend(allResults)
figure1a <- allResults + theme(legend.position = "none") 
figure1b <- nswResults + theme(legend.position = "none") 
figure1c <- vicResults + theme(legend.position = "none") 

figure1 <- plot_grid(figure1a, figure1b, figure1c, legend,
  labels = c("A", "B", "C", ""), ncol = 2, nrow = 2)

# Figure caption 
figs("figure1", "Cumulative total (black line) and unique notifications 
(green line) for A) Australia overall, B) NSW, and C) Victoria. The blue
  and red lines show the results when all notifications since 1992
  and 2002 are assumed to be unique, respectively.")

if (savePlots) {
  SaveFigure(resultsFolder, "Cumulative_notifications", figure1,
    height = 9, width = 16, units = "cm")
}


```


