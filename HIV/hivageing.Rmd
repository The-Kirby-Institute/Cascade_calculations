---
title: "PLDHIV by Age"
author: Richard T. Gray
date: Latest version - `r format(Sys.Date(), format="%B %d %Y")`
output:
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 8
    pandoc_args: --output="docs/PLDHIV_aging.docx"
    reference_docx: docs/mystyles.docx
csl: docs/plos.csl
bibliography: docs/HIVcascades.bib
---

This R Markdown document provides estimates of the number of PLDHIV by age
group up to 2014. This work builds on the previous work of J. Murray et. 
al. [@murray2010hivaging] using a similar methodology but including 
overseas migration and a slightly different approach to estimating the 
number of deaths. The analysis uses data for the total number of deaths, 
the estimated death rate, and the estimated overseas migration rate from
the national HIV cascade estimates.

# Analysis

Previously J. Murray et. al. estimated the number of deaths in
PLDHIV by age using AIDS diagnoses and the overall mortality rate for the 
Australian population using ABS data [@murray2010hivaging]. In this 
analysis we count the number of deaths recorded in the registry since the
start of the epidemic. Up to 2003 we use the results from a linkage study 
with the National Death Index [@nakhaee2009changes] to estimate the number
of missing deaths each year. Overall this linkage study estimated 23.5% of
deaths in PLDHIV were missing from the HIV registry. After 2003, we 
estimated the number of deaths using the overall death rates from AHOD
(NOTE: could potentially use AHOD death rates by age but the numbers are
likely to be too small for some age groups).

Deaths missing from the HIV registry or estimated using an overall death 
rate are allocated to age groups based on the age-specific death rates 
from the ABS. The ABS provides age-specific death rates from 2000 to 2011 
for males and females in the general population (http://www.abs.gov.au/ausstats/abs@.nsf/Lookup/by%20Subject/4125.0~Jan%202013~Main%20Features~Death%20rate~3210). 
Figure 1 shows an example from the year 2011. For this analysis we are 
essentially incresing these general population rates to take into account 
HIV infection. 

**Figure 1** - Age-specific death rates in the general population in 2011.
```{r Insert mortality plot, echo = FALSE, messages = FALSE, fig.width = 5}
knitr::include_graphics("misc/ABS_2011_Deathrate.png")
```

As we are using the relative death rate to allocate estimated deaths where
the age at death is unknown we use male age-death rates for the overall
population  (as they have a similar shape to the female death rates),  
the 2000 death rates for all years up to 2000 and the 2011 death rates for
all years after 2011. We assume the same HIV related death rate for males
and females from AHOD.  

```{r initialization, echo = FALSE, messages = FALSE, include=FALSE}
# Set working directory to source file location

# Clear workspace
rm(list=ls())

# Various directories - set working directory to soruce file location. 
basePath <- getwd()
dataFolder <- file.path(basePath, "data")
docFolder <- file.path(basePath, "docs")
figFolder <- file.path(basePath, "output","figures")
resultsFolder <- file.path(basePath, "output")

# Source key functions
Rcode <- file.path(basePath, "code") 
source(file.path(Rcode, "LoadLibrary.R"), echo=TRUE)
source(file.path(Rcode, "PlotOptions.R"), echo=TRUE)
source(file.path(Rcode, "TidyLongitudinal.R"), echo=TRUE)
source(file.path(Rcode, "AgeCat.R"), echo=TRUE)

# Load standard libraries
source(file.path(Rcode, "DataLibraries.R"), echo=TRUE)
LoadLibrary(gridExtra)

# Primary script parameters
currTime <- format(Sys.time(), "%y-%m-%d") # to append to saved files
analysisYear <- 2015

# Script options
region <- "qld"
calculateGender <- FALSE
if (region == "all") {
  calculateGender <- TRUE
} 
savePlots <- TRUE
plotGray <- FALSE # Use grayscale or colour in plots
# saveResults <- TRUE

```

```{r loaddresults, echo = FALSE, messages = FALSE, include=FALSE}
# Load the previously saved hiv notifications data frame - hivSet
load(file.path(resultsFolder, paste("HIVset-",
                                    toString(analysisYear), ".rda", 
                                    sep = "")))

# Load the previously saved hivresults data frame - hivResults
load(file.path(resultsFolder, paste("HIVresults-",
                                    toString(analysisYear), ".rda", 
                                    sep = "")))

# Load the previously saved hivrGender data frame - hivGender
load(file.path(resultsFolder, paste("HIVresults-",
                                    toString(analysisYear), "_gender.rda",
                                    sep = "")))

# Load current hiv cascade - hivCascade
load(file.path(resultsFolder, paste("HIVcascadeEstimates-",
                                    toString(analysisYear), ".rda", sep = "")))

# Load current hiv cascade - hivCascade
load(file.path(resultsFolder, paste("HIVInterstateEstimates-",
                                    toString(analysisYear), ".rda", sep = "")))

# Extract PLDHIV for overall population to 
pldhivAll <- hivCascade %>%
  filter(stage == "pldhiv", population == "all") %>%
  select(-stage, -population)

if (region == "all") {
  pldhiv <- pldhivAll
  uniquecasesYear <- 0.98 * hivResults$uniquecases 
} else {
  
  pldhiv <- hivCascade %>%
  filter(stage == "pldhiv", population == region) %>%
  select(-stage, -population)
  
  # Calculate number of notifications each year by region/state
  hivState <- hivSet %>% group_by(state, yeardiagnosis) %>% 
    summarise(notifications = n()) %>% 
    ungroup() %>% 
    group_by(state) %>%
    mutate(totalnotifications = cumsum(notifications)) %>%
    ungroup() %>% 
    group_by(yeardiagnosis) %>% 
    mutate(propnotifications = notifications / sum(notifications)) %>%
    mutate(proptotalnotifications = 
             totalnotifications / sum(totalnotifications)) %>% 
    filter(yeardiagnosis <= analysisYear)   
  
  stateResults <- hivState %>%
    filter(state == region) %>%
    select(-state)
  
  if (length(stateResults$totalnotifications) < 36) {
    numZeros <- 36 - length(stateResults$totalnotifications)
    totalnotifications <- c(rep(0, numZeros), 
                                         stateResults$totalnotifications)
  } else {
    totalnotifications <- stateResults$totalnotifications
  }
  
  uniquecasesYear <- 0.98 * totalnotifications *
    hivResults$propunique
  
  interstateRate <- filter(hivInterstate, state == region)$netrate
  interstateArrive <- filter(hivInterstate, state == region)$arriverate
  interstateDepart <- filter(hivInterstate, state == region)$departrate
  
  interstateFactor <- (pldhivAll$value - pldhiv$value) / pldhiv$value
  interstateFactor[interstateFactor == Inf] <- 0
}

```

```{r organizedata, echo = FALSE, messages = FALSE, include=FALSE}
# Organize diagnoses and known deaths into matrices
# Each row is an age group and each column is a year after 1980
# Age groups: <15, 15-19, 20-24, 25-29, 30-34, 35-39, 40-44, 45-49, 50-54, 
#             55-59, 60-64, 65-69, 70+ (13 age groups)

nyears <- analysisYear - 1980 + 1
nages <- 18

ageList <- c("a0-4", "a4-9","a10-14", "a15-19", "a20-24", "a25-29", 
             "a30-34", "a35-39", "a40-44", "a45-49", "a50-54", "a55-59", 
             "a60-64", "a65-69", "a70-74", "a75-79", "a80-84", "a85+")

yearList <- paste("y", as.character(1980:analysisYear), sep = "")


# Initialize age diagnosis and age death matrices  --------------

# Overall
ageDiag <- matrix(0, nages, nyears)
rownames(ageDiag) <- ageList
colnames(ageDiag) <- yearList

ageDeath <- matrix(0, nages, nyears)
rownames(ageDeath) <- ageList
colnames(ageDeath) <- yearList

# By sex
ageDiagMale <- matrix(0, nages, nyears)
rownames(ageDiagMale) <- ageList
colnames(ageDiagMale) <- yearList

ageDeathMale <- matrix(0, nages, nyears)
rownames(ageDeathMale) <- ageList
colnames(ageDeathMale) <- yearList

ageDiagFemale <- matrix(0, nages, nyears)
rownames(ageDiagFemale) <- ageList
colnames(ageDiagFemale) <- yearList

ageDeathFemale <- matrix(0, nages, nyears)
rownames(ageDeathFemale) <- ageList
colnames(ageDeathFemale) <- yearList

# Calculate estimated number of unique diagnoses -------------------------

# Overall
uniqueCases <- uniquecasesYear
unqiueDiags <- c(uniqueCases[1], diff(uniqueCases))

# By gender
uniqueCasesMale <- 0.98 * filter(hivGender, sex == "male")$propunique *
  filter(hivGender, sex == "male")$totalnotifications
unqiueDiagsMale <- c(uniqueCasesMale[1], diff(uniqueCasesMale))

uniqueCasesFemale <- 0.98 * filter(hivGender, sex == "female")$propunique *
  filter(hivGender, sex == "female")$totalnotifications

uniqueCasesFemale <- c(0, 0, 0, 0, uniqueCasesFemale) # append 0 for NA

unqiueDiagsFemale <- c(uniqueCasesFemale[1], diff(uniqueCasesFemale))

hivSetMale <- filter(hivSet, sex == "male")
hivSetFemale <- filter(hivSet, sex == "female")


# Now loop through all the notifications and put age in the right place

# Overall ----------------------------------------------------------------
for (ii in 1:nyears) {
  year <- 1980 + ii - 1
  
  # Sort out diagnoses ---------------------------------------------------
  
  # Extract diagnoses in this year and age at diagnosis
  if (region == "all") {
    yearDiags <- hivSet %>% 
      filter(yeardiagnosis == year) %>%
      select(agehiv)
  } else {
    yearDiags <- hivSet %>% 
      filter(yeardiagnosis == year, state == region) %>%
      select(agehiv)
  }
  
  # Now put people in the right age bin
  agebins <- table(AgeCat(yearDiags$agehiv, lower = 0, 
                          upper = 85, by = 5), useNA = "always")
  
  # Reallocate NA's
  if (sum(is.na(agebins)) > 0) {
    probvec <- head(agebins, -1)/sum(head(agebins, -1))


    reallocate <- sample(length(head(agebins, -1)), tail(agebins, 1),
                         replace = TRUE, prob = probvec)

    agebins[unique(reallocate)] <- agebins[unique(reallocate)] +
      as.vector(table(reallocate))
  }
  
  # Tidy up age bins and add to the agediag matix
  agebins <- head(agebins, -1)
  
  # Adjust age bins to remove duplicates normalizing to the number
  # of unique cases 
  if (sum(agebins) != 0) {
  ageDiag[, ii] <- agebins * unqiueDiags[ii] / sum(agebins) 
  } else {
    ageDiag[, ii] <- 0
  }
  # Sort out deaths -----------------------------------------------------
  
  # Extract deaths in this year and age at death
  if (region == "all") {
  yearDeaths <- hivSet %>% 
    filter(yeardeath == year) %>%
    mutate(agedeath = agehiv + (yeardeath - yeardiagnosis)) %>%
    select(agedeath)
  } else {
    yearDeaths <- hivSet %>% 
    filter(yeardeath == year, state == region) %>%
    mutate(agedeath = agehiv + (yeardeath - yeardiagnosis)) %>%
    select(agedeath)
  }
  
  # Now put people in the right age bin -  assume all deaths are complete 
  # so we don't have to reallocate NAs
  deathbins <- table(AgeCat(yearDeaths$agedeath, lower = 0, upper = 85, 
                            by = 5))
  
  # Tidy up 
  # deathbins <- as.vector(c(sum(deathbins[1:3]), 
  #                          deathbins[4:length(deathbins)]))
  
  ageDeath[, ii] <- deathbins
}

if (calculateGender) {
  
  # Male ----------------------------------------------------------------
  for (ii in 1:nyears) {
    year <- 1980 + ii - 1
    
    # Sort out diagnoses -------------------------------------------------
    
    # Extract diagnoses in this year and age at diagnosis
    yearDiags <- hivSetMale %>% 
      filter(yeardiagnosis == year) %>%
      select(agehiv)
    
    # Now put people in the right age bin
    agebins <- table(AgeCat(yearDiags$agehiv, lower = 0, 
                            upper = 85, by = 5), useNA = "always")
    
    # Reallocate NA's
    probvec <- head(agebins, -1)/sum(head(agebins, -1))
    reallocate <- sample(length(head(agebins, -1)), tail(agebins, 1), 
                         replace = TRUE, prob = probvec)
    
    agebins[unique(reallocate)] <- agebins[unique(reallocate)] + 
      as.vector(table(reallocate)) 
    
    # Tidy up age bins and add to the agediag matix
    agebins <- head(agebins, -1)
    
    # Adjust age bins to remove duplicates normalizing to the number
    # of unique cases 
    ageDiagMale[, ii] <- agebins * unqiueDiagsMale[ii]/sum(agebins) 
    
    # Sort out deaths -----------------------------------------------------
    
    # Extract deaths in this year and age at death
    yearDeaths <- hivSetMale %>% 
      filter(yeardeath == year) %>%
      mutate(agedeath = agehiv + (yeardeath - yeardiagnosis)) %>%
      select(agedeath)
    
    # Now put people in the right age bin -  assume all deaths are complete 
    # so we don't have to reallocate NAs
    deathbins <- table(AgeCat(yearDeaths$agedeath, lower = 0, upper = 85, 
                              by = 5))
    
    # Tidy up 
    # deathbins <- as.vector(c(sum(deathbins[1:3]), 
    #                          deathbins[4:length(deathbins)]))
    
    ageDeathMale[, ii] <- deathbins
  }
  
  # Female ----------------------------------------------------------------
  for (ii in 1:nyears) {
    year <- 1980 + ii - 1
    
    # Sort out diagnoses ---------------------------------------------------
    
    # Extract diagnoses in this year and age at diagnosis
    yearDiags <- hivSetFemale %>% 
      filter(yeardiagnosis == year) %>%
      select(agehiv)
    
    # Now put people in the right age bin
    agebins <- table(AgeCat(yearDiags$agehiv, lower = 0, 
                            upper = 85, by = 5), useNA = "always")
    
    # Reallocate NA's - Females cause some trouble because of no diagnoses
    # in some years 
    if (agebins[19] > 0) {
      probvec <- head(agebins, -1)/sum(head(agebins, -1))
      reallocate <- sample(length(head(agebins, -1)), tail(agebins, 1), 
                           replace = TRUE, prob = probvec)
      
      agebins[unique(reallocate)] <- agebins[unique(reallocate)] + 
        as.vector(table(reallocate)) 
    }
    
    # Tidy up age bins and add to the agediag matix
    agebins <- head(agebins, -1)
    
    # Adjust age bins to remove duplicates normalizing to the number
    # of unique cases 
    if (sum(agebins) > 0) {
      ageDiagFemale[, ii] <- agebins * unqiueDiagsFemale[ii]/sum(agebins) 
    }
    
    # Sort out deaths -----------------------------------------------------
    
    # Extract deaths in this year and age at death
    yearDeaths <- hivSetFemale %>% 
      filter(yeardeath == year) %>%
      mutate(agedeath = agehiv + (yeardeath - yeardiagnosis)) %>%
      select(agedeath)
    
    # Now put people in the right age bin -  assume all deaths are complete 
    # so we don't have to reallocate NAs
    deathbins <- table(AgeCat(yearDeaths$agedeath, lower = 0, upper = 85, 
                              by = 5))
    
    # Tidy up 
    # deathbins <- as.vector(c(sum(deathbins[1:3]), 
    #                          deathbins[4:length(deathbins)]))
    
    ageDeathFemale[, ii] <- deathbins
  }
  
}

```

```{r extradeaths, echo = FALSE, messages = FALSE, include=FALSE}
# Estimate the total number of deaths each year using the death rates

# Calculate estimated number of deaths each year using the deathrate 
# Assume same hiv deathrate for all genders
estimateDeaths <- pldhiv$value * hivResults$deathrate
estimateDeathsMale <- filter(hivDiagGender, population == "male")$value *
  hivResults$deathrate
estimateDeathsFemale <- filter(hivDiagGender, 
                               population == "female")$value *
  hivResults$deathrate

# Determine the difference in deaths between the estimate and the known 
# deaths - if there are negative numbers it is okay because we will end
# up adding people instead of removing them below to ensure total deaths
# are consistant with the overall estimate of deaths. (TODO): This does 
# raise questions about using AHOD rates if there are less deaths than
# recorded! 
unknownDeaths <- estimateDeaths - colSums(ageDeath)
unknownDeathsMale <- estimateDeathsMale - colSums(ageDeathMale)
unknownDeathsFemale <- estimateDeathsFemale - colSums(ageDeathFemale)

# Distribute deaths to age groups based on the ABS death rates for
# each group - (TODO): May replace with AHOD death rates if available

# Load deathrates data from ABS for 2014
absFolder <- file.path(path.expand("~"), "Research",
                       "!Evaluation_Modelling", "data")
absDeathRates <- read.csv(file.path(absFolder, 
                                    "ABS_Deathrate_Age_State_clean-2014.csv", 
                                    sep =""), as.is = c(1,2))

absDeathRatesAll <- filter(absDeathRates, gender == "males", 
                           state == "all") %>% tbl_df()
absDeathRatesMale <- filter(absDeathRates, gender == "males",
                            state == "all") %>% tbl_df()
absDeathRatesFemale <- filter(absDeathRates, gender == "females",
                              state == "all") %>% tbl_df()

```

```{r calculate, echo = FALSE, messages = FALSE, include=FALSE} 
# Calculate the number in each age group 

yearsVec <- 1980:analysisYear

# Create an aging rate vector 
ageRate <- c(rep(0.2, nages - 1), 0)

# Initialize results matrix
agePldhiv <- matrix(0, nages, nyears)
rownames(agePldhiv) <- ageList
colnames(agePldhiv) <- yearList

agePldhivMale <- matrix(0, nages, nyears)
rownames(agePldhivMale) <- ageList
colnames(agePldhivMale) <- yearList

agePldhivFemale <- matrix(0, nages, nyears)
rownames(agePldhivFemale) <- ageList
colnames(agePldhivFemale) <- yearList

# Add first years diagnoses
agePldhiv[, 1] <- ageDiag[, 1]
agePldhivMale[, 1] <- ageDiagMale[, 1]
agePldhivFemale[, 1] <- ageDiagFemale[, 1]


# Loop through each year and age and tally up number of PLDHIV in each 
# age group

# Overall ----------------------------------------------------------------
for (ii in 2:nyears) {
  
  # Extract abs death rates for this year
  if (yearsVec[ii - 1] <= 2005) {
    absDeaths <- filter(absDeathRatesAll, year == 2004)$deathrate
  } else if (yearsVec[ii - 1] >= 2015) {
    absDeaths <- filter(absDeathRatesAll, year == 2014)$deathrate
  } else {
    absDeaths <- filter(absDeathRatesAll, 
                        year == yearsVec[ii - 1])$deathrate
  }
  
  # Adjust numbers per 1000 to rate and remove deaths for those aged 0
  absDeaths <- absDeaths/1000
  absDeaths <- absDeaths[3:length(absDeaths)]
  
  # Use ABS deathrate to estimate expected deaths in each age group
  deathsABSrate <- absDeaths * agePldhiv[, ii - 1]
  
  # Calculate adjustment factor so deaths across age groups matchs
  # unknown death - can be negative if unknownDeaths is negative equates
  # to adding people rather than removing them. This keeps things 
  # consistent with estimated total deaths.
  if (sum(deathsABSrate) !=0) {
    adjustFactor <- unknownDeaths[ii - 1] / sum(deathsABSrate)
    unknownAgeDeaths <- adjustFactor * deathsABSrate
  } else {
    unknownAgeDeaths <- rep(0, nages)
  }
  
  for (jj in 1:nages) {
    
    # Calculate number of people moving up in age
    if (jj == 1) {
      # If in first age group no-one ages from younger group
      ageUp <- 0
    } else {
      ageUp <- agePldhiv[jj - 1, ii - 1] * ageRate[jj-1]
    }
    
    # Update current age group for current year - assuming same 
    # overseas migration rate for each age group equal to overall 
    # migration rate
    # agePldhiv[jj, ii] <- agePldhiv[jj, ii - 1] + ageDiag[jj, ii] - 
    #   ageDeath[jj, ii - 1] - unknownAgeDeaths[jj] - 
    #   agePldhiv[jj, ii - 1] * hivResults$osrate[ii-1] - 
    #   agePldhiv[jj, ii - 1] * ageRate[jj] + ageUp
    
    if (region != "all") {
      agePldhiv[jj, ii] <- agePldhiv[jj, ii - 1] + ageDiag[jj, ii] - 
        ageDeath[jj, ii - 1] - unknownAgeDeaths[jj] - 
        agePldhiv[jj, ii - 1] * hivResults$osrate[ii-1] - 
        agePldhiv[jj, ii - 1] * ageRate[jj] + ageUp - 
        agePldhiv[jj, ii - 1] * interstateDepart[ii-1] +
        agePldhiv[jj, ii - 1] * interstateArrive[ii-1] * interstateFactor[ii-1]
    } else {
      agePldhiv[jj, ii] <- agePldhiv[jj, ii - 1] + ageDiag[jj, ii] - 
        ageDeath[jj, ii - 1] - unknownAgeDeaths[jj] - 
        agePldhiv[jj, ii - 1] * hivResults$osrate[ii-1] - 
        agePldhiv[jj, ii - 1] * ageRate[jj] + ageUp  
    }
    
    # For low numbers the previous calculation could give number less
    # than zero. In this case repalce with zero
    if (agePldhiv[jj, ii] < 0) {
      agePldhiv[jj, ii] <- 0
    }
  }
}


if (calculateGender) {
  # Males ----------------------------------------------------------------
  for (ii in 2:nyears) {
    
    # Extract abs death rates for this year
    if (yearsVec[ii - 1] <= 2005) {
      absDeaths <- filter(absDeathRatesMale, year == 2004)$deathrate
    } else if (yearsVec[ii - 1] >= 2015) {
      absDeaths <- filter(absDeathRatesMale, year == 2014)$deathrate
    } else {
      absDeaths <- filter(absDeathRatesMale, 
                          year == yearsVec[ii - 1])$deathrate
    }
    
    # Adjust numbers per 1000 to rate and remove deaths for those aged 0
    absDeaths <- absDeaths/1000
    absDeaths <- absDeaths[3:length(absDeaths)]
    
    # Use ABS deathrate to estimate expected deaths in each age group
    deathsABSrate <- absDeaths * agePldhivMale[, ii - 1]
    
    # Calculate adjustment factor so deaths across age groups matchs
    # unknown death - can be negative if unknownDeaths is negative equates
    # to adding people rather than removing them. This keeps things 
    # consistent with estimated total deaths.
    adjustFactor <- unknownDeathsMale[ii - 1] / sum(deathsABSrate)
    unknownAgeDeaths <- adjustFactor * deathsABSrate
    
    for (jj in 1:nages) {
      
      # Calculate number of people moving up in age
      if (jj == 1) {
        # If in first age group no-one ages from younger group
        ageUp <- 0
      } else {
        ageUp <- agePldhivMale[jj - 1, ii - 1] * ageRate[jj-1]
      }
      
      # Update current age group for current year - assuming same 
      # overseas migration rate for each age group equal to overall 
      # migration rate
      agePldhivMale[jj, ii] <- agePldhivMale[jj, ii - 1] + 
        ageDiagMale[jj, ii] - 
        ageDeathMale[jj, ii - 1] - unknownAgeDeaths[jj] - 
        agePldhivMale[jj, ii - 1] * hivResults$osrate[ii-1] - 
        agePldhivMale[jj, ii - 1] * ageRate[jj] + ageUp
      
      # For low numbers the previous calculation could give number less
      # than zero. In this case replace with zero
      if (agePldhivMale[jj, ii] < 0) {
        agePldhivMale[jj, ii] <- 0
      }
    }
  }
  
  # Females ----------------------------------------------------------------
  for (ii in 2:nyears) {
    
    # Extract abs death rates for this year
    if (yearsVec[ii - 1] <= 2005) {
      absDeaths <- filter(absDeathRatesFemale, year == 2004)$deathrate
    } else if (yearsVec[ii - 1] >= 2015) {
      absDeaths <- filter(absDeathRatesFemale, year == 2014)$deathrate
    } else {
      absDeaths <- filter(absDeathRatesFemale, 
                          year == yearsVec[ii - 1])$deathrate
    }
    
    # Adjust numbers per 1000 to rate and remove deaths for those aged 0
    absDeaths <- absDeaths/1000
    absDeaths <- absDeaths[3:length(absDeaths)]
    
    # Use ABS deathrate to estimate expected deaths in each age group
    deathsABSrate <- absDeaths * agePldhivFemale[, ii - 1]
    
    # Calculate adjustment factor so deaths across age groups matchs
    # unknown death - can be negative if unknownDeaths is negative equates
    # to adding people rather than removing them. This keeps things 
    # consistent with estimated total deaths.
    if (sum(deathsABSrate) > 0) {
      adjustFactor <- unknownDeathsFemale[ii - 1] / sum(deathsABSrate)
      unknownAgeDeaths <- adjustFactor * deathsABSrate
    } else {
      unknownAgeDeaths <- 0 * deathsABSrate
    }
    
    for (jj in 1:nages) {
      
      # Calculate number of people moving up in age
      if (jj == 1) {
        # If in first age group no-one ages from younger group
        ageUp <- 0
      } else {
        ageUp <- agePldhivFemale[jj - 1, ii - 1] * ageRate[jj-1]
      }
      
      # Update current age group for current year - assuming same 
      # overseas migration rate for each age group equal to overall 
      # migration rate
      agePldhivFemale[jj, ii] <- agePldhivFemale[jj, ii - 1] + 
        ageDiagFemale[jj, ii] - 
        ageDeathFemale[jj, ii - 1] - unknownAgeDeaths[jj] - 
        agePldhivFemale[jj, ii - 1] * hivResults$osrate[ii-1] - 
        agePldhivFemale[jj, ii - 1] * ageRate[jj] + ageUp
      
      # For low numbers the previous calculation could give number less
      # than zero. In this case replace with zero
      if (agePldhivFemale[jj, ii] < 0) {
        agePldhivFemale[jj, ii] <- 0
      }
    }
  }
  
}
# Tidy up agePldhiv so it has the bins we want to plot -------------------
ageBins <- c("a<15", "a15-19", "a20-24", "a25-29", 
             "a30-34", "a35-39", "a40-44", "a45-49", "a50-54", "a55-59", 
             "a60-64", "a65-69", "a70+")

binPldhiv <- matrix(0, length(ageBins), nyears)
binPldhiv[2:12,] <- agePldhiv[4:14,]
binPldhiv[1,] <- colSums(agePldhiv[1:3,])
binPldhiv[13,] <- colSums(agePldhiv[15:18,])

if (calculateGender) {
  
  binPldhivMale <- matrix(0, length(ageBins), nyears)
  binPldhivMale[2:12,] <- agePldhivMale[4:14,]
  binPldhivMale[1,] <- colSums(agePldhivMale[1:3,])
  binPldhivMale[13,] <- colSums(agePldhivMale[15:18,])
  
  binPldhivFemale <- matrix(0, length(ageBins), nyears)
  binPldhivFemale[2:12,] <- agePldhivFemale[4:14,]
  binPldhivFemale[1,] <- colSums(agePldhivFemale[1:3,])
  binPldhivFemale[13,] <- colSums(agePldhivFemale[15:18,])
}

```

```{r plotresults, echo = FALSE, messages = FALSE, include=FALSE} 
# Create a stacked bar chart and filled bar chart 
graphics.off()

# First reshape the matrix into a dataframe for ggplot and replace 
# age group numbering with labels
pldhivTidy <- TidyLongitudinal(binPldhiv, 1980, firstCol = "age")
pldhivTidy$age <- rep(sub("a", "", ageBins), nyears)

if (calculateGender) {
  pldhivTidyMale <- TidyLongitudinal(binPldhivMale, 1980, firstCol = "age")
  pldhivTidyMale$age <- rep(sub("a", "", ageBins), nyears)
  
  pldhivTidyFemale <- TidyLongitudinal(binPldhivFemale, 1980, 
                                       firstCol = "age")
  pldhivTidyFemale$age <- rep(sub("a", "", ageBins), nyears)
}

# Setup some ploting variables
startYear <- 1986
if (plotGray) {
  getPalette <- gray.colors(nrow(binPldhiv), start = 0, end = 0.95)
  mainColours <- rev(getPalette)
} else {
  getPalette <- colorRampPalette(brewer.pal(9, "Spectral"))
  getPalette <- colorRampPalette(cbPalette)
  mainColours <- rev(getPalette(nages))
}

xValues <- seq(startYear, analysisYear, by = 7)

# Get the data we want to plot
pldhivTidy <- pldhivTidy %>%
  filter(year >= startYear) %>%
  rename(number = value)

if (calculateGender) {
  
  pldhivTidyMale <- pldhivTidyMale %>%
    filter(year >= startYear) %>%
    rename(number = value)
  
  pldhivTidyFemale <- pldhivTidyFemale %>%
    filter(year >= startYear) %>%
    rename(number = value)
}

# Overall Plots ----------------------------------------------------------

# Now do the barplot of number of PLDHIV
barPlotAll <- ggplot(data = pldhivTidy, aes(x = year, y = number, 
                                            fill = age)) + geom_bar(stat = "identity") + 
  xlab("Year") + ylab("Number of PLDHIV") +
  scale_fill_manual(values = mainColours, name = "Age",
                    guide = guide_legend(reverse=TRUE)) + 
  scale_x_continuous(breaks = xValues) + 
  plotOpts + theme(legend.position = "",
                   legend.text = element_text(size = 8))

# Now do the barplot of proportions
propPlotAll <- ggplot(data = pldhivTidy, aes(x = year, y = number, 
                                             fill = age)) + geom_bar(stat="identity", position = "fill") + 
  xlab("Year") + ylab("Proportion of PLDHIV") +
  scale_fill_manual(values = mainColours, name = "Age",
                    guide = guide_legend(reverse=TRUE)) + 
  scale_x_continuous(breaks = xValues) + 
  plotOpts + theme(legend.position = "right",
                   legend.text = element_text(size = 8))

if (calculateGender) {
# Male Plots ----------------------------------------------------------

# Now do the barplot of number of PLDHIV
barPlotMale <- ggplot(data = pldhivTidyMale, aes(x = year, y = number, 
                                                 fill = age)) + geom_bar(stat = "identity") + 
  xlab("Year") + ylab("Number of PLDHIV (males)") +
  scale_fill_manual(values = mainColours, name = "Age",
                    guide = guide_legend(reverse=TRUE)) + 
  scale_x_continuous(breaks = xValues) + 
  plotOpts + theme(legend.position = "",
                   legend.text = element_text(size = 8))

# Now do the barplot of proportions
propPlotMale <- ggplot(data = pldhivTidyMale, aes(x = year, y = number, 
                                                  fill = age)) + geom_bar(stat="identity", position = "fill") + 
  xlab("Year") + ylab("Proportion of PLDHIV (males)") +
  scale_fill_manual(values = mainColours, name = "Age",
                    guide = guide_legend(reverse=TRUE)) + 
  scale_x_continuous(breaks = xValues) + 
  plotOpts + theme(legend.position = "right",
                   legend.text = element_text(size = 8))

# Female Plots ----------------------------------------------------------

# Now do the barplot of number of PLDHIV
barPlotFemale <- ggplot(data = pldhivTidyFemale, 
                        aes(x = year, y = number, 
                            fill = age)) + geom_bar(stat = "identity") + 
  xlab("Year") + ylab("Number of PLDHIV (females)") +
  scale_fill_manual(values = mainColours, name = "Age",
                    guide = guide_legend(reverse=TRUE)) + 
  scale_x_continuous(breaks = xValues) + 
  plotOpts + theme(legend.position = "",
                   legend.text = element_text(size = 8))

# Now do the barplot of proportions
propPlotFemale <- ggplot(data = pldhivTidyFemale, 
                         aes(x = year, y = number, 
                             fill = age)) + geom_bar(stat="identity", position = "fill") + 
  xlab("Year") + ylab("Proportion of PLDHIV (females)") +
  scale_fill_manual(values = mainColours, name = "Age",
                    guide = guide_legend(reverse=TRUE)) + 
  scale_x_continuous(breaks = xValues) + 
  plotOpts + theme(legend.position = "right",
                   legend.text = element_text(size = 8))

}

# Save figures -----------------------------------------------------------
if (savePlots) {
  units = "cm"
  width = 12.5
  height = 10
  
  ggsave(file.path(figFolder, paste("PLDHIV_Age_All.png", 
                                    sep ="")), plot = barPlotAll, width = width, height = height,
         units = units)
  ggsave(file.path(figFolder, paste("PLDHIV_Age_Proportion_All.png", 
                                    sep ="")), plot = propPlotAll, width = width, height = height, 
         units = units)
  
  if (calculateGender) {
    ggsave(file.path(figFolder, paste("PLDHIV_Age_Male.png", 
                                      sep ="")), plot = barPlotMale, width = width, height = height,
           units = units)
    ggsave(file.path(figFolder, paste("PLDHIV_Age_Proportion_Male.png", 
                                      sep ="")), plot = propPlotAll, width = width, height = height, 
           units = units)
    
    ggsave(file.path(figFolder, paste("PLDHIV_Age_Female.png", sep ="")),
           plot = barPlotFemale, width = width, height = height, 
           units = units)
    ggsave(file.path(figFolder, paste("PLDHIV_Age_Proportion_Female.png", 
                                      sep ="")), plot = propPlotFemale, width = width, height = height,
           units = units)
  }
}
```

# Results

Figures 2-4 and Tables 1-6 show the age distribution for PLDHIV overall
and by sex. Note the sum of the male and female estimates may not equal 
the overall estimate as we excluded transgender people and diagnoses with 
missing data. 

## For overall population of PLDHIV

**Figure 2** - Number and proportion of PLDHIV by age-group in Australia 
from 1986 to 2014.  
```{r insertyplots1, echo=FALSE, messages = FALSE, warning = FALSE, results = "hide"}
print(grid.are(barPlotAll, propPlotAll, ncol = 2, widths = c(1, 1.2)))
```

```{r create tables,echo=FALSE, messages = FALSE, warning = FALSE}
# Create dataframes to present as tables 

pldhivTable <- pldhivTidy %>%
  filter(year >= 2005) %>%
  spread(year, number)

propTable <- apply(pldhivTable[,2:ncol(pldhivTable)], 2, 
                   function(x) x/sum(x)) %>%
  as.data.frame()

propTable$age <- pldhivTable$age 
propTable <- select(propTable, age, everything())

```

\pagebreak

**Table 1** - Number of PLDHIV by age-group in Australia from 2005 to 2014. Rounded to nearest integer.
```{r Insert number table, echo=FALSE, messages = FALSE, warning = FALSE, results = "asis"}
kable(pldhivTable, digits = 0, format.args = list(big.mark = ","))
```

\pagebreak

**Table 2** - Proportion of PLDHIV by age-group in Australia from 2005 to 2014. Rounded to three decimal places.
```{r Insert proportion table, echo=FALSE, messages = FALSE, warning = FALSE, results = "asis"}
kable(propTable, digits = 3,
      format.args = list(justify = "centre"))
```

\pagebreak

## For male population of PLDHIV

**Figure 3** - Number and proportion of male PLDHIV by age-group 
in Australia from 1986 to 2014.  
```{r insertyplots3, echo=FALSE, messages = FALSE, warning = FALSE, results = "hide"}
print(grid.arrange(barPlotMale, propPlotMale, ncol = 2, 
                   widths = c(1, 1.2)))
```

```{r create tables (male),echo=FALSE, messages = FALSE, warning = FALSE}
# Create dataframes to present as tables 

pldhivTableMale <- pldhivTidyMale %>%
  filter(year >= 2005) %>%
  spread(year, number)

propTableMale <- apply(pldhivTableMale[,2:ncol(pldhivTableMale)], 2, 
                       function(x) x/sum(x)) %>%
  as.data.frame()

propTableMale$age <- pldhivTableMale$age 
propTableMale <- select(propTableMale, age, everything())

```

\pagebreak

**Table 3** - Number of male PLDHIV by age-group in Australia from 2005 to 2014. Rounded to nearest integer.
```{r Insert number table (male), echo=FALSE, messages = FALSE, warning = FALSE, results = "asis"}
kable(pldhivTableMale, digits = 0, format.args = list(big.mark = ","))
```

\pagebreak

**Table 4** - Proportion of male PLDHIV by age-group in Australia from 2005 to 2014. Rounded to three decimal places.
```{r Insert proportion table (male), echo=FALSE, messages = FALSE, warning = FALSE, results = "asis"}
kable(propTableMale, digits = 3,
      format.args = list(justify = "centre"))
```

\pagebreak

## For female population of PLDHIV

**Figure 4** - Number and proportion of female PLDHIV by age-group 
in Australia from 1986 to 2014.  
```{r insertyplots4 , echo=FALSE, messages = FALSE, warning = FALSE, results = "hide"}
print(grid.arrange(barPlotFemale, propPlotFemale, ncol = 2, 
                   widths = c(1, 1.2)))
```

```{r create tables (female),echo=FALSE, messages = FALSE, warning = FALSE}
# Create dataframes to present as tables 

pldhivTableFemale <- pldhivTidyFemale %>%
  filter(year >= 2005) %>%
  spread(year, number)

propTableFemale <- apply(pldhivTableFemale[,2:ncol(pldhivTableFemale)], 
                         2, function(x) x/sum(x)) %>% 
  as.data.frame()

propTableFemale$age <- pldhivTableFemale$age 
propTableFemale <- select(propTableMale, age, everything())

```

\pagebreak

**Table 5** - Number of female PLDHIV by age-group in Australia from 2005 to 2014. Rounded to nearest integer.
```{r Insert number table (female), echo=FALSE, messages = FALSE, warning = FALSE, results = "asis"}
kable(pldhivTableFemale, digits = 0, format.args = list(big.mark = ","))
```

\pagebreak

**Table 6** - Proportion of female PLDHIV by age-group in Australia from 2005 to 2014. Rounded to three decimal places.
```{r Insert proportion table (female), echo=FALSE, messages = FALSE, warning = FALSE, results = "asis"}
kable(propTableFemale, digits = 3,
      format.args = list(justify = "centre"))
```

\pagebreak


# References
