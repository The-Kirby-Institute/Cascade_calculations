Calculation for number of people living with diagnosed HIV
==========================================================

Neil Bretana and Richard T. Gray

This script is used for calculating the number of people 
living with diagnosed HIV in Australia. This is one of the key steps for
producing the estimates of the Australian HIV diagnosis and care cascade. 

This script is part of a project containing version 3.0 of the HIV cascade
calculation scripts. 

```{r Initialization}
# Chunk to setup everything

# Open as a project (setting working directory to source and restarting R)

# Setup directories
basePath <- getwd()
Rcode <- file.path(dirname(basePath), "code") # All cascades code
HIVcode <- file.path(basePath, "code") 
dataFolder <- file.path(basePath, "data")
outputFolder <- file.path(basePath, "output")
figuresFolder <- file.path(basePath, "output", "figures")

# Load standard libraries and options ----------------------------------
source(file.path(Rcode, "LoadLibrary.R"))
source(file.path(Rcode, "DataLibraries.R"))
source(file.path(Rcode, "PlotOptions.R"))

```

The following chunck specifies all the parameters for producing the
estimates of PLHIV previously diagnosed. Result files are saved to the
specified project folder and have a cascade file handle. 

*Current projects*
- ASR_2017 (2017 ASR cascades for year 2016)
- CALD_Cascades
- Paper_2016 (national cascade for paper)
- Aging_Estimates (todo)


```{r Script parameters}
# Chunk to enter all the script parameters we will use
analysisYear <- 2016
saveResults <- FALSE

# Set HIV subsetting function parameters----------------------------------
projectOutput <- 'CALD_Cascades' #'.' for main output folder 

# cascadeName <- paste0("NSW_Vic_All-", toString(analysisYear))
cascadeName <- "temp"
targetGender <- 'all' # all, male, female (single)
targetAge <- 'all' #groups a0_4, a5_9, a10_14,...,a85+, not (combination)
targetCob <- 'all' # all=including n/a, Thailand, etc. (combination)
targetExposure <- 'all' #msm, hetero, pwid, otherexp (combination)
targetAtsi <- 'all' # all, indigenous or non_indigenous.
                    # Only used if country is Australia (single)
targetState <- "all" # c("nsw", "vic") # nsw, sa, nt, qld, vic, wa, act, tas
                               # (combination)
targetLocalRegion <- 'all' #tbd (combination)
targetGlobalRegion <- 'all' # South-East Asia, Sub-Saharan Africa, 
                            # Oceania, South American, Other cob, etc
                            # (combination)

# Some error checking 
if ((length(targetGender) > 1) || (length(targetAtsi) > 1)) {
  stop("Error: targetGender or targetAtsi not a single value") 
}

if (targetAtsi != "all" && targetCob[1] != "Australia" &&
    length(targetCob) > 1) {
  stop("Error: indigenous status only valid for Australian born")   
}

# Script options for calculations
interState <- ifelse(targetState[1] != "all", TRUE, FALSE)
excludeAborig <- FALSE
doAge <- TRUE # TRUE for aging calculations
doRetained <- FALSE # TRUE for appending retained in care
if (doRetained) {
  # Need to specify years for reatined in care calculations
  # This is simply a proportion based on James McMahon's paper
  # which suggested 92-98% of PLDHIV were retained in care. 
  retainedYears <- 2013:analysisYear
}

# Settings for generating ECDC model inputs ------------------------------
ecdcData <- TRUE
ecdcVersion <- '1.2.2'
excludeOS <- FALSE

ecdcModel <- cascadeName # name
if (excludeOS) {
  # If excludeOS don't save the pldhiv estimates as we are only using this
  # for ECDC calculations
  saveResults <- TRUE
}

# Store paramaters for saving
hivParams <- data.frame(cascadeName, targetGender, targetAge, targetCob,
                        targetExposure, targetAtsi, targetState,
                        targetLocalRegion, targetGlobalRegion,
                        interState, doAge, doRetained,
                        excludeAborig, ecdcData, ecdcVersion, excludeOS)

```

```{r Functions}
# Load functions used for analysis 

# Source functions for filling in missing data
source(file.path(Rcode, "FillMissing.R"))
source(file.path(Rcode, "FillDataFrame.R"))

# Load function to calculate number living with diagnosed HIV
source(file.path(HIVcode,"LivingDiagnosed.R"))

# Function to easily extract sub-populations of interest 
source(file.path(HIVcode, "SubHivSet.R"))

# Function for removing duplicates annually
source(file.path(HIVcode, "DeduplicationFunctions.R"))

# Function to replace estimates
source(file.path(HIVcode, "ReplaceEstimates.R"))

# Function to tidy notifications
source(file.path(HIVcode, "TidyNotifications.R"))

# Functions to output ECDC model data
source(file.path(HIVcode, "EcdcCalculations.R"))
source(file.path(HIVcode, "EcdcFiles.R"))

# Functions for adjustments
source(file.path(HIVcode, "GetAdjustments.R"))
source(file.path(HIVcode, "GetMigrate.R"))

```

```{r Clean notifications}
# This chunk loads the national notifications and subsets based on the
# specified criteria in Script paramaters

# Load cleaned notifications data
origHivData <- read.csv(file.path(dataFolder, paste0("hivnotifications",
                    toString(analysisYear), ".csv"))) 

# Read in country code data
countryCodes <- read.csv(file.path(dataFolder, "countryRegionCodes.csv"))

# Tidy up notifications for calculations
hivData <- TidyNotifications(origHivData, analysisYear, countryCodes)

# Data checks-------------------------------------------------------------

# Quick check that we are not doing analysis outside of the data
if (max(hivData$yeardiagnosis) < analysisYear) {
  stop("No data specified for final year of analysis.")
}

# HIV data variables------------------------------------------------------

# Setup variables for overarching analysis                  
allYears <- min(hivData$yeardiagnosis):analysisYear # all years of data

```

```{r Subset notifications}
# Create subsetted notifications dataframe. May have to do this multiple
# times to get the extact number of specific category and those excluded
# for inter-regional movement. E.g. MSM only in NSW as excluded will have
# non-MSM and non-NSW

if (excludeOS) {
  hivData <- filter(hivData, is.na(previ_diag_overseas))
}

hivSetAll <- filter(hivData, yeardiagnosis <= analysisYear)
annDiagsOrig <- hivSetAll %>% 
  group_by(yeardiagnosis) %>%
  summarise(notifications = n()) %>%
  mutate(totalnotifications = cumsum(notifications)) %>%
  ungroup() 

# May not need to do this anymore.
if (excludeAborig) {
  # Set indigenous aside separately to add on later if required
  hivSetIndigenous <- filter(hivSetAll, aboriggroup == 'indigenous')
  hivSetAll <- filter(hivSetAll, aboriggroup == 'non_indigenous')
}

# Extract subset of notifications we want
hivSetReturn <- SubHivSet(hivSetAll, targetAge, targetGender,
                          targetExposure, targetCob, targetAtsi,
                          targetState, targetGlobalRegion)

hivSet <- hivSetReturn[[1]]
hivSetExcluded <- hivSetReturn[[2]]
hivSetUnknown <- hivSetReturn[[3]]

# Calculation cumulative proportion male. This is used for gender weighted
# migration rates
 
hivSetGender <- hivSet %>% 
  group_by(yeardiagnosis, sex) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>%
  spread(sex, notifications) %>%
  rename(year = yeardiagnosis)
hivSetGender[is.na(hivSetGender)] <- 0

# Fill in missing years with zeros
hivSetGender <- FillDataFrame(1980:analysisYear, hivSetGender) %>%
  gather("sex", "notifications", 2:5) %>%
  arrange(year)

hivGenderCum <- hivSetGender %>% 
  group_by(sex) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>%
  select(-notifications) %>%
  spread(sex, cumnotifications) %>%
  select(-unknown) %>%
  gather("sex", "cumnotifications", 2:4) %>%
  mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
    cumnotifications)) %>%
  group_by(year) %>% 
  mutate(propnotifications = cumnotifications / sum(cumnotifications)) %>%
  select(-cumnotifications) %>%
  spread(sex, propnotifications) %>%
  mutate(female = ifelse(is.na(female), 0, female),
    male = ifelse(is.na(male), 0, male),
    transgender = ifelse(is.na(transgender), 0, transgender)) 

if (doAge) {
  # Calculation cumulative proportion male for each age group. 
  hivSetGenderAge <- hivSet %>% 
    group_by(yeardiagnosis, sex, agebin) %>% 
    summarise(notifications = n()) %>% 
    ungroup() %>%
    spread(sex, notifications)
  hivSetGenderAge[is.na(hivSetGenderAge)] <- 0
  hivSetGenderAge <- hivSetGenderAge %>%
    mutate(other = female+transgender+unknown) %>%
    rename(year = yeardiagnosis) %>%
    select(year, agebin, male, other)
  hivSetGenderAge[is.na(hivSetGenderAge)] <- 0
  
  # Fill in missing years with zeros - have to do males and others and
  # then rebind seperately 
  hivSetMaleAge <- hivSetGenderAge %>%
    select(-other) %>% 
    spread(agebin, male)
  hivSetMaleAge[is.na(hivSetMaleAge)] <- 0
  hivSetMaleAge <- FillDataFrame(1980:analysisYear, hivSetMaleAge) %>%
    gather("agebin", "male", 2:20) %>%
    arrange(year)
  
   hivSetOtherAge <- hivSetGenderAge %>%
    select(-male) %>% 
    spread(agebin, other)
  hivSetOtherAge[is.na(hivSetOtherAge)] <- 0
  hivSetOtherAge <- FillDataFrame(1980:analysisYear, hivSetOtherAge) %>%
    gather("agebin", "other", 2:20) %>%
    arrange(year)
  
  hivGenderAgeCum <- hivSetMaleAge %>%
    mutate(other = hivSetOtherAge$other) %>%
    group_by(agebin) %>%
    mutate(cummale = cumsum(male),
      cumother = cumsum(other)) %>%
    ungroup() %>%
    select(-male, -other) %>%
    group_by(year, agebin) %>% 
    mutate(propmale = cummale / (cummale + cumother)) %>%
    mutate(propmale = ifelse(is.nan(propmale), 1, propmale)) %>%
    select(-cummale, -cumother) %>%
    spread(agebin, propmale)
}

```


```{r Annual notifications and proportions}
# This chunk creates a dataframe of the annual notifications for the
# specified criteria.

includeDiags <- hivSet %>% 
  group_by(yeardiagnosis) %>%
  summarise(included = n()) %>%
  ungroup() %>%
  rename(year = yeardiagnosis)
includeDiags <- FillDataFrame(allYears, includeDiags)

# If excluded and unknown is empty replace with zeros
if (length(hivSetExcluded) == 0) {
  excludedDiags <- data_frame(year = allYears,
                            excluded = 0)
} else {
  excludedDiags <- hivSetExcluded %>%
    group_by(yeardiagnosis) %>% 
    summarise(excluded = n()) %>%
    rename(year = yeardiagnosis)
  
}
excludedDiags <- FillDataFrame(allYears, excludedDiags)

if (length(hivSetUnknown) == 0) {
 unknownDiags <- data_frame(year = allYears,
                            unknown = 0)
} else {
unknownDiags <- hivSetUnknown %>%
  group_by(yeardiagnosis) %>% 
  summarise(unknown = n()) %>%
  rename(year = yeardiagnosis)
}
unknownDiags <- FillDataFrame(allYears, unknownDiags)

# Adjust included and excluded annual diagnoses propotionally to replace
# unknwons
adjustDiags <- includeDiags %>% 
  left_join(excludedDiags, by = "year") %>%
  left_join(unknownDiags, by = "year") %>%
  mutate(all = included + excluded + unknown) %>%
  mutate(included = ifelse(is.na(included), 0, included),
         excluded = ifelse(is.na(excluded), 0, excluded),
         unknown = ifelse(is.na(unknown), 0, unknown)) %>%
  mutate(prop_included = included / (included + excluded),
         prop_excluded = excluded / (included + excluded)) %>%
  mutate(prop_included = ifelse(is.nan(prop_included), 0, prop_included), 
         prop_excluded = ifelse(is.nan(prop_excluded), 0, 
                                prop_excluded)) %>%
  mutate(adjusted_included = included  + unknown * prop_included,
         adjusted_excluded = excluded + unknown * prop_excluded)

hivResults <- data_frame(year = adjustDiags$year,
                         notifications = adjustDiags$adjusted_included,
                         cumnotifications =
                           cumsum(adjustDiags$adjusted_included))

# Proportion in each age group--------------------------------------------
# For the known diagnoses calculate proportion by age bin, exposure group,
# cd4 count category and diagnosis type. This will be used to distribute 
# annual notifications for aging PLDHIV.  
if (doAge) {
  agedDiags <- hivSet %>%
    group_by(yeardiagnosis, agebin) %>%
    summarise(diags = n()) %>%
    ungroup() %>%
    spread(agebin, diags) %>%
    rename(year = yeardiagnosis)
  agedDiags[is.na(agedDiags)] <- 0

  #fill missing years
  agedDiags <- FillDataFrame(1980:analysisYear, agedDiags) %>%
    gather("agebin", "diagnoses", 2:20) %>%
    arrange(year) %>%
    filter(agebin != "not_reported") %>%
    group_by(year) %>%
    mutate(propdiags = diagnoses / sum(diagnoses)) %>%
    mutate(propdiags = ifelse(is.nan(propdiags), 0 , propdiags)) %>%
    ungroup()
    
  nyears <- analysisYear - 1980 + 1
  nages <- 18
  
  ageList <- c("a0_4", "a5_9","a10_14", "a15_19", "a20_24", "a25_29", 
    "a30_34", "a35_39", "a40_44", "a45_49", "a50_54", "a55_59", 
    "a60_64", "a65_69", "a70_74", "a75_79", "a80_84", "a85+")
  
  yearList <- paste("y", as.character(1980:analysisYear), sep = "")
  
  hivResultsAge <- agedDiags %>% 
    left_join(., hivResults, by = "year") %>%
    select(-diagnoses, -cumnotifications) %>%
    group_by(year, agebin) %>%
    mutate(diags = propdiags * notifications) %>%
    select(-propdiags, -notifications) %>%
    spread(year, diags) %>%
    ungroup() %>%
    slice(c(1,10,2:9,11:18)) %>%
    select(-agebin) %>%
    as.matrix()

  colnames(hivResultsAge) <- yearList
  rownames(hivResultsAge) <- ageList

}

```

```{r Load base and adjustment estimates}
# This loads the adjustment files for adjusting the death rates and
# migration rates  
hivBase <- read.csv(file.path(dataFolder, paste0("HIVbaseEstimates-",
  toString(analysisYear), ".csv")))
hivAdjustments <- read.csv(file.path(dataFolder,
  paste0("HIVadjustments-",
    toString(analysisYear), ".csv")))
hivInterstate <- read.csv(file.path(dataFolder,
  paste0("HIVinterstateEstimates-",
    toString(analysisYear), ".csv")))

# Load cleaned NOM data variable (cleanNom)
load(file = file.path(dirname(basePath),
  "data", "cleaned_ABS_nom_data.R"))

# Now get the death rates, base migration rates, and proportion stay rates
# Migration rates are now calculated using GetMigrate
subsetRates <- GetAdjustments(hivBase, hivAdjustments, hivInterstate, 
  targetAge, targetGender,
  targetExposure, targetCob,
  targetAtsi, targetLocalRegion,
  targetState, targetGlobalRegion) 

# Get migration rate adjustments 
relMigration <- GetMigrate(analysisYear, cleanNom, targetAge,
  targetGender, targetExposure, targetCob, targetAtsi, targetLocalRegion,
  targetState, targetGlobalRegion, propMale = hivGenderCum$male)

# Adjust migration rate for Indigenous population if required
# Potentially move into GetMigrate
if (targetAtsi == "indigenous" && length(targetCob) == 1 &&
    targetCob[1] == "Australia") {
  relMigration <- 0
} else if ((targetAtsi == "non_indigenous" &&
    targetCob[1] == "Australia")|| targetGlobalRegion[1] != "all" ||
    (targetCob[1] != "all" && targetCob[1] != "Australia")) {
  relMigration <- relMigration *
    hivAdjustments$non_aborig_migration
}

# Final migration rates
subsetRates$mrate <- relMigration * hivBase$migrationrate
subsetRates$mrate_lower <- relMigration * hivBase$migrationrate_lower
subsetRates$mrate_upper <- relMigration * hivBase$migrationrate_upper

if (interState) {
  # For interstate calculations also need overall population estimates
  subsetRatesAll <- GetAdjustments(hivBase, hivAdjustments, hivInterstate,
    targetAge, targetGender,
    targetExposure, targetCob,
    targetAtsi, targetLocalRegion,
    "all", targetGlobalRegion)  
  
  # Get migration rate adjustments 
  relMigrationAll <- GetMigrate(cleanNom, targetAge, targetGender,
    targetExposure, targetCob,
    targetAtsi, targetLocalRegion,
    "all", targetGlobalRegion, propMale = hivGenderCum$male)
  
  # Adjust migration rate for Indigenous population if required
  # Potentially move into GetMigrate
  if (targetAtsi == "indigenous" && length(targetCob) == 1 &&
      targetCob[1] == "Australia") {
    relMigrationAll <- 0
  } else if ((targetAtsi == "non_indigenous" &&
      targetCob[1] == "Australia")|| targetGlobalRegion[1] != "all" ||
      (targetCob[1] != "all" && targetCob[1] != "Australia")) {
    relMigrationAll <- relMigrationAll *
      hivAdjustments$non_aborig_migration
  }
  
  # Final migration rates
  subsetRatesAll$mrate <- relMigrationAll * hivBase$migrationrate
  subsetRatesAll$mrate_lower <- relMigrationAll *
    hivBase$migrationrate_lower
  subsetRatesAll$mrate_upper <- relMigrationAll *
    hivBase$migrationrate_upper
}

if (doAge) {
  # Load age based relative deathrates and migration rates.
  
  # Relative death rates - uses overall data
  # ageDeath <- 
  
  # Relative migration rates
  ageMigrate <- GetMigrateAge(analysisYear, cleanNom, targetGender, 
  targetExposure, targetCob, targetAtsi, targetLocalRegion, targetState, 
  targetGlobalRegion, propMale = NULL)
  
}

```

```{r Calculate PLDHIV}
# This chunk fianlly calculates the number of people living with diagnosed
# HIV

if (interState) {
  # Calculate for interregional migration
  pldhivOverall <- LivingDiagnosed(adjustDiags$all,
                                   subsetRates$annunique, 
                                   subsetRatesAll$deathrate,
                                   subsetRatesAll$mrate,
                                   subsetRatesAll$propstay) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivOverallMin <- LivingDiagnosed(adjustDiags$all,
                                  subsetRates$annunique,  
                                  subsetRatesAll$deathrate_upper,
                                  subsetRatesAll$mrate_upper,
                                  subsetRatesAll$propstay_lower) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivOverallMax <- LivingDiagnosed(adjustDiags$all,
                                  subsetRates$annunique,  
                                  subsetRatesAll$deathrate_lower,
                                  subsetRatesAll$mrate_lower,
                                  subsetRatesAll$propstay_upper) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  
  
  
  # Now do regional migration
  pldhivAll <- LivingDiagnosed(adjustDiags$adjusted_included,
                               subsetRates$annunique,  
                               subsetRates$deathrate,
                               subsetRates$mrate,
                               subsetRates$propstay, 
                               arrivals = subsetRates$inter_arriverate,
                               departs = subsetRates$inter_departrate,
                               pldhiv = pldhivOverall$pldhiv) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  # Use best estimate overall for min and max
  pldhivAllMin <- LivingDiagnosed(adjustDiags$adjusted_included,
                                  subsetRates$annunique,  
                                  subsetRates$deathrate_upper,
                                  subsetRates$mrate_upper,
                                  subsetRates$propstay_lower,
                                  arrivals = subsetRates$inter_arriverate,
                                  departs = subsetRates$inter_departrate,
                                  pldhiv = pldhivOverall$pldhiv) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivAllMax <- LivingDiagnosed(adjustDiags$adjusted_included,
                                  subsetRates$annunique,  
                                  subsetRates$deathrate_lower,
                                  subsetRates$mrate_lower,
                                  subsetRates$propstay_upper,
                                  arrivals = subsetRates$inter_arriverate,
                                  departs = subsetRates$inter_departrate,
                                  pldhiv = pldhivOverall$pldhiv) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  

} else {
  
  # Now do regional migration
  pldhivAll <- LivingDiagnosed(adjustDiags$adjusted_included,
                               subsetRates$annunique, 
                               subsetRates$deathrate,
                               subsetRates$mrate,
                               subsetRates$propstay) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivAllMin <- LivingDiagnosed(adjustDiags$adjusted_included,
                                  subsetRates$annunique,  
                                  subsetRates$deathrate_upper,
                                  subsetRates$mrate_upper,
                                  subsetRates$propstay_lower) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
  pldhivAllMax <- LivingDiagnosed(adjustDiags$adjusted_included,
                                  subsetRates$annunique,  
                                  subsetRates$deathrate_lower,
                                  subsetRates$mrate_lower,
                                  subsetRates$propstay_upper) %>%
    mutate(year = allYears) %>%
    select(year, everything())
  
}

# Store results
hivDiagnosed <- data.frame(stage = "pldhiv",
                           year = allYears,
                           population = "all",
                           value = pldhivAll$pldhiv,
                           lower = pldhivAllMin$pldhiv,
                           upper = pldhivAllMax$pldhiv)


```

```{r ECDC Outputs}
# ECDC calculations-------------------------------------------------------
if (ecdcData) {
  normalizeFactor <- adjustDiags$included / 
    adjustDiags$adjusted_included
  normalizeFactor[is.nan(normalizeFactor)] <- 1
  
  # Folder for ECDC output
  ecdcFolder <- file.path(outputFolder, projectOutput)
  
  if (excludeOS) {
    # excluding OS diagnosis
    dataAll <- EcdcFolders(ecdcFolder, ecdcModel, 
                           includeOS = FALSE)
    EcdcFiles(hivSet, dataAll, propUnique = subsetRates$cumunique,
              propKnown = normalizeFactor)
  } else {
    # including OS diagnosis
    dataAll <- EcdcFolders(ecdcFolder, ecdcModel)
    EcdcFiles(hivSet, dataAll, propUnique = subsetRates$cumunique,
              propKnown = normalizeFactor) 
  }
  
  # Create output directory
  resultsEcdcPath <- file.path(ecdcFolder, "ECDC_models", cascadeName)
  
  #save parameters 
  saveStringParams <- file.path(resultsEcdcPath, "Parameters")
  
  # Write to csv
  write_csv(hivParams, paste0(saveStringParams, ".csv"))
  
  # Save deaths and emigrants into ECDC
  
  # All deaths
  deaths <- pldhivAll %>%
    select(year, deaths) %>%
    rename(all = deaths)
  EcdcWrite(deaths, dataAll[[1]], "deaths")
  
  # All emigrants
  if (interState) {
    emigrants <- pldhivAll %>% 
      select(year, emigrants, diag_departs, inter_departs,
             inter_arrivals) %>%
      mutate(total = emigrants + diag_departs + inter_departs -
               inter_arrivals) %>%
      select(year, total) %>%
      rename(all = total)
  } else {
    emigrants <- pldhivAll %>% 
      select(year, emigrants, diag_departs) %>%
      mutate(total = emigrants + diag_departs) %>%
      select(year, total) %>%
      rename(all = total)
  }
  
  EcdcWrite(emigrants, dataAll[[1]], "emigrants")
  
  hivExpCum <- hivSet %>% 
    filter(is.na(previ_diag_overseas)) %>%
    group_by(expgroup, yeardiagnosis) %>% 
    summarise(notifications = n()) %>% 
    ungroup() %>% 
    group_by(expgroup) %>% 
    mutate(cumnotifications = cumsum(notifications)) %>%
    ungroup() %>% 
    select(-notifications) %>%
    spread(expgroup, cumnotifications) 
  
  if (!("hetero" %in% names(hivExpCum))) hivExpCum$hetero <- 0
  if (!("msm" %in% names(hivExpCum))) hivExpCum$msm <- 0
  if (!("otherexp" %in% names(hivExpCum))) hivExpCum$otherexp <- 0
  if (!("pwid" %in% names(hivExpCum))) hivExpCum$pwid <- 0
  if (!("unknown" %in% names(hivExpCum))) hivExpCum$unknown <- 0
  
  hivExpCum <- hivExpCum %>% select(-unknown) %>%
    gather("expgroup", "cumnotifications", 2:5) %>%
    mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
                                     cumnotifications)) %>%
    group_by(yeardiagnosis) %>% 
    mutate(propnotifications = cumnotifications /
             sum(cumnotifications)) %>%
    mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
                                      propnotifications)) %>%
    select(-cumnotifications) %>%
    ungroup() %>% 
    spread(expgroup, propnotifications) %>%
    rename(year = yeardiagnosis) 
  hivExpCum$msm[2] <- 1.0
  
  expDeaths <- hivExpCum
  expDeaths[, 2:5] <- expDeaths[, 2:5] * 
    matrix(rep(pldhivAll$deaths, 4), ncol = 4)
  
  EcdcWrite(expDeaths, dataAll[[2]], "deaths")
  
  expEmig <- hivExpCum
  expEmig[, 2:5] <- expEmig[, 2:5] * 
    matrix(rep(emigrants$all, 4), ncol = 4)
  
  EcdcWrite(expEmig, dataAll[[2]], "emigrants")

}

```

```{r Append retained}
if (doRetained) {
 # Perform and append retained in care calculations
 source(file.path(HIVcode, "RetainedCare.R"))
  
  # Load retained in care data - Use McMahon et al data for 2013 onwards
  # Hardcoded: value, lower, upper.  Lower and upper ranges correspond 
  # to the range for the percentage retained after follow-up in McMahon 
  # et al., Clinic Network Collaboration and Patient Tracing to Maximize 
  # Retention in HIV Care, PLOS One, May 26, 2015.
  hivParameters <- read.csv(file.path(dataFolder, 
                                "individualHIVparameters.csv"), as.is = 1)
  hivParameters <- select(hivParameters, parameter, value)
  
  for (ii in 1:nrow(hivParameters)) {
    assign(hivParameters$parameter[ii], hivParameters$value[ii])
  }
  
  retained <- vicClinicRetained
  retainedLower <- vicClinicRetainedLower
  retainedUpper <- vicClinicRetainedUpper
  
  hivRetained <- RetainedCare(hivDiagnosed, retained, retainedLower,
                              retainedUpper, retainedYears)
  
  # Merge with hivDiagnosed
  hivDiagnosed <- bind_rows(hivDiagnosed, hivRetained)
  
}
```

```{r Save results}
if (saveResults) {
  # Create output directory
  resultsPath <- file.path(outputFolder, projectOutput, cascadeName)
  dir.create(resultsPath, showWarnings = FALSE, recursive = TRUE)
  
  # Save all estimates
  saveStringDetails <- file.path(resultsPath, 
    paste0("pldhiv-", toString(analysisYear), "-"))
  write_csv(pldhivAll, paste0(saveStringDetails, "all.csv"))
  write_csv(pldhivAllMax, paste0(saveStringDetails, "max.csv"))
  write_csv(pldhivAllMin, paste0(saveStringDetails, "min.csv"))
  
  # Save main results
  saveStringPldhiv <- file.path(resultsPath, 
    paste0("HIVpldhivEstimates-", toString(analysisYear)))
  write_csv(hivDiagnosed, paste0(saveStringPldhiv, ".csv"))
  
  #save parameters 
  saveStringParams <- file.path(resultsPath, "PldhivParameters")
  
  # Write to csv
  write_csv(hivParams, paste0(saveStringParams, ".csv"))
}

```


