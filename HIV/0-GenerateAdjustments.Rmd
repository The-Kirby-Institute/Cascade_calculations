Generate HIV cascade death and migration adjustments
====================================================

Author: Richard T. Gray

This scripts calculates the overseas migration rate and death rate 
adjustments for specific populations of PLWHIV. The results of these 
calculations are stored as files which are read in by the main HIv cascade
calculations scripts and functions. 

The basic approach is to produce a base estimates for the overall 
population of PLWHIV and then adjustment factors for specific 
populations. The overall migration or death rate is then given by: 
population_rate = base * population_adjustment.

```{r Initialization}
# Chunk to setup everything
# Manually set working directory to source file location

# Clear workspace
rm(list=ls()) 

# Setup directories
basePath <- file.path(dirname(getwd()), "HIV")

Rcode <- file.path(dirname(getwd()), "code") 
HIVcode <- file.path(basePath, "code") 
dataFolder <- file.path(basePath, "data")

# Load standard libraries and options ------------------------------------
source(file.path(Rcode, "LoadLibrary.R"), echo=TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo=TRUE)
source(file.path(Rcode, "PlotOptions.R"), echo=TRUE)

# Useful functions -------------------------------------------------------
source(file.path(HIVcode, "TidyNotifications.R"), echo=TRUE)
source(file.path(HIVcode, "DeduplicationFunctions.R"), echo=TRUE)

```
 
```{r Script parameters}
# Chunk to enter all the script parameters we will use
analysisYear <- 2015
startYear <- 1980 # First year in HIV registry is 1980

allYears <- startYear:analysisYear 

if (analysisYear <= 2014) {
  stop("This code not set up for earlier than 2015")
}

saveEstimates <- TRUE

```

```{r Get notifications}
# This chuck reads in all HIV registry notifications up to the analysis 
# year. This is used to calculate the proportional breakdowns for 
# weighting.

# Load cleaned notifications data
rawNotifications <- read.csv(file.path(dataFolder,
  paste0("hivnotifications", toString(analysisYear), ".csv"))) 

# Read in country code data
countryCodes <- read.csv(file.path(dataFolder, "countryRegionCodes.csv"))

# Tidy up notifications for calculations
hivData <- TidyNotifications(rawNotifications, analysisYear, countryCodes)

# Quick checks that we are not doing analysis outside of the data or
# have the wrong notifications file
if (max(hivData$yeardiagnosis) < analysisYear) {
  stop("No data specified for final year of analysis.")
}

if (min(hivData$yeardiagnosis) > startYear) {
  stop("No data specified for first year of analysis.")
}

# Setup our working data frame
hivSet <- filter(hivData, yeardiagnosis <= analysisYear)

```

```{r Annual and cummulative diagnoses}
# This chunk is used to estimate the annual and cumulative proportional 
# notifications for various population groups. 
# TODO: convert into a function?

# Overall 
hivResults <- hivSet %>% 
  group_by(yeardiagnosis) %>% 
  summarise(notifications = n()) %>%
  mutate(totalnotifications = cumsum(notifications)) %>%
  rename(year = yeardiagnosis)

# Exposure - reallocate unknown proportionally by calculating proportion
# for each group using known exposure. Need to manually fix 1981. 
# Assume it is an MSM. 
hivExpAnn <- hivSet %>% 
  group_by(expgroup, yeardiagnosis) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  spread(expgroup, notifications) %>%
  select(-unknown) %>%
  gather("expgroup", "notifications", 2:5) %>%
  mutate(notifications = ifelse(is.na(notifications), 0, 
                                notifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
                                propnotifications)) %>%
  select(-notifications) %>%
  ungroup() %>% 
  spread(expgroup, propnotifications) %>%
  rename(year = yeardiagnosis) 
hivExp$msm[2] <- 1.0

hivExpCum <- hivSet %>% 
  group_by(expgroup, yeardiagnosis) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  group_by(expgroup) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>% 
  select(-notifications) %>%
  spread(expgroup, cumnotifications) %>%
  select(-unknown) %>%
  gather("expgroup", "cumnotifications", 2:5) %>%
  mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
                                cumnotifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / sum(cumnotifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
                                propnotifications)) %>%
  select(-cumnotifications) %>%
  ungroup() %>% 
  spread(expgroup, propnotifications) %>%
  rename(year = yeardiagnosis) 

# Indigenous status
hivAborigAnn <- hivSet %>%
  group_by(yeardiagnosis, aboriggroup) %>%
  summarise(notifications = n()) %>%
  ungroup() %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications))  %>%
  select(-notifications) %>%
  spread(aboriggroup, propnotifications) %>%
  mutate(indigenous = ifelse(is.na(indigenous), 0, indigenous)) %>%
  rename(year = yeardiagnosis)

hivAborigCum <- hivSet %>%
  group_by(yeardiagnosis, aboriggroup) %>%
  summarise(notifications = n()) %>%
  ungroup() %>% 
  group_by(aboriggroup) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>%
  select(-notifications) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / 
           sum(cumnotifications))  %>%
  select(-cumnotifications) %>%
  spread(aboriggroup, propnotifications) %>%
  mutate(indigenous = ifelse(is.na(indigenous), 0, indigenous)) %>%
  rename(year = yeardiagnosis)

# Gender - reallocate unknown proportionally by calculating proportion
# for each group using known exposure.
hivGenderAnn <- hivSet %>% 
  group_by(yeardiagnosis, sex) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  spread(sex, notifications) %>%
  select(-unknown) %>%
  gather("sex", "notifications", 2:4) %>%
  mutate(notifications = ifelse(is.na(notifications), 0, 
                                notifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications)) %>%
  select(-notifications) %>%
  spread(sex, propnotifications) %>%
  mutate(female = ifelse(is.na(female), 0, female),
         male = ifelse(is.na(male), 0, male),
         transgender = ifelse(is.na(transgender), 0, transgender)) %>%
  rename(year = yeardiagnosis)

hivGenderAnn <- hivSet %>% 
  group_by(yeardiagnosis, sex) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  group_by(sex) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>%
  select(-notifications) %>%
  spread(sex, cumnotifications) %>%
  select(-unknown) %>%
  gather("sex", "cumnotifications", 2:4) %>%
  mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
                                cumnotifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / sum(cumnotifications)) %>%
  select(-cumnotifications) %>%
  spread(sex, propnotifications) %>%
  mutate(female = ifelse(is.na(female), 0, female),
         male = ifelse(is.na(male), 0, male),
         transgender = ifelse(is.na(transgender), 0, transgender)) %>%
  rename(year = yeardiagnosis)

# Country of birth - Australia versus overseas
hivCobAnn <- hivSet %>% 
  group_by(yeardiagnosis, countrygroup) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  spread(countrygroup, notifications) %>%
  select(-`<NA>`) %>%
  gather("countrygroup", "notifications", 2:5) %>%
  mutate(notifications = ifelse(is.na(notifications), 0, 
                                notifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
                                propnotifications)) %>%
  select(-notifications) %>%
  ungroup() %>% 
  spread(countrygroup, propnotifications) %>%
  rename(year = yeardiagnosis)  

hivCobCum <- hivSet %>% 
  group_by(countrygroup, yeardiagnosis) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  group_by(countrygroup) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>% 
  select(-notifications) %>%
  spread(countrygroup, cumnotifications) %>%
  select(-`<NA>`) %>%
  gather("countrygroup", "cumnotifications", 2:5) %>%
  mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
                                cumnotifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / sum(cumnotifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
                                propnotifications)) %>%
  select(-cumnotifications) %>%
  ungroup() %>% 
  spread(countrygroup, propnotifications) %>%
  rename(year = yeardiagnosis) 


```

```{r Overseas migration rates}
# This chunk converts the ABS overseas migration data into 
# overseas population movement rates.

# Load all the data sets we need - the ABS data is stored in the main 
# Cascade_calculations respository data/ directory
mainDataFolder <- file.path(dirname(getwd()), "data")
 
absMigration <- read.csv(file.path(mainDataFolder, 
  paste0("ABS_migration_clean-", toString(analysisYear), ".csv")), 
  as.is = 1)
absDeparts <- read.csv(file.path(mainDataFolder, 
  paste0("ABS_departures_clean-", toString(analysisYear), ".csv")),
  as.is = 1)
absInterstate <- read.csv(file.path(mainDataFolder, 
  paste0("ABS_interstate_clean-", toString(analysisYear), ".csv")), 
  as.is = 1)

# Base migration rate ----------------------------------------------------
absDeparts <- mutate(absDeparts, migrate = permanent / erp)
mrate <- absDeparts$migrate

# mrate is missing a value for 1980 assume same value as 1981
mrate <- c(mrate[1], mrate)

# Base overall population migration rates
baseMigration <- mrate
baseMigrationLower <- rep(0, length(allYears))
baseMigrationUpper <- 2* mrate

# Start storing things
hivBaseRates <- data.frame(year = allYears,
                           migrationrate = baseMigration,
                           migrationrate_lower = baseMigrationLower,
                           migrationrate_upper = baseMigrationUpper)

# Adjustments ------------------------------------------------------------

# Gender

# Hard coded adjustment factor to account for age > 15 years and 
# sex. These harded coded estimates for 1981-2015 are determined in 
# the file project_care_cascades/data/Migration_options-2016-10-12.xlsx

# TODO: make this calculation automatic from the data 

allAdultsAdjust <- c(1.2499, 1.2499,	1.2499,	1.240169381, 1.235807895,
                     1.235391781, 1.236048319,	1.236375068,
                     1.236578904, 1.235863902, 1.23556672, 1.235166515,
                     1.234926588, 1.234456001, 1.234217118, 1.233938271,
                     1.233473343, 1.232885687, 1.23528249, 1.234803523,
                     1.234243908, 1.231400608, 1.231146313, 1.230567577,
                     1.22257888, 1.211940692, 1.20153294, 1.191640652,
                     1.180852205, 1.170562151, 1.160456052,	1.150374872,
                     1.140323439, 1.130276173, 1.12031362, 1.12031362)
  
  
maleAdultsAdjust <- c(1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 
                      1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499,
                      1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499,
                      1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 
                      1.2392, 1.2285, 1.2178, 1.2071, 1.1964, 1.1857,
                      1.175, 1.1643, 1.1536, 1.1429, 1.1322, 1.1322)

femaleAdultsAdjust <- rep(1, length(allYears))

# Start storing things
hivAdjustments <- data.frame(year = allYears,
                           mrate_all_adults = allAdultsAdjust,
                           mrate_male_adults = maleAdultsAdjust,
                           mrate_female_adults = femaleAdultsAdjust)
  
# State

states <- c("nsw", "vic", "qld", "nt", "wa", "sa", "tas", "act")

# Produce state based estimates using NOM departure rates to adjust the 
# national base rates
absMigration <- mutate(absMigration, migrate = departures / erp)

nonmrateAll <- filter(absMigration, state == "all")
lmrateAll <- lm(migrate ~ year, data = nonmrateAll)
expmrateAll <- predict(lmrateAll, data.frame(year = allYears),
                       level = 0.9, interval = "confidence")

for (region in states) {
  # Adjust national rate to reflect difference at state level using 
  # national NOM departures data
  
  nonmrate <- filter(absMigration, state == region)
  
  # Now we need to fit and extrapolate for other years
  lmrate <- lm(migrate ~ year, data = nonmrate)
  expmrate <- predict(lmrate, data.frame(year = allYears),
                      level = 0.9, interval = "confidence")
  
  stateAdjust <- expmrate[, 1] / expmrateAll[, 1]
  
  hivAdjustments[[paste0("mrate_", region)]] <- stateAdjust
  
}

# Initial post-diagnosis migration ---------------------------------------

hivBaseRates$propstay <- rep(0.98, length(allYears))
hivBaseRates$propstay_lower <- rep(0.96, length(allYears))
hivBaseRates$propstay_upper <- rep(1, length(allYears))

# Indigenous vs non-Indigenous
nonAborigDiags <- hivResults$totalnotifications *
  hivAborigCum$non_indigenous
aborigDiags <- hivResults$totalnotifications *
  hivAborigCum$indigenous

nonAborigMigrationFactor <- hivResults$totalnotifications / nonAborigDiags

hivAdjustments$pstay_indigenous <- 0
hivAdjustments$pstay_non_indigenous <- nonAborigMigrationFactor

# Specific NSW estimates
propStayNSW <- propAus * (1 - 0.0072) + (1 - propAus) * (1 - 0.1008)
propStayLowerNSW <-  propAus * (1 - 2 * 0.0072) + (1 - propAus) * 
  (1 - 2 * 0.1008)
propStayUpperNSW <- rep(1, length(allYears))

hivAdjustments$pstay_nsw <- propStayNSW / hivBaseRates$propstay
hivAdjustments$pstay_nsw_lower <- propStayLowerNSW /
  hivBaseRates$propstay_lower
hivAdjustments$pstay_nsw_upper <- hivBaseRates$propstay_upper /
  hivBaseRates$propstay_upper

# Specific Vic estimates
propStayVic <- 1
propStayLowerVic <- 1
propStayUpperVic <- 1

hivAdjustments$pstay_vic <- propStayVic / hivBaseRates$propstay
hivAdjustments$pstay_vic_lower <- propStayLowerVic /
  hivBaseRates$propstay_lower
hivAdjustments$pstay_vic_upper <- propStayUpperVic /
  hivBaseRates$propstay_upper

```

```{r Death rates}

# To calculate the number of deaths each year we calculate an overall 
# deathrate with an uncertainty range. This is used to work out the number
# of people diagnosed with HIV. The estimate of the death rate uses a
# number of methods. Firstly uses the 
# 2003 linkage results and the number of known deaths to estimate the
# deathrate up to 2003. It then uses AHOD mortality rates from 2003.

# Overall deathrate ------------------------------------------------------

# Load all the data sets we use for this estimate - use the parameter 
# column as row names for easier subsetting
hivParams <- read.csv(file.path(dataFolder, 
                                "individualHIVparameters.csv"), 
                      as.is = 1)
hivParams <- select(hivParams, parameter, value)

for (ii in 1:nrow(hivParams)) {
  assign(hivParams$parameter[ii], hivParams$value[ii])
}

# Load AHOD data to calculate mortality and do some simple cleaning
ahodData <- read.csv(file.path(dataFolder, 
                               paste0("ahod", toString(analysisYear), 
                                     ".csv")))

# Pre-2003 death rates ---------------------------------------------------

# Extract number of known deaths and store in a central data frame
hivDeaths <- hivData %>% 
  filter(! is.na(yeardeath)) %>%
  group_by(yeardeath) %>% 
  summarise(number_deaths = n()) %>% 
  filter(yeardeath <= analysisYear)  

# Calculate sensitivity of recorded deaths based on linkage results
linkageFactor <- (linkedDeaths + notifiedDeaths) / notifiedDeaths
linkageFactorLower <- linkageFactor * (1 - linkageSensitivity)
linkageFactorUpper <- linkageFactor * (1 + linkageSensitivity)  

#  We don't need to adjust deaths for number of unique diagnoses as
# different dates of death should result in different people

# Set up linked deaths
hivDeaths$inflated_deaths <- hivDeaths$number_deaths * linkageFactor
hivDeaths$inflated_deaths_lower <- hivDeaths$number_deaths * 
  linkageFactorLower
hivDeaths$inflated_deaths_upper <- hivDeaths$number_deaths * 
  linkageFactorUpper

# No deaths in 1980 and 1982 so add this data manually to ensure 
# everything lines up
hivDeaths <- rbind(hivDeaths, c(1980, 0, 0, 0, 0))
hivDeaths <- rbind(hivDeaths, c(1982, 0, 0, 0, 0))
hivDeaths <- arrange(hivDeaths, yeardeath)

# Average mortality rate for linkage data - this is a bit of hack but is 
# set up to ensure the total number of deaths by 2003 equals the total 
# number of linked deaths. 

# First need to calculate annual unique notficatons
overallPropUnique <- ProportionUnique(hivSet,
                                      hivResults$totalnotifications,
                                      allYears)

cumDiagnoses <- hivResults$notifications * overallPropUnique # cumulative
annDiags <- c(cumDiagnoses[1], diff(cumDiagnoses))  # annual diagnoses

deaths <- hivDeaths$inflated_deaths
deaths_min <- hivDeaths$inflated_deaths_lower
deaths_max <- hivDeaths$inflated_deaths_upper

# Calculate number living each year 
numLiving <- rep(NA, length(annDiags))
numLiving_min <- rep(NA, length(annDiags))
numLiving_max <- rep(NA, length(annDiags))

numLiving[1] <- annDiags[1]
numLiving_min[1] <- annDiags[1]
numLiving_max[1] <- annDiags[1]

# Overall migration rate for deaths estimate
allMigrate <- baseMigration * allAdultsAdjust
allMigrateLower <- baseMigrationLower * allAdultsAdjust
allMigrateUpper<- baseMigrationUpper * allAdultsAdjust

for (ii in 2:length(annDiags)) {
  numLiving[ii] <- numLiving[ii-1] + annDiags[ii] - deaths[ii-1] 
   - numLiving[ii-1] * allMigrate$rate[ii-1]
  numLiving_min[ii] <- numLiving_min[ii-1] + annDiags[ii] -
    deaths_max[ii-1] - numLiving_min[ii-1] * allMigrateUpper[ii-1]
  numLiving_max[ii] <- numLiving_max[ii-1] + annDiags[ii] -
    deaths_min[ii-1] - numLiving_max[ii-1] * allMigrateLower[ii-1]
}

# Calculate crude average annual mortality rates up to 2003
linkageMortality <- deaths / numLiving
linkageMortalityMin <- deaths_min / numLiving_max
linkageMortalityMax <- deaths_max / numLiving_min

# Append AHOD mortality --------------------------------------------------

# Calculate crude death rate for each state and year - use 95% CI as the
#  upper and lower bound

ahodDeaths <- ahodData %>% 
  filter(population == "ALL") %>%
  group_by(state, year) %>%
  summarise(n = sum(n_id), 
    deaths = sum(n_death), 
    deathrate = unname(prop.test(sum(n_death), 
      sum(n_id))$estimate), 
    lower = unname(prop.test(sum(n_death), sum(n_id))$conf.int[1]),
    upper = unname(prop.test(sum(n_death), sum(n_id))$conf.int[2])) %>%
  filter(year > 2003)

# First find index corresponding to year of linkage 
indexLinkage <- max(seq(along = startYear:linkageYear))

# Save in deathrate
deathRate <- rep(NA, length(allYears))
deathRate_min <- rep(NA, length(allYears))
deathRate_max <- rep(NA, length(allYears))

deathRate[1:indexLinkage] <- linkageMortality[1:indexLinkage]
deathRate[(indexLinkage + 1):length(deathRate)] <- filter(ahodDeaths, 
  state == "all")$deathrate # 

deathRate_min[1:indexLinkage] <- linkageMortalityMin[1:indexLinkage]
deathRate_min[(indexLinkage + 1):length(deathRate)] <- filter(ahodDeaths, 
  state == "all")$lower # 

deathRate_max[1:indexLinkage] <- linkageMortalityMax[1:indexLinkage]
deathRate_max[(indexLinkage+1):length(deathRate)] <- filter(ahodDeaths, 
  state == "all")$upper 

# Store base death rate --------------------------------------------------
hivBaseRates$deathrate <- deathRate
hivBaseRates$deathrate_lower <- deathRate_min
hivBaseRates$deathrate_upper <- deathRate_max

# Adjustments for Indigenous vs nonIndigenous
nonAborigMortalityFactor <- 
  ((1-aborigMortality) * aborigDiags + nonAborigDiags) / nonAborigDiags
nonAborigMortalityFactorLower <- 
  ((1-aborigMortalityMax) * aborigDiags + nonAborigDiags) / nonAborigDiags
nonAborigMortalityFactorUpper <- 
  ((1-aborigMortalityMin) * aborigDiags + nonAborigDiags) / nonAborigDiags

# TODO: aborigMortality needs to be calculated over time. Also 
# need to shorten some variable names. 
hivAdjustments$drate_indigenous <- aborigMortality
hivAdjustments$drate_indigenous_lower <- aborigMortalityMin / 
  hivBaseRates$deathrate_lower
hivAdjustments$drate_indigenous_upper <- aborigMortalityMax /
  hivBaseRates$deathrate_upper

hivAdjustments$drate_non_indigenous <- nonAborigMortalityFactor
hivAdjustments$drate_non_indigenous_lower <- 
  nonAborigMortalityFactorLower / hivBaseRates$deathrate_lower
hivAdjustments$drate_non_indigenous_upper <- 
  nonAborigMortalityFactorUpper / hivBaseRates$deathrate_upper

```

```{r Interstate migration rates}
# This chunk calculats interstate migration rates. At this stage just 
# calculate the best fit. Don't worry about upper and lower bounds.

# First estimate erp for each state
states <- c("nsw", "vic", "qld", "nt", "wa", "sa", "tas", "act", "all")

stateErp <- data.frame(year = allYears)

for (region in states) {
  lmErp <- lm(erp ~ year, data = filter(absMigration, state == region))
  erpState <- predict(lmErp, data.frame(year = allYears))
  
  # Store extrapolated population
  stateErp[[region]] <- erpState
}

hivInterstate <- gather(stateErp, "state", "erp", 2:10)

# Calculate interstate ERP simply overall population minus state
# population
allErp <- filter(hivInterstate, state == "all")$erp

hivInterstate <- hivInterstate %>% 
  group_by(state) %>%
  mutate(intererp = allErp - erp)

# Calculate departure rate
hivInterstate$departures <- NA

for (region in states) {
  lmDepart <- lm(departures ~ year, data = filter(absInterstate, 
                                                  state == region))
  departState <- predict(lmDepart, data.frame(year = allYears))
  
  # Store extrapolated population
  hivInterstate[hivInterstate$state == region, ]$departures <- departState
}

hivInterstate <- mutate(hivInterstate, departrate = departures / erp) 

# Calculate arrival rate
hivInterstate$arrivals <- NA

for (region in states) {
  lmArrive <- lm(arrivals ~ year, data = filter(absInterstate, 
                                                state == region))
  arriveState <- predict(lmArrive, data.frame(year = allYears))
  
  # Store extrapolated population
  hivInterstate[hivInterstate$state == region, ]$arrivals <- arriveState
}

hivInterstate <- mutate(hivInterstate, arriverate = arrivals / intererp) 

# As intererp is zero national set arriverate to departure rate for "all"
# Gives indication of rate people move interstate nationally
hivInterstate[hivInterstate$state == "all", ]$arriverate <- 
  hivInterstate[hivInterstate$state == "all", ]$departrate

# Add a net leaving rate relative to state ERP -- useful for separate 
# state calculations 
hivInterstate <- mutate(hivInterstate, 
                        netrate = (departures - arrivals) / erp)

```

```{r Save output files}
#hivBaseRates hivAdjustments hivInterstate
# Save base, adjustment, and interstate dataframes
if (saveEstimates) {
  # Base 
  saveBase <- file.path(dataFolder, 
    paste0("HIVbaseEstimates-", toString(analysisYear)))
  
  write.csv(hivBaseRates, file = paste0(saveBase, ".csv"), 
            row.names = FALSE)

  # Adjustments
  saveAdjust<- file.path(dataFolder, 
    paste0("HIVadjustments-", toString(analysisYear)))
  
  write.csv(hivAdjustments, file = paste0(saveAdjust, ".csv"), 
            row.names = FALSE)
  
  # Interstate
  saveInterstate <- file.path(dataFolder, 
    paste0("HIVinterstateEstimates-", toString(analysisYear)))
  
  write.csv(hivInterstate, file = paste0(saveInterstate, ".csv"), 
            row.names = FALSE)
}


```
