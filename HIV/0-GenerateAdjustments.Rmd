Generate HIV cascade death and migration adjustments
====================================================

Author: Richard T. Gray

This scripts calculates the overseas migration rate and death rate 
adjustments for specific populations of PLWHIV. The results of these 
calculations are stored as files which are read in by the main HIV cascade
calculations scripts and functions. 

The basic approach is to produce a base estimates for the overall 
population of PLWHIV and then adjustment factors for specific 
populations. The overall migration or death rate is then given by: 
population_rate = base * population_adjustment.

```{r Initialization}
# Chunk to setup everything

# Open as a project (setting working directory to source and restarting R)

# Setup directories
basePath <- file.path(dirname(getwd()), "HIV")

Rcode <- file.path(dirname(getwd()), "code") 
HIVcode <- file.path(basePath, "code") 
dataFolder <- file.path(basePath, "data")

# Load standard libraries and options ------------------------------------
source(file.path(Rcode, "LoadLibrary.R"), echo=TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo=TRUE)
source(file.path(Rcode, "PlotOptions.R"), echo=TRUE)
source(file.path(Rcode, "FillDataFrame.R"), echo=TRUE)

# Useful functions -------------------------------------------------------
source(file.path(HIVcode, "TidyNotifications.R"), echo=TRUE)
source(file.path(HIVcode, "DeduplicationFunctions.R"), echo=TRUE)

```

```{r Script parameters}
# Chunk to enter all the script parameters we will use
analysisYear <- 2016
startYear <- 1980 # First year in HIV registry is 1980

allYears <- startYear:analysisYear 

if (analysisYear <= 2014) {
  stop("This code not set up for earlier than 2015")
}

saveEstimates <- TRUE

```

```{r Get notifications}
# This chuck reads in all HIV registry notifications up to the analysis 
# year. This is used to calculate the proportional breakdowns for 
# weighting.

# Load cleaned notifications data
rawNotifications <- read.csv(file.path(dataFolder,
  paste0("hivnotifications", toString(analysisYear), ".csv"))) 

# Read in country code data
countryCodes <- read.csv(file.path(dataFolder, "countryRegionCodes.csv"))

# Tidy up notifications for calculations
hivData <- TidyNotifications(rawNotifications, analysisYear, countryCodes)

# Quick checks that we are not doing analysis outside of the data or
# have the wrong notifications file
if (max(hivData$yeardiagnosis) < analysisYear) {
  stop("No data specified for final year of analysis.")
}

if (min(hivData$yeardiagnosis) > startYear) {
  stop("No data specified for first year of analysis.")
}

# Setup our working data frame
hivSet <- filter(hivData, yeardiagnosis <= analysisYear)

# Start storing things
hivBaseRates <- data.frame(year = allYears) 
```

```{r Annual and cummulative diagnoses}
# This chunk is used to estimate the annual and cumulative proportional 
# notifications for various population groups. 
# TODO: convert into a function?

# Overall 
hivResults <- hivSet %>% 
  group_by(yeardiagnosis) %>% 
  summarise(notifications = n()) %>%
  mutate(totalnotifications = cumsum(notifications)) %>%
  rename(year = yeardiagnosis)

# Exposure - reallocate unknown proportionally by calculating proportion
# for each group using known exposure. Need to manually fix 1981. 
# Assume it is an MSM. 
hivExpAnn <- hivSet %>% 
  group_by(expgroup, yeardiagnosis) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  spread(expgroup, notifications) %>%
  select(-unknown) %>%
  gather("expgroup", "notifications", 2:5) %>%
  mutate(notifications = ifelse(is.na(notifications), 0, 
    notifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
    propnotifications)) %>%
  select(-notifications) %>%
  ungroup() %>% 
  spread(expgroup, propnotifications) %>%
  rename(year = yeardiagnosis) 
hivExpAnn$msm[2] <- 1.0

hivExpCum <- hivSet %>% 
  group_by(expgroup, yeardiagnosis) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  group_by(expgroup) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>% 
  select(-notifications) %>%
  spread(expgroup, cumnotifications) %>%
  select(-unknown) %>%
  gather("expgroup", "cumnotifications", 2:5) %>%
  mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
    cumnotifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / sum(cumnotifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
    propnotifications)) %>%
  select(-cumnotifications) %>%
  ungroup() %>% 
  spread(expgroup, propnotifications) %>%
  rename(year = yeardiagnosis) 
hivExpCum$msm[2] <- 1.0

# Indigenous status
hivAborigAnn <- hivSet %>%
  group_by(yeardiagnosis, aboriggroup) %>%
  summarise(notifications = n()) %>%
  ungroup() %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications))  %>%
  select(-notifications) %>%
  spread(aboriggroup, propnotifications) %>%
  mutate(indigenous = ifelse(is.na(indigenous), 0, indigenous)) %>%
  rename(year = yeardiagnosis)

hivAborigCum <- hivSet %>%
  group_by(yeardiagnosis, aboriggroup) %>%
  summarise(notifications = n()) %>%
  ungroup() %>% 
  group_by(aboriggroup) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>%
  select(-notifications) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / 
      sum(cumnotifications))  %>%
  select(-cumnotifications) %>%
  spread(aboriggroup, propnotifications) %>%
  mutate(indigenous = ifelse(is.na(indigenous), 0, indigenous)) %>%
  rename(year = yeardiagnosis)

# Gender - reallocate unknown proportionally by calculating proportion
# for each group using known exposure.
hivGenderAnn <- hivSet %>% 
  group_by(yeardiagnosis, sex) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  spread(sex, notifications) %>%
  select(-unknown) %>%
  gather("sex", "notifications", 2:4) %>%
  mutate(notifications = ifelse(is.na(notifications), 0, 
    notifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications)) %>%
  select(-notifications) %>%
  spread(sex, propnotifications) %>%
  mutate(female = ifelse(is.na(female), 0, female),
    male = ifelse(is.na(male), 0, male),
    transgender = ifelse(is.na(transgender), 0, transgender)) %>%
  rename(year = yeardiagnosis)

hivGenderCum <- hivSet %>% 
  group_by(yeardiagnosis, sex) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  group_by(sex) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>%
  select(-notifications) %>%
  spread(sex, cumnotifications) %>%
  select(-unknown) %>%
  gather("sex", "cumnotifications", 2:4) %>%
  mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
    cumnotifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / sum(cumnotifications)) %>%
  select(-cumnotifications) %>%
  spread(sex, propnotifications) %>%
  mutate(female = ifelse(is.na(female), 0, female),
    male = ifelse(is.na(male), 0, male),
    transgender = ifelse(is.na(transgender), 0, transgender)) %>%
  rename(year = yeardiagnosis)

# Country of birth - Australia versus overseas
hivCobAnn <- hivSet %>% 
  group_by(yeardiagnosis, countrygroup) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  spread(countrygroup, notifications) %>%
  select(-`<NA>`) %>%
  gather("countrygroup", "notifications", 2:5) %>%
  mutate(notifications = ifelse(is.na(notifications), 0, 
    notifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = notifications / sum(notifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
    propnotifications)) %>%
  select(-notifications) %>%
  ungroup() %>% 
  spread(countrygroup, propnotifications) %>%
  rename(year = yeardiagnosis)  

hivCobCum <- hivSet %>% 
  group_by(countrygroup, yeardiagnosis) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>% 
  group_by(countrygroup) %>% 
  mutate(cumnotifications = cumsum(notifications)) %>%
  ungroup() %>% 
  select(-notifications) %>%
  spread(countrygroup, cumnotifications) %>%
  select(-`<NA>`) %>%
  gather("countrygroup", "cumnotifications", 2:5) %>%
  mutate(cumnotifications = ifelse(is.na(cumnotifications), 0, 
    cumnotifications)) %>%
  group_by(yeardiagnosis) %>% 
  mutate(propnotifications = cumnotifications / sum(cumnotifications)) %>%
  mutate(propnotifications = ifelse(is.na(propnotifications), 0, 
    propnotifications)) %>%
  select(-cumnotifications) %>%
  ungroup() %>% 
  spread(countrygroup, propnotifications) %>%
  rename(year = yeardiagnosis) 


```

```{r Annual proportion unique}
# This chunk is used to estimate the annual proportion of notifications 
# that are unique

# Need to consider males and females deparately as there were not many 
# duplicates in the early years for females in the epidemic.

# Females/non-Males
duplicateSet <- hivSet %>%
  filter(sex != "male")
duplicateNotifications <- duplicateSet %>% 
  group_by(yeardiagnosis) %>%
  summarise(notifications = n()) %>%
  mutate(totalnotifications = cumsum(notifications)) %>%
  ungroup() %>%
  rename(year = yeardiagnosis)
duplicateNotifications <- FillDataFrame(allYears, 
  duplicateNotifications)

overallPropUnique <- ProportionUnique(duplicateSet,             
  duplicateNotifications$totalnotifications,
  allYears)

annPropUnique <- AnnualUnique(duplicateNotifications$notifications,
  overallPropUnique) /
  duplicateNotifications$notifications
annPropUnique[is.nan(annPropUnique)] <- 0 # replace infinite numbers 
hivBaseRates$cumunique_female <- overallPropUnique
hivBaseRates$annunique_female <- annPropUnique

# Males or MSM  
duplicateSet <- hivSet %>%
  filter(sex == "male")
duplicateNotifications <- duplicateSet %>% 
  group_by(yeardiagnosis) %>%
  summarise(notifications = n()) %>%
  mutate(totalnotifications = cumsum(notifications)) %>%
  ungroup() %>%
  rename(year = yeardiagnosis)
duplicateNotifications <- FillDataFrame(allYears, 
  duplicateNotifications)
overallPropUnique <- ProportionUnique(duplicateSet,             
  duplicateNotifications$totalnotifications,
  allYears)

annPropUnique <- AnnualUnique(duplicateNotifications$notifications,
  overallPropUnique) /
  duplicateNotifications$notifications
annPropUnique[is.nan(annPropUnique)] <- 0 # replace infinite numbers  
hivBaseRates$cumunique_male <- overallPropUnique
hivBaseRates$annunique_male <- annPropUnique

#All
duplicateSet <- hivSet
duplicateNotifications <- hivResults

overallPropUnique <- ProportionUnique(duplicateSet,             
  duplicateNotifications$totalnotifications,
  allYears)

annPropUnique <- AnnualUnique(duplicateNotifications$notifications,
  overallPropUnique) /
  duplicateNotifications$notifications
annPropUnique[is.nan(annPropUnique)] <- 0 # replace infinite numbers  
hivBaseRates$cumunique_all <- overallPropUnique
hivBaseRates$annunique_all <- annPropUnique

# # Assume all indigenous notifications are unique
# hivBaseRates$propunique_indigenous <- 1

```

## Migration calculations

```{r Overseas migration rates}
# This chunk converts the ABS overseas migration data into 
# overseas population movement rates.

# Load all the data sets we need - the ABS data is stored in the main 
# Cascade_calculations respository data/ directory
mainDataFolder <- file.path(dirname(getwd()), "data")

absMigration <- read.csv(file.path(mainDataFolder, 
  paste0("ABS_migration_clean-", toString(analysisYear), ".csv")), 
  as.is = 1)
absDeparts <- read.csv(file.path(mainDataFolder, 
  paste0("ABS_departures_clean-", toString(analysisYear), ".csv")),
  as.is = 1)
absInterstate <- read.csv(file.path(mainDataFolder, 
  paste0("ABS_interstate_clean-", toString(analysisYear), ".csv")), 
  as.is = 1)

# Base migration rate ----------------------------------------------------
absDeparts <- mutate(absDeparts, migrate = permanent / erp)
mrate <- absDeparts$migrate

# mrate is missing a value for 1980 assume same value as 1981
mrate <- c(mrate[1], mrate)

# Base overall population migration rates
baseMigration <- mrate
baseMigrationLower <- rep(0, length(allYears))
baseMigrationUpper <- 2* mrate

# Start storing things
hivBaseRates$migrationrate <- baseMigration
hivBaseRates$migrationrate_lower <- baseMigrationLower
hivBaseRates$migrationrate_upper <- baseMigrationUpper

# Adjustments ------------------------------------------------------------

# Load NOM data from ABS which is used to adjust the 
# overall migration rates for subpopulations.
removeCountries <- c("Adelie Land (France)", 
  "Antarctica", 
  "Angentinian Antartic Territory",
  "Australia External Territories, nec", 
  "Australia External Territories, nfd", 
  "Australian Antartic Territory",
  "British Antartic Territory", 
  "Chilean Antartic Territory", 
  "Queen Maude Land (Norway)", 
  "Ross Dependency (New Zealand)", 
  "At Sea")

# Read in the ABS nom data (only available for years 2004 to 2014. Does
# contain 2015 data but this is only for first siz months. 
nomData <- read.csv(file.path(mainDataFolder, "ABS_nom_2015.csv"))

# Clean up NOM data for analysis
cleanNom <- nomData %>%
  select(-cob_code) %>%
  filter(!(cob %in% removeCountries)) %>%
  mutate(age = tolower(trimws(age)),
    gender = tolower(trimws(gender)),
    state = tolower(state)) %>%
  mutate(age = paste0("a", age)) %>%
  mutate(age = gsub("-", "_", age),
    gender = gsub("s", "", gender),
    cob = as.character(cob)) %>%
  mutate(age = ifelse(age == "atotal", "all", age),
    state = ifelse(state == "aus", "all", state),
    gender = ifelse(gender == "peron", "all", gender),
    cob = ifelse(cob == "Total", "all", cob)) %>%
  tbl_df()

# Save cleaned data so it is quicker to load
save(cleanNom, file = file.path(mainDataFolder, "cleaned_ABS_nom_data.R"))

# Gender

# Use nome data to adjust migration rates for age abnd gender. Originally 
# used a hard coded adjustment factor to account for age > 15 years and 
# sex. These harded coded estimates for 1981-2016 are determined in 
# the file project_care_cascades/data/Migration_options-2016-10-12.xlsx

# The code now does this automatically using the 2004 to 2014 NOM data 
# from the ABS. WARNING ERP unavailablein 5 year bins for > 75 years old 
# so "a70-75" contains all people older than > 75. Older bins contain the
# same > 75 ERP value. As there are not many departures in the > 75 we 
# exclude them and assume the same rate as the 75+ age group

males15 <- cleanNom %>% 
  filter(year %in% 2004:2014) %>%
  filter(cob == "all", !(age %in% c("a0_4", "a5_9", "a10_14",
    "a80_84", "a85+", "all")), 
  state == "all", gender == "male") %>% 
  group_by(year) %>%
  summarise(departures = sum(nom),
    erp = sum(erp)) %>%
  mutate(migrate = departures / erp)

females15 <- cleanNom %>% 
  filter(year %in% 2004:2014) %>%
  filter(cob == "all", !(age %in% c("a0_4", "a5_9", "a10_14", 
    "a80_84", "a85+", "all")), 
  state == "all", gender == "female") %>% 
  group_by(year) %>%
  summarise(departures = sum(nom),
    erp = sum(erp)) %>%
  mutate(migrate = departures / erp)

allPop <- cleanNom %>% 
  filter(year %in% 2004:2014) %>%
  filter(cob == "all", age == "all", 
  state == "all", gender == "all") %>% 
  group_by(year) %>%
  summarise(departures = sum(nom),
    erp = sum(erp)) %>%
  mutate(migrate = departures / erp)
    
adultMale <- data.frame(relrate = males15$migrate / allPop$migrate, 
  year = 2004:2014)
lmAdultMale <- lm(relrate ~ year, data = adultMale)
maleAdultsAdjust <- predict(lmAdultMale, 
  data.frame(year = 1980:analysisYear))

# maleAdultsAdjust <- c(1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 
#   1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499,
#   1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499,
#   1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 1.2499, 
#   1.2392, 1.2285, 1.2178, 1.2071, 1.1964, 1.1857,
#   1.175, 1.1643, 1.1536, 1.1429, 1.1322, 1.1322)

adultFemale <- data.frame(relrate = females15$migrate / allPop$migrate, 
  year = 2004:2014)
lmAdultFemale <- lm(relrate ~ year, data = adultFemale)
femaleAdultsAdjust <- predict(lmAdultFemale, 
  data.frame(year = 1980:analysisYear))

# femaleAdultsAdjust <- rep(1, length(allYears))

allAdultsAdjust <- hivGenderCum$male * maleAdultsAdjust  + 
  (1 - hivGenderCum$male) * femaleAdultsAdjust 

# allAdultsAdjust <- c(1.2499, 1.2499,	1.2499,	1.240169381, 1.235807895,
#   1.235391781, 1.236048319,	1.236375068,
#   1.236578904, 1.235863902, 1.23556672, 1.235166515,
#   1.234926588, 1.234456001, 1.234217118, 1.233938271,
#   1.233473343, 1.232885687, 1.23528249, 1.234803523,
#   1.234243908, 1.231400608, 1.231146313, 1.230567577,
#   1.22257888, 1.211940692, 1.20153294, 1.191640652,
#   1.180852205, 1.170562151, 1.160456052,	1.150374872,
#   1.140323439, 1.130276173, 1.12031362, 1.12031362)

# if (analysisYear > 2015) {
#   allAdultsAdjust <- c(allAdultsAdjust, tail(allAdultsAdjust, 1))
#   maleAdultsAdjust <- c(maleAdultsAdjust, tail(maleAdultsAdjust, 1))
# }

# Start storing things
hivAdjustments <- data.frame(year = allYears,
  mrate_all_adults = allAdultsAdjust,
  mrate_male_adults = maleAdultsAdjust,
  mrate_female_adults = femaleAdultsAdjust)

# State

states <- c("nsw", "vic", "qld", "nt", "wa", "sa", "tas", "act")

# Produce state based estimates using NOM departure rates to adjust the 
# national base rates
absMigration <- mutate(absMigration, migrate = departures / erp)

nonmrateAll <- filter(absMigration, state == "all")
lmrateAll <- lm(migrate ~ year, data = nonmrateAll)
expmrateAll <- predict(lmrateAll, data.frame(year = allYears),
  level = 0.9, interval = "confidence")

for (region in states) {
  # Adjust national rate to reflect difference at state level using 
  # national NOM departures data
  
  nonmrate <- filter(absMigration, state == region)
  
  # Now we need to fit and extrapolate for other years
  lmrate <- lm(migrate ~ year, data = nonmrate)
  expmrate <- predict(lmrate, data.frame(year = allYears),
    level = 0.9, interval = "confidence")
  
  stateAdjust <- expmrate[, 1] / expmrateAll[, 1]
  
  hivAdjustments[[paste0("mrate_", region)]] <- stateAdjust
  
}

# Initial post-diagnosis migration ---------------------------------------

hivBaseRates$propstay <- rep(0.98, length(allYears))
hivBaseRates$propstay_lower <- rep(0.96, length(allYears))
hivBaseRates$propstay_upper <- rep(1, length(allYears))

# Indigenous vs non-Indigenous
nonAborigDiags <- hivResults$totalnotifications *
  hivAborigCum$non_indigenous
aborigDiags <- hivResults$totalnotifications *
  hivAborigCum$indigenous

nonAborigMigrationFactor <- hivResults$totalnotifications / nonAborigDiags

hivAdjustments$pstay_indigenous <- 1
hivAdjustments$pstay_non_indigenous <- (1 - (1- hivBaseRates$propstay) * 
    nonAborigMigrationFactor) / hivBaseRates$propstay

hivAdjustments$non_aborig_migration <- nonAborigMigrationFactor

# Specific NSW estimates
propAus <- hivCobCum$australia
propStayNSW <- propAus * (1 - 0.0072) + (1 - propAus) * (1 - 0.1008)
propStayLowerNSW <-  propAus * (1 - 2 * 0.0072) + (1 - propAus) * 
  (1 - 2 * 0.1008)
propStayUpperNSW <- rep(1, length(allYears))

hivAdjustments$pstay_nsw <- propStayNSW / hivBaseRates$propstay
hivAdjustments$pstay_nsw_lower <- propStayLowerNSW /
  hivBaseRates$propstay_lower
hivAdjustments$pstay_nsw_upper <- hivBaseRates$propstay_upper /
  hivBaseRates$propstay_upper

# Specific Vic estimates
propStayVic <- 1
propStayLowerVic <- 1
propStayUpperVic <- 1

hivAdjustments$pstay_vic <- propStayVic / hivBaseRates$propstay
hivAdjustments$pstay_vic_lower <- propStayLowerVic /
  hivBaseRates$propstay_lower
hivAdjustments$pstay_vic_upper <- propStayUpperVic /
  hivBaseRates$propstay_upper



```

```{r Death rates}

# To calculate the number of deaths each year we calculate an overall 
# deathrate with an uncertainty range. This is used to work out the number
# of people diagnosed with HIV. The estimate of the death rate uses a
# number of methods. Firstly uses the 
# 2003 linkage results and the number of known deaths to estimate the
# deathrate up to 2003. It then uses AHOD mortality rates from 2003.

# Overall deathrate ------------------------------------------------------

# Load all the data sets we use for this estimate - use the parameter 
# column as row names for easier subsetting
hivParams <- read.csv(file.path(dataFolder, 
  "individualHIVparameters.csv"), 
  as.is = 1)
hivParams <- select(hivParams, parameter, value)

for (ii in 1:nrow(hivParams)) {
  assign(hivParams$parameter[ii], hivParams$value[ii])
}

# Load AHOD data to calculate mortality and do some simple cleaning
ahodData <- read.csv(file.path(dataFolder, 
  paste0("ahod", toString(analysisYear), 
    ".csv")))

# Load gender deathrate ratios
sexDrates <- read_excel(file.path(dataFolder,
  "HIV_Gender_Deathrates.xlsx"),
  sheet = 2) %>%
  select(1,4,5) %>%
  rename(year = Year)
colnames(sexDrates)[2:3] <- c("males", "females")


# Pre-2003 death rates ---------------------------------------------------

# Extract number of known deaths and store in a central data frame
hivDeaths <- hivData %>% 
  filter(! is.na(yeardeath)) %>%
  group_by(yeardeath) %>% 
  summarise(number_deaths = n()) %>% 
  filter(yeardeath <= analysisYear)  

# Calculate sensitivity of recorded deaths based on linkage results
linkageFactor <- (linkedDeaths + notifiedDeaths) / notifiedDeaths
linkageFactorLower <- linkageFactor * (1 - linkageSensitivity)
linkageFactorUpper <- linkageFactor * (1 + linkageSensitivity)  

#  We don't need to adjust deaths for number of unique diagnoses as
# different dates of death should result in different people

# Set up linked deaths
hivDeaths$inflated_deaths <- hivDeaths$number_deaths * linkageFactor
hivDeaths$inflated_deaths_lower <- hivDeaths$number_deaths * 
  linkageFactorLower
hivDeaths$inflated_deaths_upper <- hivDeaths$number_deaths * 
  linkageFactorUpper

# No deaths in 1980 and 1982 so add this data manually to ensure 
# everything lines up
hivDeaths <- rbind(hivDeaths, c(1980, 0, 0, 0, 0))
hivDeaths <- rbind(hivDeaths, c(1982, 0, 0, 0, 0))
hivDeaths <- arrange(hivDeaths, yeardeath)

# Average mortality rate for linkage data - this is a bit of hack but is 
# set up to ensure the total number of deaths by 2003 equals the total 
# number of linked deaths. 

# First need to calculate annual unique notficatons
overallPropUnique <- ProportionUnique(hivSet,
  hivResults$totalnotifications,
  allYears)

cumDiagnoses <- hivResults$totalnotifications * overallPropUnique # cumulative
annDiags <- c(cumDiagnoses[1], diff(cumDiagnoses))  # annual diagnoses

deaths <- hivDeaths$inflated_deaths
deaths_min <- hivDeaths$inflated_deaths_lower
deaths_max <- hivDeaths$inflated_deaths_upper

# Calculate number living each year 
numLiving <- rep(NA, length(annDiags))
numLiving_min <- rep(NA, length(annDiags))
numLiving_max <- rep(NA, length(annDiags))

numLiving[1] <- annDiags[1]
numLiving_min[1] <- annDiags[1]
numLiving_max[1] <- annDiags[1]

templiving <- numLiving

# Overall migration rate for deaths estimate
allMigrate <- baseMigration * allAdultsAdjust
allMigrateLower <- baseMigrationLower * allAdultsAdjust
allMigrateUpper <- baseMigrationUpper * allAdultsAdjust

for (ii in 2:length(annDiags)) {
  # The following formula needs to have the same form as the formula in
  # LivingDiagnosed.R to ensure the deathrates match and the number
  # of deaths at the end of 2003 is correct. 
  # 
  # TODO: replace the calculation below with LivingDiagnosed.R so that
  # accidently differences are prevented.
  
  # Old formula. Based on an Euler approximation approach but given the
  # annual time difference doesn't really capture what we want on an 
  # annual basis. 
  
  numLiving[ii] <- numLiving[ii-1] + annDiags[ii] -
    (1-hivBaseRates$propstay[ii-1]) * annDiags[ii-1] - 
    deaths[ii-1] - numLiving[ii-1] * allMigrate[ii-1]
  numLiving_min[ii] <- numLiving_min[ii-1] + annDiags[ii] -
    (1-hivBaseRates$propstay_upper[ii-1]) * annDiags[ii-1] -
    deaths_max[ii-1] - numLiving_min[ii-1] * allMigrateUpper[ii-1]
  numLiving_max[ii] <- numLiving_max[ii-1] + annDiags[ii] -
    (1-hivBaseRates$propstay_lower[ii-1]) * annDiags[ii-1] -
    deaths_min[ii-1] - numLiving_max[ii-1] * allMigrateLower[ii-1]
  
  # numLiving[ii] <- numLiving[ii-1] + 
  #   hivBaseRates$propstay[ii-1] * annDiags[ii] -
  #   deaths[ii-1] - numLiving[ii-1] * allMigrate[ii-1]
  # numLiving_min[ii] <- numLiving_min[ii-1] +
  #   hivBaseRates$propstay_upper[ii] * annDiags[ii] -
  #   deaths_max[ii-1] - numLiving_min[ii-1] * allMigrateUpper[ii-1]
  # numLiving_max[ii] <- numLiving_max[ii-1] +
  #   hivBaseRates$propstay_lower[ii] * annDiags[ii] -
  #   deaths_min[ii-1] - numLiving_max[ii-1] * allMigrateLower[ii-1]
  
  # New formula. Calculations provide the number at the end of the
  # year using the number at the end of the previous year and changes
  # through the year (assumes new diagnoses stay in the population 
  # except for those who leave immediately) 
  # numLiving[ii] <- numLiving[ii-1] + hivBaseRates$propstay[ii] *
  #   annDiags[ii] - deaths[ii] - numLiving[ii-1] * allMigrate[ii]
  # numLiving_min[ii] <- numLiving_min[ii-1] + 
  #   hivBaseRates$propstay_upper[ii] * annDiags[ii] -
  #   deaths_max[ii] - numLiving_min[ii-1] * allMigrateUpper[ii]
  # numLiving_max[ii] <- numLiving_max[ii-1] + 
  #   hivBaseRates$propstay_lower[ii] * annDiags[ii] -
  #   deaths_min[ii] - numLiving_max[ii-1] * allMigrateLower[ii]
  
}

# Calculate crude average annual mortality rates up to 2003
# Old formula
linkageMortality <- deaths / numLiving
linkageMortalityMin <- deaths_min / numLiving_max
linkageMortalityMax <- deaths_max / numLiving_min

# New formula
# linkageMortality <- deaths / c(numLiving[1], head(numLiving, -1))
# linkageMortalityMin <- deaths_min / 
#   c(numLiving_max[1], head(numLiving_max, -1))
# linkageMortalityMax <- deaths_max / 
#   c(numLiving_min[1], head(numLiving_min, -1))

# Append AHOD mortality -------------------------------------------------

# Calculate crude death rate for each state and year - use 95% CI as the
#  upper and lower bound

ahodDeaths <- ahodData %>% 
  filter(population == "ALL") %>%
  group_by(year, state, population) %>%
  summarise(n = sum(n_id), 
    deaths = sum(n_death), 
    deathrate = unname(prop.test(sum(n_death), 
      sum(n_id))$estimate), 
    lower = unname(prop.test(sum(n_death), sum(n_id))$conf.int[1]),
    upper = unname(prop.test(sum(n_death), sum(n_id))$conf.int[2])) %>%
  filter(year > 2003)

# First find index corresponding to year of linkage 
indexLinkage <- max(seq(along = startYear:linkageYear))

# Save in deathrate
deathRate <- rep(NA, length(allYears))
deathRate_min <- rep(NA, length(allYears))
deathRate_max <- rep(NA, length(allYears))

deathRate[1:indexLinkage] <- linkageMortality[1:indexLinkage]
deathRate[(indexLinkage + 1):length(deathRate)] <- filter(ahodDeaths, 
  state == "all")$deathrate # 

deathRate_min[1:indexLinkage] <- linkageMortalityMin[1:indexLinkage]
deathRate_min[(indexLinkage + 1):length(deathRate)] <- filter(ahodDeaths, 
  state == "all")$lower # 

deathRate_max[1:indexLinkage] <- linkageMortalityMax[1:indexLinkage]
deathRate_max[(indexLinkage+1):length(deathRate)] <- filter(ahodDeaths, 
  state == "all")$upper 

# Store base death rate --------------------------------------------------
hivBaseRates$deathrate <- deathRate
hivBaseRates$deathrate_lower <- deathRate_min
hivBaseRates$deathrate_upper <- deathRate_max

# Because we are dividing sometimes remove zeos
deathrateDiv <- hivBaseRates$deathrate
deathrateDiv[deathrateDiv == 0] <- 1

deathrateDiv_lower <- hivBaseRates$deathrate_lower
deathrateDiv_lower[deathrateDiv_lower == 0] <- 1

deathrateDiv_upper <- hivBaseRates$deathrate_upper
deathrateDiv_upper[deathrateDiv_upper == 0] <- 1

# Adjustments for Indigenous vs nonIndigenous
nonAborigMortalityFactor <- 
  ((1-aborigMortality) * aborigDiags + nonAborigDiags) / nonAborigDiags
nonAborigMortalityFactorLower <- 
  ((1-aborigMortalityMax) * aborigDiags + nonAborigDiags) / nonAborigDiags
nonAborigMortalityFactorUpper <- 
  ((1-aborigMortalityMin) * aborigDiags + nonAborigDiags) / nonAborigDiags

# TODO: aborigMortality needs to be calculated over time. Also 
# need to shorten some variable names. 
hivAdjustments$drate_indigenous <- aborigMortality
hivAdjustments$drate_indigenous_lower <- aborigMortalityMin 
hivAdjustments$drate_indigenous_upper <- aborigMortalityMax 

hivAdjustments$drate_non_indigenous <- nonAborigMortalityFactor
hivAdjustments$drate_non_indigenous_lower <- 
  nonAborigMortalityFactorLower 
hivAdjustments$drate_non_indigenous_upper <- 
  nonAborigMortalityFactorUpper 

# Because we will be dividing remove zeos
deathrateDiv <- hivBaseRates$deathrate
deathrateDiv[deathrateDiv == 0] <- 1

deathrateDiv_lower <- hivBaseRates$deathrate_lower
deathrateDiv_lower[deathrateDiv_lower == 0] <- 1

deathrateDiv_upper <- hivBaseRates$deathrate_upper
deathrateDiv_upper[deathrateDiv_upper == 0] <- 1 

# Adjustments for sex and key states
sexDrates <- na.omit(sexDrates)
hivAdjustments$drate_male <- sexDrates$males
hivAdjustments$drate_female <- sexDrates$females

# Adjustments for key states

hivAdjustments$drate_nsw <- hivBaseRates$deathrate 
hivAdjustments$drate_nsw[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "nsw")$deathrate
hivAdjustments$drate_nsw <- hivAdjustments$drate_nsw /
  deathrateDiv

hivAdjustments$drate_nsw_lower <- hivBaseRates$deathrate_lower 
hivAdjustments$drate_nsw_lower[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "nsw")$lower
hivAdjustments$drate_nsw_lower <- hivAdjustments$drate_nsw_lower /
  deathrateDiv_lower

hivAdjustments$drate_nsw_upper <- hivBaseRates$deathrate_upper
hivAdjustments$drate_nsw_upper[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "nsw")$upper
hivAdjustments$drate_nsw_upper <- hivAdjustments$drate_nsw_upper /
  deathrateDiv_upper

hivAdjustments$drate_vic <- hivBaseRates$deathrate
hivAdjustments$drate_vic[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "vic")$deathrate
hivAdjustments$drate_vic <- hivAdjustments$drate_vic /
  deathrateDiv

hivAdjustments$drate_vic_lower <- hivBaseRates$deathrate_lower
hivAdjustments$drate_vic_lower[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "vic")$lower
hivAdjustments$drate_vic_lower <- hivAdjustments$drate_vic_lower /
  deathrateDiv_lower

hivAdjustments$drate_vic_upper <- hivBaseRates$deathrate_upper 
hivAdjustments$drate_vic_upper[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "vic")$upper
hivAdjustments$drate_vic_upper <- hivAdjustments$drate_vic_upper /
  deathrateDiv_upper

hivAdjustments$drate_qld <- hivBaseRates$deathrate
hivAdjustments$drate_qld[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "qld")$deathrate
hivAdjustments$drate_qld <- hivAdjustments$drate_qld /
  deathrateDiv

hivAdjustments$drate_qld_lower <- hivBaseRates$deathrate_lower 
hivAdjustments$drate_qld_lower[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "qld")$lower
hivAdjustments$drate_qld <- hivAdjustments$drate_qld_lower /
  deathrateDiv_lower

hivAdjustments$drate_qld_upper <- hivBaseRates$deathrate_upper 
hivAdjustments$drate_qld_upper[(indexLinkage+1):length(deathRate)] <-
  filter(ahodDeaths, state == "qld")$upper
hivAdjustments$drate_qld <- hivAdjustments$drate_qld_upper /
  deathrateDiv_upper


```

```{r Interstate migration rates}
# This chunk calculats interstate migration rates. At this stage just 
# calculate the best fit. Don't worry about upper and lower bounds.

# First estimate erp for each state
states <- c("nsw", "vic", "qld", "nt", "wa", "sa", "tas", "act", "all")

stateErp <- data.frame(year = allYears)

for (region in states) {
  lmErp <- lm(erp ~ year, data = filter(absMigration, state == region))
  erpState <- predict(lmErp, data.frame(year = allYears))
  
  # Store extrapolated population
  stateErp[[region]] <- erpState
}

hivInterstate <- gather(stateErp, "state", "erp", 2:10)

# Calculate interstate ERP simply overall population minus state
# population
allErp <- filter(hivInterstate, state == "all")$erp

hivInterstate <- hivInterstate %>% 
  group_by(state) %>%
  mutate(intererp = allErp - erp)

# Calculate departure rate
hivInterstate$departures <- NA

for (region in states) {
  lmDepart <- lm(departures ~ year, data = filter(absInterstate, 
    state == region))
  departState <- predict(lmDepart, data.frame(year = allYears))
  
  # Store extrapolated population
  hivInterstate[hivInterstate$state == region, ]$departures <- departState
}

hivInterstate <- mutate(hivInterstate, departrate = departures / erp) 

# Calculate arrival rate
hivInterstate$arrivals <- NA

for (region in states) {
  lmArrive <- lm(arrivals ~ year, data = filter(absInterstate, 
    state == region))
  arriveState <- predict(lmArrive, data.frame(year = allYears))
  
  # Store extrapolated population
  hivInterstate[hivInterstate$state == region, ]$arrivals <- arriveState
}

hivInterstate <- mutate(hivInterstate, arriverate = arrivals / intererp) 

# As intererp is zero national set arriverate to departure rate for "all"
# Gives indication of rate people move interstate nationally
hivInterstate[hivInterstate$state == "all", ]$arriverate <- 
  hivInterstate[hivInterstate$state == "all", ]$departrate

# Add a net leaving rate relative to state ERP -- useful for separate 
# state calculations 
hivInterstate <- mutate(hivInterstate, 
  netrate = (departures - arrivals) / erp)

```

## Ageing calculations for deaths

```{r Annual diagnoses and known deaths by age}
# Organize diagnoses and known deaths into matrices
# Each row is an age group and each column is a year after 1980
# Age groups: <15, 15-19, 20-24, 25-29, 30-34, 35-39, 40-44, 45-49, 
# 50-54, 55-59, 60-64, 65-69, 70+ (13 age groups)

nyears <- analysisYear - 1980 + 1
nages <- 18

ageList <- c("a0_4", "a5_9","a10_14", "a15_19", "a20_24", "a25_29", 
             "a30_34", "a35_39", "a40_44", "a45_49", "a50_54", "a55_59", 
             "a60_64", "a65_69", "a70_74", "a75_79", "a80_84", "a85+")

yearList <- paste("y", as.character(1980:analysisYear), sep = "")

# Age and gender
hivSetGenderAge <- hivSet %>% 
  group_by(yeardiagnosis, sex, agebin) %>% 
  summarise(notifications = n()) %>% 
  ungroup() %>%
  spread(sex, notifications)
hivSetGenderAge[is.na(hivSetGenderAge)] <- 0
hivSetGenderAge <- hivSetGenderAge %>%
  mutate(other = female+transgender+unknown) %>%
  rename(year = yeardiagnosis) %>%
  select(year, agebin, male, other)
hivSetGenderAge[is.na(hivSetGenderAge)] <- 0

# Fill in missing years with zeros - have to do males and others and
# then rebind seperately 
hivSetMaleAge <- hivSetGenderAge %>%
  select(-other) %>% 
  spread(agebin, male)
hivSetMaleAge[is.na(hivSetMaleAge)] <- 0
hivSetMaleAge <- FillDataFrame(1980:analysisYear, hivSetMaleAge) %>%
  gather("agebin", "male", 2:20) %>%
  arrange(year)

hivSetOtherAge <- hivSetGenderAge %>%
  select(-male) %>% 
  spread(agebin, other)
hivSetOtherAge[is.na(hivSetOtherAge)] <- 0
hivSetOtherAge <- FillDataFrame(1980:analysisYear, hivSetOtherAge) %>%
  gather("agebin", "other", 2:20) %>%
  arrange(year)

hivGenderAgeCum <- hivSetMaleAge %>%
  mutate(other = hivSetOtherAge$other) %>%
  mutate(total = male + other) %>%
  group_by(agebin) %>%
  mutate(cummale = cumsum(male),
    cumother = cumsum(other),
    cumtotal = cumsum(total)) %>%
  ungroup() %>%
  group_by(year, agebin) %>% 
  mutate(propmale = cummale / cumtotal) %>%
  mutate(propmale = ifelse(is.nan(propmale), 1, propmale)) 

# Convert aged diags into matrices - overall, male and female. 
ageDiag <- hivGenderAgeCum %>%
  select(year, agebin, total) %>%
  spread(year, total)
ageDiag <- as.matrix(ageDiag[, 2:ncol(ageDiag)])
rownames(ageDiag) <- c(ageList, "not_reported")
colnames(ageDiag) <- yearList  

ageDeath <- matrix(0, nages, nyears)
rownames(ageDeath) <- ageList
colnames(ageDeath) <- yearList

# By sex
ageDiagMale <- hivGenderAgeCum %>%
  select(year, agebin, male) %>%
  spread(year, male)
ageDiagMale <- as.matrix(ageDiagMale[, 2:ncol(ageDiagMale)])
rownames(ageDiagMale) <- c(ageList, "not_reported")
colnames(ageDiagMale) <- yearList

ageDeathMale <- matrix(0, nages, nyears)
rownames(ageDeathMale) <- ageList
colnames(ageDeathMale) <- yearList

ageDiagFemale <- hivGenderAgeCum %>%
  select(year, agebin, other) %>%
  spread(year, other)
ageDiagFemale <- as.matrix(ageDiagFemale[, 2:ncol(ageDiagFemale)])
rownames(ageDiagFemale) <- c(ageList, "not_reported")
colnames(ageDiagFemale) <- yearList

ageDeathFemale <- matrix(0, nages, nyears)
rownames(ageDeathFemale) <- ageList
colnames(ageDeathFemale) <- yearList

# Reallocate unknown age via sample - should be a very small number.
for (ii in 1:nyears) {
  # Get aged diagnoses for this year
  yearDiags <- ageDiag[, ii]
  yearDiagsMale <- ageDiagMale[, ii]
  yearDiagsFemale <- ageDiagFemale[, ii]
  
  if (tail(yearDiags, 1) > 0) {
    probVec <- head(yearDiags, -1) / sum(head(yearDiags, -1))
    
    reallocate <- sample(nages, tail(yearDiags, 1),
      replace = TRUE, prob = probVec)
    
    yearDiags[sort(unique(reallocate))] <- 
      yearDiags[sort(unique(reallocate))] +
      as.vector(table(reallocate))
  }
  
  if (tail(yearDiagsMale, 1) > 0) {
    probVecMale <- head(yearDiagsMale, -1) / sum(head(yearDiagsMale, -1))
    
    reallocateMale <- sample(nages, tail(yearDiagsMale, 1),
      replace = TRUE, prob = probVecMale)
    
    yearDiagsMale[sort(unique(reallocateMale))] <- 
      yearDiagsMale[sort(unique(reallocateMale))] +
      as.vector(table(reallocateMale))
  }
  
  if (tail(yearDiagsFemale, 1) > 0) {
    probVecFemale <- head(yearDiagsFemale, -1) / 
      sum(head(yearDiagsFemale, -1))
    
    reallocateFemale <- sample(nages, tail(yearDiagsFemale, 1),
      replace = TRUE, prob = probVecFemale)
    
    yearDiagsFemale[sort(unique(reallocateFemale))] <- 
      yearDiagsFemale[sort(unique(reallocateFemale))] +
      as.vector(table(reallocateFemale))
  }
  
  # Tidy up age bins and add to the agediag matix
  yearDiags <- head(yearDiags, -1)
  yearDiagsMale <- head(yearDiagsMale, -1)
  yearDiagsFemale <- head(yearDiagsFemale, -1)
  
  # Adjust age bins to remove duplicates normalizing to the number
  # of unique cases 
  if (sum(yearDiags) != 0) {
    ageDiag[1:nages, ii] <- yearDiags * 
      hivBaseRates$cumunique_all[ii]
  } else {
    ageDiag[1:nages, ii] <- 0
  }
  
  if (sum(yearDiagsMale) != 0) {
    ageDiagMale[1:nages, ii] <- yearDiagsMale * 
      hivBaseRates$cumunique_male[ii]
  } else {
    ageDiagMale[1:nages, ii] <- 0
  }
  
  if (sum(yearDiagsFemale) != 0) {
    ageDiagFemale[1:nages, ii] <- yearDiagsFemale * 
      hivBaseRates$cumunique_female[ii]
  } else {
    ageDiagFemale[1:nages, ii] <- 0
  } 
  
  # Extract known deaths in this year and age at death
  year <- 1980 + ii - 1
  
  yearDeaths <- hivSet %>% 
    filter(yeardeath == year) %>%
    mutate(agedeath = agehiv + (yeardeath - yeardiagnosis)) %>%
    select(agedeath)
  
  # Now put people in the right age bin -  assume all deaths are complete 
  # so we don't have to reallocate NAs
  ageDeath[, ii] <- table(AgeCat(yearDeaths$agedeath, lower = 0, 
    upper = 85, by = 5))
  
  # Deaths by gender
  yearDeathsMale <- hivSet %>% 
    filter(yeardeath == year, sex == "male") %>%
    mutate(agedeath = agehiv + (yeardeath - yeardiagnosis)) %>%
    select(agedeath)

  deathbinsMale <- table(AgeCat(yearDeathsMale$agedeath, lower = 0, 
    upper = 85, by = 5))
  
  ageDeathMale[, ii] <- deathbinsMale
  
  yearDeathsFemale <- hivSet %>% 
    filter(yeardeath == year, sex != "male") %>%
    mutate(agedeath = agehiv + (yeardeath - yeardiagnosis)) %>%
    select(agedeath)

  deathbinsFemale <- table(AgeCat(yearDeathsFemale$agedeath, lower = 0, 
    upper = 85, by = 5))
  
  ageDeathFemale[, ii] <- deathbinsFemale
  
}

ageDiag <- ageDiag[1:nages, ]
ageDiagMale <- ageDiagMale[1:nages, ]
ageDiagFemale <- ageDiagFemale[1:nages, ]
```

```{r Calculate deaths by age} 
# Calculate the number of PLDHIV and the overall number in each age group

# Load deathrates data from ABS for 2014 - as we distribute unknown deaths
# to age groups based on the ABS death rates for each group
absDeathRates <- read.csv(file.path(dataFolder,
  "ABS_Deathrate_Age_State_clean-2014.csv"), as.is = c(1,2))

# Use male deathrates for overall
absDeathRatesAll <- filter(absDeathRates, gender == "males", 
                           state == "all") %>% tbl_df()
absDeathRatesMale <- filter(absDeathRates, gender == "males",
                            state == "all") %>% tbl_df()
absDeathRatesFemale <- filter(absDeathRates, gender == "females",
                              state == "all") %>% tbl_df()

yearsVec <- 1980:analysisYear

# Create an aging rate vector 
ageRate <- c(rep(0.2, nages - 1), 0)

# Initialize results matrix
agePldhiv <- matrix(0, nages, nyears)
rownames(agePldhiv) <- ageList
colnames(agePldhiv) <- yearList

agePldhivMale <- agePldhiv
agePldhivFemale <- agePldhiv

ageMortality <- matrix(0, nages, nyears)
rownames(ageMortality) <- ageList
colnames(ageMortality) <- yearList

ageMortalityMale <- ageMortality
ageMortalityFemale <- ageMortality

# Add first years diagnoses
agePldhiv[, 1] <- ageDiag[, 1]
agePldhivMale[, 1] <- ageDiagMale[, 1]
agePldhivFemale[, 1] <- ageDiagFemale[, 1]

# Loop through each year and age and tally up number of PLDHIV in each 
# age group

# Overall ----------------------------------------------------------------
for (ii in 2:nyears) {
  
  # Extract abs death rates for this year
  if (yearsVec[ii - 1] <= 2005) {
    absDeaths <- filter(absDeathRatesAll, year == 2004)$deathrate
    absDeathsMale <- filter(absDeathRatesMale, year == 2004)$deathrate
    absDeathsFemale <- filter(absDeathRatesFemale, year == 2004)$deathrate
  } else if (yearsVec[ii - 1] >= 2015) {
    absDeaths <- filter(absDeathRatesAll, year == 2014)$deathrate
    absDeathsMale <- filter(absDeathRatesMale, year == 2014)$deathrate
    absDeathsFemale <- filter(absDeathRatesFemale, year == 2014)$deathrate
  } else {
    absDeaths <- filter(absDeathRatesAll, 
                        year == yearsVec[ii - 1])$deathrate
    absDeathsMale <- filter(absDeathRatesMale, 
                          year == yearsVec[ii - 1])$deathrate
    absDeathsFemale <- filter(absDeathRatesFemale, 
                          year == yearsVec[ii - 1])$deathrate
  }
  
  # Adjust numbers per 1000 to rate and remove deaths for those aged 0
  absDeaths <- absDeaths / 1000
  absDeaths <- absDeaths[3:length(absDeaths)]
  absDeathsMale <- absDeathsMale / 1000
  absDeathsMale <- absDeathsMale[3:length(absDeathsMale)]
  absDeathsFemale <- absDeathsFemale / 1000
  absDeathsFemale <- absDeathsFemale[3:length(absDeathsFemale)]
  
  # Use ABS deathrate to estimate expected deaths in each age group
  deathsABSrate <- absDeaths * agePldhiv[, ii - 1]
  deathsABSrateMale <- absDeathsMale * agePldhivMale[, ii - 1]
  deathsABSrateFemale <- absDeathsFemale * agePldhivFemale[, ii - 1]
  
  # Determine the difference in deaths between the estimate using the 
  # overall deathrate and the known deaths from notifications - if there
  # are negative numbers it is okay because we will end
  # up adding people instead of removing them below to ensure total deaths
  # are consistant with the overall estimate of deaths. (TODO): This does 
  # raise questions about using AHOD rates if there are less deaths than
  # recorded! 
  #
  # Calculate adjustment factor so deaths across age groups matchs
  # unknown deaths - can be negative if unknownDeaths is negative equates
  # to adding people rather than removing them. This keeps things 
  # consistent with estimated total deaths.
  unknownTest <- sum(agePldhiv[, ii-1]) * hivBaseRates$deathrate[ii-1] -
    sum(ageDeath[, ii-1])
  unknownTestMale <- sum(agePldhivMale[, ii-1]) * 
    hivBaseRates$deathrate[ii-1] * hivAdjustments$drate_male[ii-1] -
    sum(ageDeathMale[, ii-1])
  unknownTestFemale <- sum(agePldhivFemale[, ii-1]) * 
    hivBaseRates$deathrate[ii-1] * hivAdjustments$drate_female[ii-1] -
    sum(ageDeathFemale[, ii-1])
  
  if (sum(deathsABSrate) !=0) {
    adjustFactor <- unknownTest / sum(deathsABSrate)
    unknownAgeDeaths <- adjustFactor * deathsABSrate
  } else {
    unknownAgeDeaths <- rep(0, nages)
  }
  
  if (sum(deathsABSrateMale) !=0) {
    adjustFactorMale <- unknownTestMale / sum(deathsABSrateMale)
    unknownAgeDeathsMale <- adjustFactorMale * deathsABSrateMale
  } else {
    unknownAgeDeathsMale <- rep(0, nages)
  }
  
  if (sum(deathsABSrateFemale) !=0) {
    adjustFactorFemale <- unknownTestFemale / sum(deathsABSrateFemale)
    unknownAgeDeathsFemale <- adjustFactorFemale * deathsABSrateFemale
  } else {
    unknownAgeDeathsFemale <- rep(0, nages)
  }
  
  for (jj in 1:nages) {
    
    # Calculate number of people moving up in age
    if (jj == 1) {
      # If in first age group no-one ages from younger group
      ageUp <- 0
      ageUpMale <- 0
      ageUpFemale <- 0
    } else {
      ageUp <- agePldhiv[jj - 1, ii - 1] * ageRate[jj-1]
      ageUpMale <- agePldhivMale[jj - 1, ii - 1] * ageRate[jj-1]
      ageUpFemale <- agePldhivFemale[jj - 1, ii - 1] * ageRate[jj-1]
    }
    
    # Update current age group for current year - assuming same 
    # overseas migration rate for each age group equal to overall 
    # migration rate
    agePldhiv[jj, ii] <- agePldhiv[jj, ii - 1] + 
      hivBaseRates$annunique_all[ii] * ageDiag[jj, ii] - 
      (1-hivBaseRates$propstay[ii-1]) * hivBaseRates$annunique_all[ii-1] *
        ageDiag[jj, ii-1] - 
      ageDeath[jj, ii - 1] - unknownAgeDeaths[jj] - 
      agePldhiv[jj, ii - 1] * hivBaseRates$migrationrate[ii-1] - 
      agePldhiv[jj, ii - 1] * ageRate[jj] + ageUp  
    
    ageMortality[jj, ii] <- ageDeath[jj, ii] + unknownAgeDeaths[jj]
    
    # For low numbers the previous calculation could give number less
    # than zero. In this case repalce with zero
    if (agePldhiv[jj, ii] < 0) {
      agePldhiv[jj, ii] <- 0
    }
    
    # By gender - Male
    agePldhivMale[jj, ii] <- agePldhivMale[jj, ii - 1] + 
      hivBaseRates$annunique_male[ii] * ageDiagMale[jj, ii] - 
      (1-hivBaseRates$propstay[ii-1]) * 
        hivBaseRates$annunique_male[ii-1] * ageDiagMale[jj, ii] - 
      ageDeathMale[jj, ii - 1] - unknownAgeDeathsMale[jj] - 
      agePldhivMale[jj, ii - 1] * hivBaseRates$migrationrate[ii-1] - 
      agePldhivMale[jj, ii - 1] * ageRate[jj] + ageUpMale 
    
    ageMortalityMale[jj, ii] <- ageDeathMale[jj, ii] +
      unknownAgeDeathsMale[jj]
    
    if (agePldhivMale[jj, ii] < 0) {
      agePldhivMale[jj, ii] <- 0
    }
    
    # By gender - Female
    agePldhivFemale[jj, ii] <- agePldhivFemale[jj, ii - 1] + 
      hivBaseRates$annunique_female[ii] * ageDiagFemale[jj, ii] - 
      (1-hivBaseRates$propstay[ii-1]) * 
        hivBaseRates$annunique_female[ii-1] * ageDiagFemale[jj, ii] - 
      ageDeathFemale[jj, ii - 1] - unknownAgeDeathsFemale[jj] - 
      agePldhivFemale[jj, ii - 1] * hivBaseRates$migrationrate[ii-1] - 
      agePldhivFemale[jj, ii - 1] * ageRate[jj] + ageUpFemale 
    
    ageMortalityFemale[jj, ii] <- ageDeathFemale[jj, ii] +
      unknownAgeDeathsFemale[jj]
    
    if (agePldhivFemale[jj, ii] < 0) {
      agePldhivFemale[jj, ii] <- 0
    }
    
  }
}

# Put everything in a big data frame and calculate mortlaity rates
agePldhivDf <- as.data.frame(agePldhiv) %>%
  mutate(age = ageList) %>%
  select(age, everything()) %>%
  gather(year, pldhiv, 2:(nyears + 1)) %>%
  mutate(year = as.numeric(sub("y", "", year))) %>%
  as_tibble() 

ageMortalityDf <- as.data.frame(ageMortality) %>%
  mutate(age = ageList) %>%
  select(age, everything()) %>%
  gather(year, deaths, 2:(nyears + 1)) %>%
  mutate(year = as.numeric(sub("y", "", year))) %>%
  as_tibble() 

ageDataAll <- agePldhivDf %>%
  mutate(population = "all") %>%
  select(year, age, population, pldhiv) %>%
  mutate(deaths = ageMortalityDf$deaths) %>%
  mutate(deathrate = ifelse(pldhiv == 0, 0, deaths / pldhiv)) %>%
  mutate(deathrate_all = rep(hivBaseRates$deathrate, each = nages)) %>% 
  mutate(reldeathrate = ifelse(deathrate_all == 0, 1, 
    deathrate / deathrate_all)) %>%
  as_tibble() 

# Males
agePldhivDfMale <- as.data.frame(agePldhivMale) %>%
  mutate(age = ageList) %>%
  select(age, everything()) %>%
  gather(year, pldhiv, 2:(nyears + 1)) %>%
  mutate(year = as.numeric(sub("y", "", year))) %>%
  as_tibble()

ageMortalityDfMale <- as.data.frame(ageMortalityMale) %>%
  mutate(age = ageList) %>%
  select(age, everything()) %>%
  gather(year, deaths, 2:(nyears + 1)) %>%
  mutate(year = as.numeric(sub("y", "", year))) %>%
  as_tibble() 

ageDataMale <- agePldhivDfMale %>%
  mutate(population = "male") %>%
  select(year, age, population, pldhiv) %>%
  mutate(deaths = ageMortalityDfMale$deaths) %>%
  mutate(deathrate = ifelse(pldhiv == 0, 0, deaths / pldhiv)) %>%
  mutate(deathrate_all = rep(hivAdjustments$drate_male * 
      hivBaseRates$deathrate, each = nages)) %>%
  mutate(reldeathrate = ifelse(deathrate_all == 0, 1, 
    deathrate / deathrate_all)) %>%
  as_tibble()

# Females
agePldhivDfFemale <- as.data.frame(agePldhivFemale) %>%
  mutate(age = ageList) %>%
  select(age, everything()) %>%
  gather(year, pldhiv, 2:(nyears + 1)) %>%
  mutate(year = as.numeric(sub("y", "", year))) %>%
  as_tibble()

ageMortalityDfFemale <- as.data.frame(ageMortalityFemale) %>%
  mutate(age = ageList) %>%
  select(age, everything()) %>%
  gather(year, deaths, 2:(nyears + 1)) %>%
  mutate(year = as.numeric(sub("y", "", year))) %>%
  as_tibble()

ageDataFemale <- agePldhivDfFemale %>%
  mutate(population = "female") %>%
  select(year, age, population, pldhiv) %>%
  mutate(deaths = ageMortalityDfFemale$deaths) %>%
  mutate(deathrate = ifelse(pldhiv == 0, 0, deaths / pldhiv)) %>%
  mutate(deathrate_all = rep(hivAdjustments$drate_female * 
      hivBaseRates$deathrate, each = nages)) %>%
  mutate(reldeathrate = ifelse(deathrate_all == 0, 1, 
    deathrate / deathrate_all)) %>%
  as_tibble()
  
# Put it all in one data frame
ageData <- bind_rows(ageDataAll, ageDataMale) %>%
  bind_rows(ageDataFemale)


```

## Save Output

```{r Save output files}
#hivBaseRates hivAdjustments hivInterstate
# Save base, adjustment, and interstate dataframes
if (saveEstimates) {
  # Base 
  saveBase <- file.path(dataFolder, 
    paste0("HIVbaseEstimates-", toString(analysisYear)))
  
  write.csv(hivBaseRates, file = paste0(saveBase, ".csv"), 
    row.names = FALSE)
  
  # Adjustments
  saveAdjust<- file.path(dataFolder, 
    paste0("HIVadjustments-", toString(analysisYear)))
  
  write.csv(hivAdjustments, file = paste0(saveAdjust, ".csv"), 
    row.names = FALSE)
  
  # Interstate
  saveInterstate <- file.path(dataFolder, 
    paste0("HIVinterstateEstimates-", toString(analysisYear)))
  
  write.csv(hivInterstate, file = paste0(saveInterstate, ".csv"), 
    row.names = FALSE)
  
  # Age data
  saveAge <- file.path(dataFolder, 
    paste0("HIVageEstimates-", toString(analysisYear)))
  
  write.csv(ageData, file = paste0(saveAge, ".csv"), 
    row.names = FALSE)
}


```
