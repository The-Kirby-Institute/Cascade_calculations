HIV Cascade Validation
======================

Richard T. Gray

This script reads in the HIV linkage data for treatment coverage and produces
a comparison plots against a population's cascade retention and treatment 
coverage. It is used to validate the cascade estimates and calibrate the 
migration adjustement factor for populations with PBS treatment data. 

```{r Setup}
# Open as a project (setting working directory to source and restarting R)

# Set up directories
basePath <- getwd()
cascadeFolder <- file.path(basePath, "output")

# Load standard libraries and options ----------------------------------
library("LeftysRpkg", quietly = TRUE)
LoadLibrary(tidyverse)
options(dplyr.summarise.inform = FALSE) 
LoadLibrary(readxl)
LoadLibrary(scales)

```

```{r User specified parameters}

linkageYear <- 2023
cascadeYear <- 2023

cascadeProject <- "ASR_2024"
cascadeName <- "all"
artpop <- "all"

startYear <- 2015
endYear <- 2020

linkagePop <- "all"

savePlots <- TRUE

```

```{r Read in data}

# Set-up data files

linkageDataFile <- file.path(cascadeFolder,
  paste0("HIV_Linkage_Broad_high_1-", linkageYear, ".csv"))

pldhivFile <- file.path(cascadeFolder, cascadeProject, 
  paste0(cascadeName, "-", cascadeYear), 
  paste0("HIVpldhivEstimates-", cascadeYear, ".csv"))

paramsFile <- file.path(cascadeFolder, cascadeProject, 
  paste0(cascadeName, "-", cascadeYear), "PldhivParameters.csv")

artFile <- file.path(cascadeFolder,
  paste0("HIVtreatment-", cascadeYear, "-PBS-Ineligible.csv"))

# Read in files ----------------------------------------------------------------

linkageRaw <- read_csv(linkageDataFile)

pldhivRaw <- read_csv(pldhivFile)

artRaw <- read_csv(artFile)

params <- read_csv(paramsFile)

# Clean data ------------------------------------------------------------------

data <-  linkageRaw |>
  filter(population == linkagePop, year  %in% startYear:endYear) |>
  dplyr::select(year, retained, treated) 

pldhiv <- pldhivRaw |> 
  filter(year %in% startYear:endYear, 
    stage %in% c("pldhiv", "retained")) |>
  dplyr::select(stage, year, value)

# Separate 12-month (lower) and 18-month window (treatment estimate) data
art12 <- artRaw |> 
  filter(year %in% startYear:endYear, population == artpop, stage == "numART") |>
  dplyr::select(year, value = lower)

art18 <- artRaw |> 
  filter(year %in% startYear:endYear, population == artpop, stage == "numART") |>
  dplyr::select(year, value)

```

```{r Calculate cascade percentages}

diagnosed <- pldhiv |> filter(stage == "pldhiv") |> pull(value)
retained <- pldhiv |> filter(stage == "retained") |> pull(value)
treated12 <- art12$value
treated18 <- art18$value

cascadeGaps <- tibble(year = startYear:endYear, 
  retained_estimate = retained / diagnosed, 
  art_estimate12 = treated12 / diagnosed,
  art_estimate18 = treated18 / diagnosed) |>
  left_join(data, by = "year") |> # merge in data
  pivot_longer(2:6) 

```

```{r Plot data and results}

cascadeRetained <- cascadeGaps |>
  filter(str_detect(name, "retained"))
cascadeTreat <- cascadeGaps |>
  filter(name %in% c("treated", "art_estimate12", "art_estimate18"))

retainedPlot <- ggplot(data = cascadeRetained,
  aes(x = year, y = value, colour = name)) +
  geom_line() +
  scale_y_continuous(labels = percent) +
  scale_colour_manual(name = "",
    values = c("blue", "red"),
    breaks = c("retained_all", "retained_estimate"),
    labels = c("Linkage retained percentage", "Cascade estimates")) + 
  geom_pointrange(aes(x = 2013, y = 0.95, ymin = 0.914, ymax = 0.988), colour = "black") + 
  geom_pointrange(aes(x = 2019, y = 0.9624, ymin = 0.93, ymax = 0.99), colour = "black") + 
  expand_limits(y = c(0.9, 1)) +
  xlab("Year") + ylab("Percent retained") +  
  PlotOptions()

retainedPlot

treatedPlot <- ggplot(data = cascadeTreat,
  aes(x = year, y = value, colour = name)) +
  geom_line() +
  scale_y_continuous(labels = percent) +
  scale_colour_manual(name = "",
    values = c("blue", "red", "black"),
    breaks = c("treated", "art_estimate12", "art_estimate18"),
    limits = c("treated", "art_estimate12", "art_estimate18"),
    labels = c("Linkage ART percentage", "ART 12-month window", 
      "ART 18-month window")) +
  expand_limits(y = c(0.8, 1)) +
  xlab("Year") + ylab("Percent on ART") +
  PlotOptions() +
  geom_text(x = 2015, y = 0.975, color = "black",
    label = paste0("Migration multiplier = ", params$adjustment),
    hjust = 0, size = 4)

treatedPlot

```

```{r Save plots}

# Saved plots are in the cascade folder. Only plot the broad definition
# as that is the main comparison we are after

if (savePlots) {
  
  figureFolder <- file.path(cascadeFolder, cascadeProject, 
    paste0(cascadeName, "-", cascadeYear))
  
  SaveFigure(figureFolder, 
    paste0("Linkage_Retained_Comparison-", linkageYear, "-Data"), 
    retainedPlot)
  
  SaveFigure(figureFolder, 
    paste0("Linkage_ART_Comparison-", linkageYear, "-Data"),
    treatedPlot, width = 20)
  
}

```

```{r Extra plots}

tempDiag <- pldhivRaw |> filter(stage == "pldhiv", year >= 2015) |> pull(value)

tempART <- artRaw |> filter(year >= 2015, population == "all", stage == "numART") |> pull(value)

tempART12 <- artRaw |> filter(year >= 2015, population == "all", stage == "numART") |> pull(lower)

artProp <- tibble(year = startYear:2023, 
  prop12 = tempART12/tempDiag, 
  prop18 = tempART/tempDiag) |>
  pivot_longer(2:3)

ggplot(data = artProp, aes(x = year, y = value, colour = name)) +
  geom_line() +
  expand_limits(y = c(0.8, 1)) +
  scale_colour_manual(name = "",
    values = c("blue", "red"),
    breaks = c("prop12", "prop18"),
    labels = c("12-month window", "18-month window")) + 
  xlab("Year") + ylab("Percent on ART") +
  PlotOptions()

cascade <- tibble(year = startYear:2023, 
  diag = tempDiag,
  art12 = tempART12, 
  art18 = tempART) |>
  pivot_longer(2:4)

ggplot(data = cascade, aes(x = year, y = value, colour = name)) +
  geom_line() +
  # expand_limits(y = c(0.8, 1)) +
  scale_colour_manual(name = "",
    values = c("blue", "red", "black"),
    breaks = c("diag", "art12", "art18"),
    labels = c("Diagnosed", "ART 12-month window", "ART 18-month window")) + 
  xlab("Year") + ylab("Number") +
  PlotOptions()

```
